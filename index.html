<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–®–∏–Ω—Ç–æ—Ä–≥ ‚Ä¢ –û—Ñ–ª–∞–π–Ω CRM</title>
    
    <!-- Bootstrap 5 + Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <!-- Leaflet –¥–ª—è –∫–∞—Ä—Ç -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #0a3a4a;
            font-family: 'Inter', 'Segoe UI', Roboto, sans-serif;
        }
        
        .mobile-container {
            max-width: 450px;
            width: 100%;
            background: #f8fcff;
            min-height: 100vh;
            box-shadow: 0 25px 50px -10px rgba(0,0,0,0.4);
            margin: 0 auto;
            position: relative;
        }
        
        .admin-wrapper {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            background: #f8fcff;
            min-height: 100vh;
        }
        
        .app-header {
            background: linear-gradient(135deg, #0f5e7e, #0a405a);
            color: white;
            padding: 20px 18px;
            border-bottom-left-radius: 30px;
            border-bottom-right-radius: 30px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .mobile-card {
            background: white;
            border-radius: 24px;
            padding: 18px;
            margin: 12px 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.03);
            border: 1px solid rgba(255,255,255,0.8);
        }
        
        .admin-card {
            background: white;
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.05);
            height: 100%;
            border: 1px solid #e9ecef;
        }
        
        .mobile-btn {
            border-radius: 60px !important;
            padding: 14px 20px !important;
            font-weight: 700 !important;
            border: none !important;
            box-shadow: 0 6px 0 rgba(0,0,0,0.08) !important;
            transition: 0.08s !important;
            width: 100%;
        }
        
        .mobile-btn:active {
            transform: translateY(6px) !important;
            box-shadow: 0 2px 0 rgba(0,0,0,0.08) !important;
        }
        
        .timer-big {
            font-size: 52px;
            font-weight: 900;
            font-family: 'Courier New', monospace;
            text-align: center;
            color: #0f5e7e;
            background: #e8f4fa;
            padding: 16px;
            border-radius: 30px;
            letter-spacing: 6px;
        }
        
        .geo-active {
            background: #d4f0d4;
            color: #1e6b3b;
            padding: 10px 16px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .geo-inactive {
            background: #ffe6e6;
            color: #b34141;
            padding: 10px 16px;
            border-radius: 50px;
        }
        
        .mobile-tabs {
            display: flex;
            background: white;
            border-radius: 50px;
            padding: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            overflow-x: auto;
        }
        
        .mobile-tab {
            flex: 1;
            text-align: center;
            padding: 12px 16px;
            border-radius: 50px;
            font-weight: 700;
            font-size: 14px;
            color: #5f7e8c;
            cursor: pointer;
            transition: 0.2s;
            white-space: nowrap;
        }
        
        .mobile-tab.active {
            background: #0f5e7e;
            color: white;
        }
        
        .status-working {
            background: #d4f0d4;
            color: #1e6b3b;
            padding: 6px 14px;
            border-radius: 50px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .status-intercity {
            background: #ffeab6;
            color: #8e6200;
            padding: 6px 14px;
            border-radius: 50px;
        }
        
        .status-offline {
            background: #ecf0f3;
            color: #5d6f7e;
            padding: 6px 14px;
            border-radius: 50px;
        }
        
        .message-bubble {
            background: #e3f2fd;
            border-radius: 24px 24px 24px 8px;
            padding: 16px;
            margin: 12px 16px;
            border-left: 8px solid #0f5e7e;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .driver-stat-item {
            background: white;
            border-radius: 18px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 6px solid #0f5e7e;
            box-shadow: 0 2px 8px rgba(0,0,0,0.02);
        }
        
        .trip-row {
            background: white;
            border-radius: 16px;
            padding: 14px;
            margin-bottom: 8px;
            border: 1px solid #ecf3f7;
            transition: 0.2s;
        }
        
        .trip-row:hover {
            background: #f8fcff;
            border-color: #0f5e7e;
        }
        
        .summary-card {
            background: linear-gradient(145deg, #f6fafe, #e9f2f8);
            border-radius: 20px;
            padding: 20px;
            margin: 16px 0;
            border: 2px solid rgba(15,94,126,0.1);
        }
        
        .archive-card {
            background: linear-gradient(145deg, #fcf8e7, #fef9e9);
            border-radius: 20px;
            padding: 18px;
            margin-bottom: 16px;
            border-left: 8px solid #ffae42;
            box-shadow: 0 6px 15px rgba(255,174,66,0.1);
        }
        
        .offline-badge {
            background: #ff9800;
            color: white;
            padding: 4px 12px;
            border-radius: 50px;
            font-size: 11px;
            font-weight: 700;
        }
        
        .sync-badge {
            background: #4caf50;
            color: white;
            padding: 4px 12px;
            border-radius: 50px;
            font-size: 11px;
            font-weight: 700;
        }
        
        .hidden {
            display: none !important;
        }
        
        .table-responsive-custom {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .admin-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .admin-table th {
            background: #0f5e7e;
            color: white;
            padding: 14px 12px;
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
        }
        
        .admin-table td {
            padding: 14px 12px;
            border-bottom: 1px solid #e9ecef;
            vertical-align: middle;
        }
        
        .admin-table tbody tr:hover {
            background: #f8f9fa;
        }
        
        .stat-card {
            background: white;
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
            border: 1px solid #e9ecef;
            text-align: center;
            transition: 0.2s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 42px;
            font-weight: 900;
            color: #0f5e7e;
            line-height: 1.2;
        }
        
        @media (max-width: 768px) {
            .admin-wrapper {
                padding: 10px;
            }
            .stat-value {
                font-size: 32px;
            }
        }
    </style>
</head>
<body>
    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã -->
    <div id="sync-indicator" style="position: fixed; top: 20px; right: 20px; z-index: 9999; display: none;">
        <span class="sync-badge"><i class="bi bi-cloud-check"></i> –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...</span>
    </div>
    <div id="offline-indicator" style="position: fixed; top: 20px; right: 20px; z-index: 9999; display: none;">
        <span class="offline-badge"><i class="bi bi-wifi-off"></i> –û—Ñ–ª–∞–π–Ω</span>
    </div>

    <!-- –≠–ö–†–ê–ù –ó–ê–ì–†–£–ó–ö–ò -->
    <div id="loading-screen" class="vh-100 d-flex flex-column justify-content-center align-items-center" style="background: linear-gradient(145deg, #0f5e7e, #0a405a);">
        <div class="spinner-border text-white mb-3" style="width: 4rem; height: 4rem;"></div>
        <h4 class="text-white">–®–∏–Ω—Ç–æ—Ä–≥ –°—É—Ä–≥—É—Ç</h4>
        <p class="text-white-50">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
    </div>

    <!-- –≠–ö–†–ê–ù –í–•–û–î–ê -->
    <div id="login-screen" class="hidden">
        <div class="mobile-container">
            <div class="app-header text-center">
                <h2><i class="bi bi-truck"></i> –®–ò–ù–¢–û–†–ì</h2>
                <p class="mb-0 opacity-75">–£—á–µ—Ç —Å–º–µ–Ω –∏ –∑–∞—Ä–∞–±–æ—Ç–∫–∞</p>
            </div>
            
            <div class="mobile-card mt-4">
                <div class="mobile-tabs mb-4" id="login-tabs">
                    <div class="mobile-tab active" onclick="switchLoginTab('driver')">
                        <i class="bi bi-person"></i> –í–æ–¥–∏—Ç–µ–ª—å
                    </div>
                    <div class="mobile-tab" onclick="switchLoginTab('admin')">
                        <i class="bi bi-shield-lock"></i> –ê–¥–º–∏–Ω
                    </div>
                </div>
                
                <!-- –í–û–î–ò–¢–ï–õ–¨ -->
                <div id="driver-login-panel">
                    <div class="mb-3">
                        <input type="text" class="form-control form-control-lg rounded-pill" id="driver-login" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω / –õ–æ–≥–∏–Ω">
                    </div>
                    <div class="mb-4">
                        <input type="password" class="form-control form-control-lg rounded-pill" id="driver-password" placeholder="–ü–∞—Ä–æ–ª—å">
                    </div>
                    <button class="btn btn-primary mobile-btn" onclick="loginDriver()">
                        <i class="bi bi-box-arrow-in-right"></i> –í–æ–π—Ç–∏
                    </button>
                    <div class="text-center mt-4">
                        <a href="#" onclick="showRegister()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
                    </div>
                </div>
                
                <!-- –ê–î–ú–ò–ù -->
                <div id="admin-login-panel" class="hidden">
                    <div class="mb-3">
                        <input type="text" class="form-control form-control-lg rounded-pill" id="admin-login" placeholder="–õ–æ–≥–∏–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞">
                    </div>
                    <div class="mb-4">
                        <input type="password" class="form-control form-control-lg rounded-pill" id="admin-password" placeholder="–ü–∞—Ä–æ–ª—å">
                    </div>
                    <button class="btn btn-primary mobile-btn" style="background: #8e44ad;" onclick="loginAdmin()">
                        <i class="bi bi-shield-lock"></i> –í–æ–π—Ç–∏
                    </button>
                </div>
            </div>
            
            <div class="mobile-card bg-light">
                <div class="row text-center">
                    <div class="col-6">
                        <i class="bi bi-building fs-2" style="color: #0f5e7e;"></i>
                        <h6>–ì–æ—Ä–æ–¥</h6>
                        <span class="badge bg-white text-dark p-2" id="rate-display">1400 ‚ÇΩ/—á</span>
                    </div>
                    <div class="col-6">
                        <i class="bi bi-tree fs-2" style="color: #b86d0e;"></i>
                        <h6>–ú–µ–∂–≥–æ—Ä–æ–¥</h6>
                        <span class="badge bg-white text-dark p-2">–°—Ç–∞–≤–∫–∞ –∑–∞ —Ä–µ–π—Å</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø -->
    <div id="register-screen" class="hidden">
        <div class="mobile-container">
            <div class="app-header">
                <button class="btn btn-sm btn-light position-absolute" style="left: 15px; top: 15px; border-radius: 50px;" onclick="backToLogin()">
                    <i class="bi bi-arrow-left"></i>
                </button>
                <h4 class="text-center">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h4>
            </div>
            <div class="mobile-card mt-4">
                <div class="mb-3">
                    <input type="text" class="form-control form-control-lg rounded-pill" id="reg-name" placeholder="–§–ò–û –ø–æ–ª–Ω–æ—Å—Ç—å—é">
                </div>
                <div class="mb-3">
                    <input type="text" class="form-control form-control-lg rounded-pill" id="reg-phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω (–ª–æ–≥–∏–Ω)">
                </div>
                <div class="mb-4">
                    <input type="password" class="form-control form-control-lg rounded-pill" id="reg-pass" placeholder="–ü–∞—Ä–æ–ª—å">
                </div>
                <button class="btn btn-success mobile-btn" onclick="registerDriver()">
                    <i class="bi bi-check-circle"></i> –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
                </button>
            </div>
        </div>
    </div>

    <!-- –ö–ê–ë–ò–ù–ï–¢ –í–û–î–ò–¢–ï–õ–Ø -->
    <div id="driver-cabinet" class="hidden">
        <div class="mobile-container">
            <div class="app-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0"><i class="bi bi-truck"></i> –®–ò–ù–¢–û–†–ì</h4>
                <span class="badge bg-white text-dark p-3 rounded-pill" id="driver-name-badge"></span>
            </div>
            
            <!-- –°–¢–ê–¢–ò–°–¢–ò–ö–ê -->
            <div class="mobile-card bg-white">
                <div class="row">
                    <div class="col-6">
                        <small class="text-secondary">–°–µ–≥–æ–¥–Ω—è</small>
                        <h3 class="text-success fw-bold" id="driver-today-earn">0 ‚ÇΩ</h3>
                        <small id="driver-today-hours">0 —á</small>
                    </div>
                    <div class="col-6">
                        <small class="text-secondary">–ó–∞ –º–µ—Å—è—Ü</small>
                        <h3 class="text-primary fw-bold" id="driver-month-earn">0 ‚ÇΩ</h3>
                        <small id="driver-total-earn">–≤—Å–µ–≥–æ: 0 ‚ÇΩ</small>
                    </div>
                </div>
            </div>
            
            <!-- –°–û–û–ë–©–ï–ù–ò–Ø -->
            <div id="driver-messages-container"></div>
            
            <!-- –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –†–ï–ñ–ò–ú–û–í -->
            <div class="d-flex gap-2 mx-3 my-3">
                <button class="btn btn-primary flex-fill rounded-pill" onclick="switchDriverMode('city')">
                    <i class="bi bi-building"></i> –ì–æ—Ä–æ–¥
                </button>
                <button class="btn btn-outline-primary flex-fill rounded-pill" onclick="switchDriverMode('inter')">
                    <i class="bi bi-route"></i> –ú–µ–∂–≥–æ—Ä–æ–¥
                </button>
            </div>
            
            <!-- –ì–û–†–û–î -->
            <div id="driver-city-panel">
                <div class="mobile-card">
                    <div class="timer-big mb-3" id="timer-display">00:00:00</div>
                    
                    <button class="btn btn-success mobile-btn mb-2" id="shift-start-btn" onclick="startShift()">
                        <i class="bi bi-play-fill"></i> –ù–∞—á–∞—Ç—å —Å–º–µ–Ω—É
                    </button>
                    
                    <button class="btn btn-warning mobile-btn mb-2 hidden" id="shift-end-btn" onclick="endShift()">
                        <i class="bi bi-stop-fill"></i> –ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–º–µ–Ω—É
                    </button>
                    
                    <div class="mt-3">
                        <textarea class="form-control rounded-4" id="shift-comment" rows="2" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ —Å–º–µ–Ω–µ..."></textarea>
                    </div>
                    
                    <div class="mt-3 p-3 rounded-4 text-center" id="geo-status-block">
                        <span class="geo-inactive"><i class="bi bi-satellite"></i> –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞</span>
                    </div>
                </div>
            </div>
            
            <!-- –ú–ï–ñ–ì–û–†–û–î -->
            <div id="driver-inter-panel" class="hidden">
                <div class="mobile-card">
                    <div class="mb-3">
                        <input type="text" class="form-control form-control-lg rounded-pill" id="inter-direction" placeholder="–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ">
                    </div>
                    <div class="mb-3">
                        <input type="number" class="form-control form-control-lg rounded-pill" id="inter-sum" placeholder="–°—É–º–º–∞ —Å—Ç–∞–≤–∫–∏">
                    </div>
                    <div class="mb-3">
                        <textarea class="form-control rounded-4" id="inter-comment" rows="2" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ —Ä–µ–π—Å—É..."></textarea>
                    </div>
                    <button class="btn btn-warning mobile-btn" onclick="addIntercityTrip()">
                        <i class="bi bi-truck"></i> –ü–æ–µ—Ö–∞–ª!
                    </button>
                </div>
            </div>
            
            <!-- –ò–°–¢–û–†–ò–Ø -->
            <div class="mobile-card">
                <h5 class="mb-3"><i class="bi bi-clock-history"></i> –ú–æ–∏ –ø–æ–µ–∑–¥–∫–∏</h5>
                <div style="max-height: 350px; overflow-y: auto;">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>–î–∞—Ç–∞</th>
                                <th>–¢–∏–ø</th>
                                <th>–°—É–º–º–∞</th>
                            </tr>
                        </thead>
                        <tbody id="driver-trips-table"></tbody>
                    </table>
                </div>
            </div>
            
            <div class="text-center mb-4">
                <button class="btn btn-outline-secondary rounded-pill px-5" onclick="logout()">
                    <i class="bi bi-box-arrow-right"></i> –í—ã–π—Ç–∏
                </button>
            </div>
        </div>
    </div>

    <!-- –ö–ê–ë–ò–ù–ï–¢ –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê -->
    <div id="admin-cabinet" class="hidden">
        <div class="admin-wrapper">
            <!-- –®–ê–ü–ö–ê -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="text-white bg-primary p-3 rounded-4 mb-0">
                    <i class="bi bi-shield-lock"></i> –ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨
                </h2>
                <button class="btn btn-light rounded-pill px-5 py-3" onclick="logout()">
                    <i class="bi bi-box-arrow-right"></i> –í—ã–π—Ç–∏
                </button>
            </div>
            
            <!-- –°–¢–ê–¢–ò–°–¢–ò–ö–ê -->
            <div class="row g-4 mb-4">
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-value" id="admin-active-count">0</div>
                        <div class="text-secondary">–ê–∫—Ç–∏–≤–Ω—ã —Å–µ–π—á–∞—Å</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-value" id="admin-city-count">0</div>
                        <div class="text-secondary">–ù–∞ —Å–º–µ–Ω–µ (–≥–æ—Ä–æ–¥)</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-value" id="admin-inter-count">0</div>
                        <div class="text-secondary">–í –º–µ–∂–≥–æ—Ä–æ–¥–µ</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-value" id="admin-total-drivers">0</div>
                        <div class="text-secondary">–í—Å–µ–≥–æ –≤–æ–¥–∏—Ç–µ–ª–µ–π</div>
                    </div>
                </div>
            </div>
            
            <!-- –¢–ê–ë–´ -->
            <div class="mobile-tabs mb-4">
                <div class="mobile-tab active" onclick="switchAdminTab('drivers')">–ê–∫—Ç–∏–≤–Ω—ã–µ</div>
                <div class="mobile-tab" onclick="switchAdminTab('all-drivers')">–í—Å–µ –≤–æ–¥–∏—Ç–µ–ª–∏</div>
                <div class="mobile-tab" onclick="switchAdminTab('trips')">–ü–æ–µ–∑–¥–∫–∏</div>
                <div class="mobile-tab" onclick="switchAdminTab('reports')">–û—Ç—á–µ—Ç—ã</div>
                <div class="mobile-tab" onclick="switchAdminTab('archive')">–ê—Ä—Ö–∏–≤</div>
                <div class="mobile-tab" onclick="switchAdminTab('settings')">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
            </div>
            
            <!-- –ê–ö–¢–ò–í–ù–´–ï –í–û–î–ò–¢–ï–õ–ò -->
            <div id="admin-drivers-tab">
                <div class="admin-card">
                    <h5 class="mb-4"><i class="bi bi-people-fill"></i> –ê–∫—Ç–∏–≤–Ω—ã–µ –≤–æ–¥–∏—Ç–µ–ª–∏</h5>
                    <div class="table-responsive-custom">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>–í–æ–¥–∏—Ç–µ–ª—å</th>
                                    <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                                    <th>–°—Ç–∞—Ç—É—Å</th>
                                    <th>–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è</th>
                                    <th>–ö–∞—Ä—Ç–∞</th>
                                    <th>–ü–∞—Ä–æ–ª—å</th>
                                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody id="admin-drivers-table"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- –°–û–û–ë–©–ï–ù–ò–Ø -->
                <div class="admin-card mt-4">
                    <h5 class="mb-4"><i class="bi bi-chat-dots"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</h5>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <select class="form-select form-select-lg" id="message-driver-select">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤–æ–¥–∏—Ç–µ–ª—è</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <textarea class="form-control" id="message-text" rows="1" placeholder="–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è..."></textarea>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-primary w-100 h-100" onclick="sendMessageToDriver()">
                                <i class="bi bi-send"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                            </button>
                        </div>
                    </div>
                    
                    <hr class="my-4">
                    <h6><i class="bi bi-envelope-check"></i> –°—Ç–∞—Ç—É—Å —Å–æ–æ–±—â–µ–Ω–∏–π</h6>
                    <div id="message-status-container" style="max-height: 300px; overflow-y: auto;"></div>
                </div>
            </div>
            
            <!-- –í–°–ï –í–û–î–ò–¢–ï–õ–ò -->
            <div id="admin-all-drivers-tab" class="hidden">
                <div class="admin-card">
                    <h5 class="mb-4"><i class="bi bi-database"></i> –í—Å–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–æ–¥–∏—Ç–µ–ª–∏</h5>
                    <div class="table-responsive-custom">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>–í–æ–¥–∏—Ç–µ–ª—å</th>
                                    <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                                    <th>–ü–∞—Ä–æ–ª—å</th>
                                    <th>–°—Ç–∞—Ç—É—Å</th>
                                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody id="admin-all-drivers-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- –ü–û–ï–ó–î–ö–ò -->
            <div id="admin-trips-tab" class="hidden">
                <div class="admin-card">
                    <h5 class="mb-4"><i class="bi bi-pencil-square"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–µ–∑–¥–æ–∫</h5>
                    <div class="table-responsive-custom">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>–í–æ–¥–∏—Ç–µ–ª—å</th>
                                    <th>–î–∞—Ç–∞</th>
                                    <th>–¢–∏–ø</th>
                                    <th>–ß–∞—Å—ã</th>
                                    <th>–°—É–º–º–∞</th>
                                    <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="admin-trips-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- –û–¢–ß–ï–¢–´ -->
            <div id="admin-reports-tab" class="hidden">
                <div class="admin-card">
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <select class="form-select form-select-lg" id="report-month-select" onchange="loadAdminMonthReport()">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü</option>
                            </select>
                        </div>
                        <div class="col-md-8">
                            <div class="btn-group">
                                <button class="btn btn-outline-primary" onclick="switchAdminReportTab('daily')">
                                    <i class="bi bi-list-ul"></i> –ü–æ—Å–º–µ–Ω–Ω—ã–π
                                </button>
                                <button class="btn btn-outline-primary" onclick="switchAdminReportTab('summary')">
                                    <i class="bi bi-pie-chart"></i> –°–≤–æ–¥–Ω—ã–π
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="admin-daily-report-container">
                        <div class="d-flex justify-content-between mb-3">
                            <h5 class="fw-bold">–ü–æ–µ–∑–¥–∫–∏ –∑–∞ –º–µ—Å—è—Ü</h5>
                            <div>
                                <button class="btn btn-success me-2" onclick="exportDailyReportToExcel()">
                                    <i class="bi bi-file-earmark-excel"></i> Excel
                                </button>
                                <button class="btn btn-primary" onclick="printDailyReport()">
                                    <i class="bi bi-printer"></i> –ü–µ—á–∞—Ç—å
                                </button>
                            </div>
                        </div>
                        <div id="admin-daily-report-content" style="max-height: 500px; overflow-y: auto;"></div>
                    </div>
                    
                    <div id="admin-summary-report-container" class="hidden">
                        <div class="d-flex justify-content-between mb-3">
                            <h5 class="fw-bold">–°–≤–æ–¥–∫–∞ –ø–æ –≤–æ–¥–∏—Ç–µ–ª—è–º</h5>
                            <div>
                                <button class="btn btn-success me-2" onclick="exportSummaryReportToExcel()">
                                    <i class="bi bi-file-earmark-excel"></i> Excel
                                </button>
                                <button class="btn btn-primary" onclick="printSummaryReport()">
                                    <i class="bi bi-printer"></i> –ü–µ—á–∞—Ç—å
                                </button>
                            </div>
                        </div>
                        <div id="admin-summary-report-content" style="max-height: 500px; overflow-y: auto;"></div>
                        
                        <div class="summary-card mt-4">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="summary-item">
                                        <small>–ß–∞—Å–æ–≤ (–≥–æ—Ä–æ–¥)</small>
                                        <h4 class="text-primary" id="admin-total-hours">0 —á</h4>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="summary-item">
                                        <small>–ü–æ–µ–∑–¥–æ–∫ (–ú–ì)</small>
                                        <h4 class="text-warning" id="admin-total-inter">0</h4>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="summary-item bg-success bg-opacity-10">
                                        <small>–û–ë–©–ò–ô –ó–ê–†–ê–ë–û–¢–û–ö</small>
                                        <h3 class="text-success" id="admin-total-earn">0 ‚ÇΩ</h3>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <button class="btn btn-warning btn-lg w-100" onclick="closeMonth()">
                                <i class="bi bi-file-earmark-check"></i> –ó–ê–ö–†–´–¢–¨ –ú–ï–°–Ø–¶
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- –ê–†–•–ò–í -->
            <div id="admin-archive-tab" class="hidden">
                <div class="admin-card">
                    <div class="d-flex justify-content-between mb-4">
                        <h5><i class="bi bi-archive"></i> –ê—Ä—Ö–∏–≤ –∑–∞–∫—Ä—ã—Ç—ã—Ö –º–µ—Å—è—Ü–µ–≤</h5>
                        <button class="btn btn-outline-danger" onclick="clearAllArchives()">
                            <i class="bi bi-trash"></i> –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ
                        </button>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <select class="form-select" id="admin-archive-month-select" onchange="loadAdminArchiveMonth()">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="admin-archive-content" style="max-height: 600px; overflow-y: auto;"></div>
                </div>
            </div>
            
            <!-- –ù–ê–°–¢–†–û–ô–ö–ò -->
            <div id="admin-settings-tab" class="hidden">
                <div class="row">
                    <div class="col-md-6">
                        <div class="admin-card">
                            <h5 class="mb-4"><i class="bi bi-tag"></i> –¢–∞—Ä–∏—Ñ –ø–æ –≥–æ—Ä–æ–¥—É</h5>
                            <div class="input-group input-group-lg">
                                <input type="number" class="form-control" id="admin-rate-input" value="1400">
                                <span class="input-group-text">‚ÇΩ/—á</span>
                                <button class="btn btn-success" onclick="updateRate()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="admin-card">
                            <h5 class="mb-4"><i class="bi bi-key"></i> –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª–µ–π</h5>
                            <div class="mb-3">
                                <label>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="admin-new-pass" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å">
                                    <button class="btn btn-warning" onclick="changeAdminPassword()">–ò–∑–º–µ–Ω–∏—Ç—å</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-12 mt-4">
                        <div class="admin-card">
                            <h5 class="mb-4"><i class="bi bi-cloud-arrow-up"></i> –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <button class="btn btn-outline-primary btn-lg w-100" onclick="exportBackup()">
                                        <i class="bi bi-download"></i> –°–∫–∞—á–∞—Ç—å –±–µ–∫–∞–ø
                                    </button>
                                </div>
                                <div class="col-md-6">
                                    <input type="file" class="form-control mb-2" id="backup-file" accept=".json">
                                    <button class="btn btn-outline-warning btn-lg w-100" onclick="importBackup()">
                                        <i class="bi bi-upload"></i> –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –ö–ê–†–¢–´ -->
    <div id="map-modal" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); z-index: 99999; display: flex; flex-direction: column;">
        <div style="padding: 20px; background: #0f5e7e; color: white; display: flex; justify-content: space-between;">
            <h4 class="mb-0" id="map-driver-name"></h4>
            <button class="btn btn-light rounded-pill px-4" onclick="closeMap()">
                <i class="bi bi-x-lg"></i> –ó–∞–∫—Ä—ã—Ç—å
            </button>
        </div>
        <div id="driver-map" style="flex: 1; width: 100%;"></div>
    </div>

    <script>
        // ============ –ì–õ–û–ë–ê–õ–¨–ù–´–ï –î–ê–ù–ù–´–ï ============
        let LOCAL_DRIVERS = [];
        let LOCAL_TRIPS = [];
        let LOCAL_MESSAGES = [];
        let LOCAL_ARCHIVE = [];
        
        // –£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        let ADMIN_CRED = { login: 'admin', password: 'adminshintorg86' };
        
        // –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        let currentUser = null;
        let currentRole = null;
        let currentRate = 1400;
        
        // –°–º–µ–Ω–∞
        let shiftActive = false;
        let shiftStartTime = null;
        let shiftTimer = null;
        let geoWatchId = null;
        let currentMap = null;
        
        // –û—Ñ–ª–∞–π–Ω-–æ—á–µ—Ä–µ–¥—å
        let offlineQueue = [];
        
        // ============ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ============
        window.onload = function() {
            loadFromStorage();
            setupOfflineDetection();
            setupAutoSync();
            
            checkStoredSession();
            
            document.getElementById('loading-screen').classList.add('hidden');
            
            if (!currentUser && !currentRole) {
                document.getElementById('login-screen').classList.remove('hidden');
            }
            
            document.getElementById('rate-display').innerHTML = `${currentRate} ‚ÇΩ/—á`;
            updateMonthSelectors();
            updateArchiveSelectors();
        };
        
        // ============ –ü–†–û–í–ï–†–ö–ê –°–ï–°–°–ò–ò ============
        function checkStoredSession() {
            const savedUser = localStorage.getItem('shintorg_current_user');
            const savedRole = localStorage.getItem('shintorg_current_role');
            
            if (savedUser && savedRole) {
                try {
                    currentUser = JSON.parse(savedUser);
                    currentRole = savedRole;
                    
                    if (currentRole === 'driver') {
                        const driver = LOCAL_DRIVERS.find(d => d.phone === currentUser.phone);
                        if (driver && driver.status === 'active') {
                            shiftActive = true;
                            shiftStartTime = driver.shiftStartTime ? new Date(driver.shiftStartTime) : new Date();
                            
                            document.getElementById('shift-start-btn').classList.add('hidden');
                            document.getElementById('shift-end-btn').classList.remove('hidden');
                            
                            startTimer();
                            startGeolocation();
                        }
                        
                        document.getElementById('login-screen').classList.add('hidden');
                        document.getElementById('driver-cabinet').classList.remove('hidden');
                        document.getElementById('driver-name-badge').innerHTML = `<i class="bi bi-person-circle"></i> ${driver?.short || currentUser.name}`;
                        
                        loadDriverData();
                        checkDriverMessages();
                    }
                    else if (currentRole === 'admin') {
                        document.getElementById('login-screen').classList.add('hidden');
                        document.getElementById('admin-cabinet').classList.remove('hidden');
                        loadAdminData();
                    }
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏:', e);
                    clearStoredSession();
                }
            }
        }
        
        function saveSession() {
            if (currentUser && currentRole) {
                localStorage.setItem('shintorg_current_user', JSON.stringify(currentUser));
                localStorage.setItem('shintorg_current_role', currentRole);
            }
        }
        
        function clearStoredSession() {
            localStorage.removeItem('shintorg_current_user');
            localStorage.removeItem('shintorg_current_role');
        }
        
        // ============ LOCALSTORAGE ============
        function loadFromStorage() {
            try {
                const drivers = localStorage.getItem('shintorg_drivers');
                const trips = localStorage.getItem('shintorg_trips');
                const messages = localStorage.getItem('shintorg_messages');
                const archive = localStorage.getItem('shintorg_archive');
                const rate = localStorage.getItem('shintorg_rate');
                const queue = localStorage.getItem('shintorg_queue');
                
                if (drivers) LOCAL_DRIVERS = JSON.parse(drivers);
                if (trips) LOCAL_TRIPS = JSON.parse(trips);
                if (messages) LOCAL_MESSAGES = JSON.parse(messages);
                if (archive) LOCAL_ARCHIVE = JSON.parse(archive);
                if (rate) currentRate = parseFloat(rate);
                if (queue) offlineQueue = JSON.parse(queue);
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', e);
            }
        }
        
        function saveToStorage() {
            localStorage.setItem('shintorg_drivers', JSON.stringify(LOCAL_DRIVERS));
            localStorage.setItem('shintorg_trips', JSON.stringify(LOCAL_TRIPS));
            localStorage.setItem('shintorg_messages', JSON.stringify(LOCAL_MESSAGES));
            localStorage.setItem('shintorg_archive', JSON.stringify(LOCAL_ARCHIVE));
            localStorage.setItem('shintorg_rate', currentRate.toString());
            localStorage.setItem('shintorg_queue', JSON.stringify(offlineQueue));
        }
        
        // ============ –û–§–õ–ê–ô–ù ============
        function setupOfflineDetection() {
            window.addEventListener('online', function() {
                document.getElementById('offline-indicator').style.display = 'none';
                processOfflineQueue();
            });
            
            window.addEventListener('offline', function() {
                document.getElementById('offline-indicator').style.display = 'block';
            });
            
            if (!navigator.onLine) {
                document.getElementById('offline-indicator').style.display = 'block';
            }
        }
        
        function setupAutoSync() {
            setInterval(() => {
                if (navigator.onLine) {
                    processOfflineQueue();
                }
            }, 30000);
        }
        
        function processOfflineQueue() {
            if (!navigator.onLine || offlineQueue.length === 0) return;
            
            document.getElementById('sync-indicator').style.display = 'block';
            
            offlineQueue = [];
            saveToStorage();
            
            setTimeout(() => {
                document.getElementById('sync-indicator').style.display = 'none';
            }, 1000);
        }
        
        function addToOfflineQueue(action, data) {
            offlineQueue.push({
                action: action,
                data: data,
                timestamp: new Date().toISOString()
            });
            saveToStorage();
        }
        
        // ============ –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ============
        window.switchLoginTab = function(tab) {
            document.querySelectorAll('#login-tabs .mobile-tab').forEach(el => el.classList.remove('active'));
            document.querySelector(`#login-tabs .mobile-tab:nth-child(${tab === 'driver' ? 1 : 2})`).classList.add('active');
            
            document.getElementById('driver-login-panel').classList.toggle('hidden', tab !== 'driver');
            document.getElementById('admin-login-panel').classList.toggle('hidden', tab !== 'admin');
        };
        
        window.loginDriver = function() {
            const phone = document.getElementById('driver-login').value;
            const pass = document.getElementById('driver-password').value;
            
            const driver = LOCAL_DRIVERS.find(d => d.phone === phone && d.password === pass);
            
            if (driver) {
                currentUser = JSON.parse(JSON.stringify(driver));
                currentRole = 'driver';
                saveSession();
                
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('driver-cabinet').classList.remove('hidden');
                document.getElementById('driver-name-badge').innerHTML = `<i class="bi bi-person-circle"></i> ${driver.short || driver.name}`;
                
                if (driver.status === 'active' && driver.shiftType === 'city') {
                    shiftActive = true;
                    shiftStartTime = driver.shiftStartTime ? new Date(driver.shiftStartTime) : new Date();
                    
                    document.getElementById('shift-start-btn').classList.add('hidden');
                    document.getElementById('shift-end-btn').classList.remove('hidden');
                    
                    startTimer();
                    startGeolocation();
                }
                
                loadDriverData();
                checkDriverMessages();
                
                alert(`‚úÖ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${driver.short || driver.name}`);
            } else {
                alert('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å');
            }
        };
        
        window.loginAdmin = function() {
            const login = document.getElementById('admin-login').value;
            const pass = document.getElementById('admin-password').value;
            
            if (login === ADMIN_CRED.login && pass === ADMIN_CRED.password) {
                currentRole = 'admin';
                currentUser = { name: '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' };
                saveSession();
                
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('admin-cabinet').classList.remove('hidden');
                
                loadAdminData();
                alert('‚úÖ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä');
            } else {
                alert('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å');
            }
        };
        
        // ============ –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø ============
        window.registerDriver = function() {
            const name = document.getElementById('reg-name').value;
            const phone = document.getElementById('reg-phone').value;
            const pass = document.getElementById('reg-pass').value;
            
            if (!name || !phone || !pass) {
                alert('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }
            
            if (LOCAL_DRIVERS.find(d => d.phone === phone)) {
                alert('‚ùå –≠—Ç–æ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω');
                return;
            }
            
            const nameParts = name.split(' ');
            let short = nameParts[0];
            if (nameParts.length > 1) short += ' ' + nameParts[1][0] + '.';
            if (nameParts.length > 2) short += nameParts[2][0] + '.';
            
            const newDriver = {
                id: Date.now().toString(),
                name: name,
                short: short,
                phone: phone,
                password: pass,
                status: 'offline',
                shiftType: null,
                shiftStartTime: null,
                location: '',
                lat: null,
                lng: null,
                lastSeen: null,
                registeredAt: new Date().toISOString().split('T')[0]
            };
            
            LOCAL_DRIVERS.push(newDriver);
            saveToStorage();
            
            alert('‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ.');
            backToLogin();
        };
        
        // ============ –¢–ê–ô–ú–ï–† ============
        function startTimer() {
            if (shiftTimer) clearInterval(shiftTimer);
            shiftTimer = setInterval(() => {
                if (!shiftActive) return;
                const diff = Math.floor((new Date() - shiftStartTime) / 1000);
                const h = Math.floor(diff / 3600).toString().padStart(2, '0');
                const m = Math.floor((diff % 3600) / 60).toString().padStart(2, '0');
                const s = (diff % 60).toString().padStart(2, '0');
                document.getElementById('timer-display').innerText = `${h}:${m}:${s}`;
            }, 1000);
        }
        
        // ============ –ì–ï–û–õ–û–ö–ê–¶–ò–Ø ============
        function startGeolocation() {
            if (!currentUser || !navigator.geolocation) return;
            
            if (geoWatchId) navigator.geolocation.clearWatch(geoWatchId);
            
            geoWatchId = navigator.geolocation.watchPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    const driver = LOCAL_DRIVERS.find(d => d.phone === currentUser.phone);
                    if (driver) {
                        driver.lat = lat;
                        driver.lng = lng;
                        driver.location = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                        driver.lastSeen = new Date();
                        saveToStorage();
                    }
                    
                    document.getElementById('geo-status-block').innerHTML = `
                        <span class="geo-active">
                            <i class="bi bi-satellite"></i> üü¢ ${lat.toFixed(4)}, ${lng.toFixed(4)}
                        </span>
                    `;
                },
                (error) => {
                    document.getElementById('geo-status-block').innerHTML = `
                        <span class="geo-inactive"><i class="bi bi-satellite"></i> üî¥ –û—à–∏–±–∫–∞</span>
                    `;
                },
                {
                    enableHighAccuracy: true,
                    maximumAge: 5000,
                    timeout: 10000
                }
            );
        }
        
        // ============ –ö–ê–†–¢–ê ============
        window.showDriverMap = function(driverPhone, driverName) {
            const driver = LOCAL_DRIVERS.find(d => d.phone === driverPhone);
            if (!driver || !driver.lat || !driver.lng) {
                alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏');
                return;
            }
            
            document.getElementById('map-modal').classList.remove('hidden');
            document.getElementById('map-driver-name').innerHTML = `<i class="bi bi-geo-alt-fill"></i> ${driverName}`;
            
            setTimeout(() => {
                if (currentMap) currentMap.remove();
                
                currentMap = L.map('driver-map').setView([driver.lat, driver.lng], 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(currentMap);
                L.marker([driver.lat, driver.lng]).addTo(currentMap)
                    .bindPopup(`<b>${driver.short || driver.name}</b>`)
                    .openPopup();
            }, 100);
        };
        
        window.closeMap = function() {
            document.getElementById('map-modal').classList.add('hidden');
            if (currentMap) {
                currentMap.remove();
                currentMap = null;
            }
        };
        
        // ============ –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –°–ú–ï–ù–ê ============
        window.startShift = function() {
            if (!currentUser) return;
            
            shiftActive = true;
            shiftStartTime = new Date();
            
            const driver = LOCAL_DRIVERS.find(d => d.phone === currentUser.phone);
            if (driver) {
                driver.status = 'active';
                driver.shiftType = 'city';
                driver.shiftStartTime = shiftStartTime.toISOString();
                saveToStorage();
            }
            
            document.getElementById('shift-start-btn').classList.add('hidden');
            document.getElementById('shift-end-btn').classList.remove('hidden');
            
            startTimer();
            startGeolocation();
            
            addToOfflineQueue('start_shift', { phone: currentUser.phone, time: shiftStartTime });
            
            alert('üöï –°–º–µ–Ω–∞ –Ω–∞—á–∞—Ç–∞!');
        };
        
        // ============ –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ò–Ø –°–ú–ï–ù–´ ============
        window.endShift = function() {
            if (!shiftActive || !currentUser) return;
            
            // –í—ã—á–∏—Å–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–µ–∫—É–Ω–¥
            const shiftSeconds = Math.floor((new Date() - shiftStartTime) / 1000);
            
            // –ü–µ—Ä–µ–≤–æ–¥–∏–º –≤ —á–∞—Å—ã
            let shiftHours = shiftSeconds / 3600;
            let wholeHours = Math.floor(shiftHours);
            let minutesPart = (shiftHours - wholeHours) * 60;
            
            // –û–∫—Ä—É–≥–ª—è–µ–º –¥–æ 0.5 —á–∞—Å–∞ (–∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ)
            if (minutesPart < 15) {
                shiftHours = wholeHours;
            } else if (minutesPart < 45) {
                shiftHours = wholeHours + 0.5;
            } else {
                shiftHours = wholeHours + 1;
            }
            
            // –ú–∏–Ω–∏–º—É–º 1 —á–∞—Å
            if (shiftHours < 1) {
                shiftHours = 1;
            }
            
            // –†–∞—Å—á–µ—Ç –∑–∞—Ä–∞–±–æ—Ç–∫–∞
            const shiftEarn = Math.round(shiftHours * currentRate);
            const comment = document.getElementById('shift-comment').value || '';
            
            // –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –æ –ø–æ–µ–∑–¥–∫–µ
            const newTrip = {
                id: Date.now().toString(),
                driverId: currentUser.phone,
                driverName: currentUser.short || currentUser.name,
                date: new Date().toISOString().split('T')[0],
                type: '–≥–æ—Ä–æ–¥',
                hours: shiftHours,
                earn: shiftEarn,
                comment: comment,
                timestamp: new Date().toISOString()
            };
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º
            LOCAL_TRIPS.push(newTrip);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤–æ–¥–∏—Ç–µ–ª—è
            const driver = LOCAL_DRIVERS.find(d => d.phone === currentUser.phone);
            if (driver) {
                driver.status = 'offline';
                driver.shiftType = null;
                driver.shiftStartTime = null;
                saveToStorage();
            }
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é
            if (geoWatchId) {
                navigator.geolocation.clearWatch(geoWatchId);
                geoWatchId = null;
            }
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            shiftActive = false;
            clearInterval(shiftTimer);
            document.getElementById('timer-display').innerText = '00:00:00';
            document.getElementById('shift-start-btn').classList.remove('hidden');
            document.getElementById('shift-end-btn').classList.add('hidden');
            document.getElementById('shift-comment').value = '';
            document.getElementById('geo-status-block').innerHTML = '<span class="geo-inactive"><i class="bi bi-satellite"></i> –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞</span>';
            
            saveToStorage();
            
            addToOfflineQueue('end_shift', newTrip);
            
            alert(`‚úÖ –°–º–µ–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ: ${shiftEarn} ‚ÇΩ`);
            loadDriverData();
        };
        
        // ============ –ú–ï–ñ–ì–û–†–û–î ============
        window.addIntercityTrip = function() {
            if (!currentUser) return;
            
            const direction = document.getElementById('inter-direction').value || '–ú–µ–∂–≥–æ—Ä–æ–¥';
            const sum = parseFloat(document.getElementById('inter-sum').value);
            
            if (!sum || sum <= 0) {
                alert('‚ùå –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É —Å—Ç–∞–≤–∫–∏');
                return;
            }
            
            const comment = document.getElementById('inter-comment').value || '';
            
            const newTrip = {
                id: Date.now().toString(),
                driverId: currentUser.phone,
                driverName: currentUser.short || currentUser.name,
                date: new Date().toISOString().split('T')[0],
                type: '–º–µ–∂–≥–æ—Ä–æ–¥',
                direction: direction,
                earn: sum,
                comment: comment,
                timestamp: new Date().toISOString()
            };
            
            LOCAL_TRIPS.push(newTrip);
            saveToStorage();
            
            addToOfflineQueue('add_trip', newTrip);
            
            document.getElementById('inter-direction').value = '';
            document.getElementById('inter-sum').value = '';
            document.getElementById('inter-comment').value = '';
            
            alert(`üöõ –†–µ–π—Å –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω! ${sum} ‚ÇΩ`);
            loadDriverData();
        };
        
        // ============ –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• –í–û–î–ò–¢–ï–õ–Ø ============
        function loadDriverData() {
            if (!currentUser) return;
            
            const driverTrips = LOCAL_TRIPS.filter(t => t.driverId === currentUser.phone);
            const today = new Date().toISOString().split('T')[0];
            const month = today.slice(0, 7);
            
            const todayTrips = driverTrips.filter(t => t.date === today);
            const todayEarn = todayTrips.reduce((s, t) => s + (t.earn || 0), 0);
            const todayHours = todayTrips.filter(t => t.type === '–≥–æ—Ä–æ–¥').reduce((s, t) => s + (t.hours || 0), 0);
            
            const monthTrips = driverTrips.filter(t => t.date.startsWith(month));
            const monthEarn = monthTrips.reduce((s, t) => s + (t.earn || 0), 0);
            const totalEarn = driverTrips.reduce((s, t) => s + (t.earn || 0), 0);
            
            document.getElementById('driver-today-earn').innerHTML = `${todayEarn} ‚ÇΩ`;
            document.getElementById('driver-today-hours').innerHTML = `${todayHours.toFixed(1)} —á`;
            document.getElementById('driver-month-earn').innerHTML = `${monthEarn} ‚ÇΩ`;
            document.getElementById('driver-total-earn').innerHTML = `–≤—Å–µ–≥–æ: ${totalEarn} ‚ÇΩ`;
            
            let html = '';
            driverTrips.slice().reverse().forEach(trip => {
                html += `<tr>
                    <td>${trip.date}</td>
                    <td><span class="badge ${trip.type === '–≥–æ—Ä–æ–¥' ? 'bg-primary' : 'bg-warning'}">${trip.type}</span></td>
                    <td class="fw-bold">${trip.earn} ‚ÇΩ</td>
                </tr>`;
            });
            document.getElementById('driver-trips-table').innerHTML = html || '<tr><td colspan="3" class="text-center">–ù–µ—Ç –ø–æ–µ–∑–¥–æ–∫</td></tr>';
        }
        
        // ============ –°–û–û–ë–©–ï–ù–ò–Ø ============
        function checkDriverMessages() {
            if (!currentUser) return;
            
            const messages = LOCAL_MESSAGES.filter(m => m.driverPhone === currentUser.phone && !m.read);
            
            if (messages.length > 0) {
                let html = '';
                messages.forEach(msg => {
                    html += `<div class="message-bubble">
                        <div class="d-flex justify-content-between">
                            <strong><i class="bi bi-envelope-fill"></i> –°–æ–æ–±—â–µ–Ω–∏–µ</strong>
                            <small>${msg.time || ''}</small>
                        </div>
                        <p class="mb-2 mt-2">${msg.text}</p>
                        <button class="btn btn-sm btn-outline-primary rounded-pill px-4" onclick="markMessageRead('${msg.id}')">
                            <i class="bi bi-check2-all"></i> –ü—Ä–æ—á–∏—Ç–∞–Ω–æ
                        </button>
                    </div>`;
                });
                document.getElementById('driver-messages-container').innerHTML = html;
            } else {
                document.getElementById('driver-messages-container').innerHTML = '';
            }
        }
        
        window.markMessageRead = function(messageId) {
            const msg = LOCAL_MESSAGES.find(m => m.id === messageId);
            if (msg) {
                msg.read = true;
                msg.readAt = new Date().toISOString();
                saveToStorage();
                checkDriverMessages();
            }
            
            if (currentRole === 'admin') {
                loadMessageStatus();
            }
        };
        
        function loadMessageStatus() {
            let html = '';
            LOCAL_MESSAGES.slice().reverse().forEach(msg => {
                const driver = LOCAL_DRIVERS.find(d => d.phone === msg.driverPhone);
                const status = msg.read ? 
                    `<span class="badge bg-success">‚úÖ –ü—Ä–æ—á–∏—Ç–∞–Ω–æ</span>` : 
                    `<span class="badge bg-warning">‚è≥ –û–∂–∏–¥–∞–µ—Ç</span>`;
                
                html += `<div class="border-bottom pb-2 mb-2">
                    <div><strong>${driver?.short || msg.driverPhone}</strong> ${status}</div>
                    <div class="text-secondary">${msg.text}</div>
                    <small class="text-muted">${msg.time || ''}</small>
                </div>`;
            });
            document.getElementById('message-status-container').innerHTML = html || '<p class="text-center">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</p>';
        }
        
        window.sendMessageToDriver = function() {
            const driverPhone = document.getElementById('message-driver-select').value;
            const text = document.getElementById('message-text').value;
            
            if (!driverPhone || !text) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –≤–æ–¥–∏—Ç–µ–ª—è –∏ –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç');
                return;
            }
            
            const newMsg = {
                id: Date.now().toString(),
                driverPhone: driverPhone,
                text: text,
                time: new Date().toLocaleTimeString().slice(0,5),
                read: false,
                readAt: null,
                timestamp: new Date().toISOString()
            };
            
            LOCAL_MESSAGES.push(newMsg);
            saveToStorage();
            
            document.getElementById('message-text').value = '';
            alert('‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
            loadMessageStatus();
        };
        
        // ============ –ê–î–ú–ò–ù ============
        function loadAdminData() {
            loadAdminDrivers();
            loadAllDrivers();
            loadAdminTrips();
            loadAdminReports();
            loadArchiveList();
            loadMessageDriversList();
            loadMessageStatus();
            document.getElementById('admin-rate-input').value = currentRate;
            updateMonthSelectors();
            updateArchiveSelectors();
            document.getElementById('admin-total-drivers').innerHTML = LOCAL_DRIVERS.length;
        }
        
        function getActiveDriversThisMonth() {
            const month = new Date().toISOString().slice(0, 7);
            const activeDrivers = new Set();
            
            LOCAL_TRIPS.forEach(trip => {
                if (trip.date && trip.date.startsWith(month)) {
                    activeDrivers.add(trip.driverId);
                }
            });
            
            LOCAL_DRIVERS.forEach(driver => {
                if (driver.status === 'active') {
                    activeDrivers.add(driver.phone);
                }
            });
            
            return Array.from(activeDrivers);
        }
        
        function loadAdminDrivers() {
            const activeDriverPhones = getActiveDriversThisMonth();
            let html = '';
            let active = 0, city = 0, inter = 0;
            
            LOCAL_DRIVERS.forEach(driver => {
                if (!activeDriverPhones.includes(driver.phone)) return;
                
                if (driver.status === 'active') {
                    active++;
                    if (driver.shiftType === 'city') city++;
                    if (driver.shiftType === 'intercity') inter++;
                }
                
                let statusText = '‚ö™ –û—Ñ–ª–∞–π–Ω';
                let statusClass = 'status-offline';
                
                if (driver.status === 'active') {
                    if (driver.shiftType === 'city') {
                        statusText = 'üèôÔ∏è –†–∞–±–æ—Ç–∞–µ—Ç (–≥–æ—Ä–æ–¥)';
                        statusClass = 'status-working';
                    } else if (driver.shiftType === 'intercity') {
                        statusText = 'üõ£Ô∏è –ú–µ–∂–≥–æ—Ä–æ–¥';
                        statusClass = 'status-intercity';
                    }
                }
                
                const hasGeo = driver.lat && driver.lng;
                
                html += `<tr>
                    <td>
                        <div class="fw-bold">${driver.short || driver.name}</div>
                    </td>
                    <td>${driver.phone}</td>
                    <td><span class="${statusClass} px-3 py-2">${statusText}</span></td>
                    <td>${hasGeo ? '<span class="text-success"><i class="bi bi-geo-alt-fill"></i> –ï—Å—Ç—å</span>' : '‚Äî'}</td>
                    <td>
                        ${hasGeo ? `<button class="btn btn-sm btn-outline-info" onclick="showDriverMap('${driver.phone}', '${driver.short || driver.name}')">
                            <i class="bi bi-map"></i>
                        </button>` : '‚Äî'}
                    </td>
                    <td>
                        <div class="d-flex align-items-center gap-2">
                            <span class="text-monospace" id="pass-${driver.phone}">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
                            <button class="btn btn-sm btn-link" onclick="togglePasswordVisibility('${driver.phone}')">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-primary" onclick="editDriverPassword('${driver.phone}')">
                                <i class="bi bi-pencil"></i>
                            </button>
                        </div>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteDriver('${driver.phone}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>`;
            });
            
            document.getElementById('admin-drivers-table').innerHTML = html || '<tr><td colspan="7" class="text-center">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤–æ–¥–∏—Ç–µ–ª–µ–π</td></tr>';
            document.getElementById('admin-active-count').innerHTML = active;
            document.getElementById('admin-city-count').innerHTML = city;
            document.getElementById('admin-inter-count').innerHTML = inter;
        }
        
        function loadAllDrivers() {
            let html = '';
            
            LOCAL_DRIVERS.forEach(driver => {
                let statusText = driver.status === 'active' ? 'üü¢ –ê–∫—Ç–∏–≤–µ–Ω' : '‚ö™ –û—Ñ–ª–∞–π–Ω';
                
                html += `<tr>
                    <td>
                        <div class="fw-bold">${driver.short || driver.name}</div>
                    </td>
                    <td>${driver.phone}</td>
                    <td>
                        <div class="d-flex align-items-center gap-2">
                            <span class="text-monospace" id="all-pass-${driver.phone}">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
                            <button class="btn btn-sm btn-link" onclick="toggleAllPasswordVisibility('${driver.phone}')">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                    </td>
                    <td>
                        <span class="${driver.status === 'active' ? 'status-working' : 'status-offline'} px-3 py-2">
                            ${statusText}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editDriverPassword('${driver.phone}')">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteDriver('${driver.phone}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>`;
            });
            
            document.getElementById('admin-all-drivers-table').innerHTML = html || '<tr><td colspan="5" class="text-center">–ù–µ—Ç –≤–æ–¥–∏—Ç–µ–ª–µ–π</td></tr>';
        }
        
        window.deleteDriver = function(phone) {
            if (confirm('‚ö†Ô∏è –¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å –≤–æ–¥–∏—Ç–µ–ª—è?\n–í—Å–µ –µ–≥–æ –ø–æ–µ–∑–¥–∫–∏ –∏ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.')) {
                LOCAL_DRIVERS = LOCAL_DRIVERS.filter(d => d.phone !== phone);
                LOCAL_TRIPS = LOCAL_TRIPS.filter(t => t.driverId !== phone);
                LOCAL_MESSAGES = LOCAL_MESSAGES.filter(m => m.driverPhone !== phone);
                saveToStorage();
                
                alert('‚úÖ –í–æ–¥–∏—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω –∏–∑ —Å–∏—Å—Ç–µ–º—ã');
                loadAdminDrivers();
                loadAllDrivers();
                loadAdminTrips();
                loadMessageDriversList();
                document.getElementById('admin-total-drivers').innerHTML = LOCAL_DRIVERS.length;
            }
        };
        
        window.togglePasswordVisibility = function(phone) {
            const span = document.getElementById(`pass-${phone}`);
            const driver = LOCAL_DRIVERS.find(d => d.phone === phone);
            if (span.innerText.includes('‚Ä¢')) {
                span.innerText = driver.password;
            } else {
                span.innerText = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
            }
        };
        
        window.toggleAllPasswordVisibility = function(phone) {
            const span = document.getElementById(`all-pass-${phone}`);
            const driver = LOCAL_DRIVERS.find(d => d.phone === phone);
            if (span.innerText.includes('‚Ä¢')) {
                span.innerText = driver.password;
            } else {
                span.innerText = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
            }
        };
        
        window.editDriverPassword = function(phone) {
            const newPass = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–ª—è –≤–æ–¥–∏—Ç–µ–ª—è:');
            if (newPass) {
                const driver = LOCAL_DRIVERS.find(d => d.phone === phone);
                if (driver) {
                    driver.password = newPass;
                    saveToStorage();
                    alert('‚úÖ –ü–∞—Ä–æ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω');
                    loadAdminDrivers();
                    loadAllDrivers();
                }
            }
        };
        
        function loadAdminTrips() {
            let html = '';
            
            LOCAL_TRIPS.slice().reverse().forEach(trip => {
                html += `<tr>
                    <td>${trip.driverName}</td>
                    <td>${trip.date}</td>
                    <td><span class="badge ${trip.type === '–≥–æ—Ä–æ–¥' ? 'bg-primary' : 'bg-warning'}">${trip.type}</span></td>
                    <td>
                        <input type="number" class="form-control form-control-sm" style="width: 80px;" 
                            value="${trip.hours || 0}" id="hours-${trip.id}" step="0.5" ${trip.type !== '–≥–æ—Ä–æ–¥' ? 'disabled' : ''}>
                    </td>
                    <td>
                        <input type="number" class="form-control form-control-sm" style="width: 100px;" 
                            value="${trip.earn || 0}" id="earn-${trip.id}">
                    </td>
                    <td>${trip.comment || ''}</td>
                    <td>
                        <button class="btn btn-sm btn-success" onclick="editTrip('${trip.id}')">
                            <i class="bi bi-check-lg"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteTrip('${trip.id}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>`;
            });
            
            document.getElementById('admin-trips-table').innerHTML = html || '<tr><td colspan="7" class="text-center">–ù–µ—Ç –ø–æ–µ–∑–¥–æ–∫</td></tr>';
        }
        
        window.editTrip = function(tripId) {
            const trip = LOCAL_TRIPS.find(t => t.id === tripId);
            if (!trip) return;
            
            const newEarn = parseFloat(document.getElementById(`earn-${tripId}`).value);
            if (!isNaN(newEarn) && newEarn > 0) {
                trip.earn = newEarn;
            }
            
            if (trip.type === '–≥–æ—Ä–æ–¥') {
                const newHours = parseFloat(document.getElementById(`hours-${tripId}`).value);
                if (!isNaN(newHours) && newHours > 0) {
                    trip.hours = newHours;
                    trip.earn = Math.round(newHours * currentRate);
                }
            }
            
            saveToStorage();
            alert('‚úÖ –ü–æ–µ–∑–¥–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
            loadAdminTrips();
            loadAdminReports();
        };
        
        window.deleteTrip = function(tripId) {
            if (confirm('‚ö†Ô∏è –£–¥–∞–ª–∏—Ç—å –ø–æ–µ–∑–¥–∫—É?')) {
                LOCAL_TRIPS = LOCAL_TRIPS.filter(t => t.id !== tripId);
                saveToStorage();
                alert('‚úÖ –ü–æ–µ–∑–¥–∫–∞ —É–¥–∞–ª–µ–Ω–∞');
                loadAdminTrips();
                loadAdminReports();
            }
        };
        
        // ============ –û–¢–ß–ï–¢–´ ============
        function updateMonthSelectors() {
            const months = new Set();
            
            LOCAL_TRIPS.forEach(trip => {
                if (trip.date) {
                    months.add(trip.date.slice(0, 7));
                }
            });
            
            LOCAL_ARCHIVE.forEach(arch => {
                months.add(arch.month);
            });
            
            const currentMonth = new Date().toISOString().slice(0, 7);
            months.add(currentMonth);
            
            const sortedMonths = Array.from(months).sort().reverse();
            
            let adminOptions = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü</option>';
            
            sortedMonths.forEach(month => {
                const displayMonth = month.replace('-', '.');
                adminOptions += `<option value="${month}">${displayMonth}</option>`;
            });
            
            const adminSelect = document.getElementById('report-month-select');
            if (adminSelect) adminSelect.innerHTML = adminOptions;
        }
        
        window.loadAdminMonthReport = function() {
            const month = document.getElementById('report-month-select').value;
            if (!month) {
                document.getElementById('admin-daily-report-content').innerHTML = '<p class="text-center text-secondary py-4">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü</p>';
                document.getElementById('admin-summary-report-content').innerHTML = '<p class="text-center text-secondary py-4">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü</p>';
                document.getElementById('admin-total-hours').innerHTML = '0 —á';
                document.getElementById('admin-total-inter').innerHTML = '0';
                document.getElementById('admin-total-earn').innerHTML = '0 ‚ÇΩ';
                return;
            }
            
            let monthTrips = LOCAL_TRIPS.filter(t => t.date && t.date.startsWith(month));
            
            if (monthTrips.length === 0) {
                document.getElementById('admin-daily-report-content').innerHTML = '<p class="text-center text-secondary py-4">–ù–µ—Ç –ø–æ–µ–∑–¥–æ–∫ –∑–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü</p>';
                document.getElementById('admin-summary-report-content').innerHTML = '<p class="text-center text-secondary py-4">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
                document.getElementById('admin-total-hours').innerHTML = '0 —á';
                document.getElementById('admin-total-inter').innerHTML = '0';
                document.getElementById('admin-total-earn').innerHTML = '0 ‚ÇΩ';
                return;
            }
            
            window.currentMonthTrips = monthTrips;
            
            loadAdminDailyReport(monthTrips);
            loadAdminSummaryReport(monthTrips);
        };
        
        function loadAdminDailyReport(trips) {
            let html = '';
            
            trips.slice().reverse().forEach(trip => {
                const route = trip.type === '–≥–æ—Ä–æ–¥' ? `${trip.hours} —á` : (trip.direction || '–ú–µ–∂–≥–æ—Ä–æ–¥');
                html += `<div class="trip-row">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="fw-bold">${trip.driverName}</div>
                            <div class="text-secondary small">${trip.date}</div>
                        </div>
                        <div class="text-end">
                            <span class="badge ${trip.type === '–≥–æ—Ä–æ–¥' ? 'bg-primary' : 'bg-warning'} mb-1">${trip.type}</span>
                            <div class="fw-bold text-success">${trip.earn} ‚ÇΩ</div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between mt-2">
                        <div><small class="text-secondary">–ú–∞—Ä—à—Ä—É—Ç: ${route}</small></div>
                        ${trip.comment ? `<div><small class="text-secondary">üí¨ ${trip.comment}</small></div>` : ''}
                    </div>
                </div>`;
            });
            
            document.getElementById('admin-daily-report-content').innerHTML = html;
        }
        
        function loadAdminSummaryReport(trips) {
            const summary = {};
            let totalCityHours = 0;
            let totalInterTrips = 0;
            let totalEarn = 0;
            
            trips.forEach(trip => {
                if (!summary[trip.driverName]) {
                    summary[trip.driverName] = {
                        cityHours: 0,
                        interTrips: 0,
                        earn: 0
                    };
                }
                
                if (trip.type === '–≥–æ—Ä–æ–¥') {
                    summary[trip.driverName].cityHours += trip.hours || 0;
                    totalCityHours += trip.hours || 0;
                } else {
                    summary[trip.driverName].interTrips += 1;
                    totalInterTrips += 1;
                }
                
                summary[trip.driverName].earn += trip.earn || 0;
                totalEarn += trip.earn || 0;
            });
            
            let html = '';
            
            Object.keys(summary).sort().forEach(name => {
                const s = summary[name];
                html += `<div class="driver-stat-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fw-bold">${name}</div>
                            <div class="d-flex gap-3 mt-1 small">
                                <span class="text-primary">üöï ${s.cityHours.toFixed(1)} —á</span>
                                <span class="text-warning">üõ£Ô∏è ${s.interTrips} –ø–æ–µ–∑–¥–æ–∫</span>
                            </div>
                        </div>
                        <div class="text-end">
                            <div class="fw-bold text-success fs-5">${s.earn} ‚ÇΩ</div>
                        </div>
                    </div>
                </div>`;
            });
            
            document.getElementById('admin-summary-report-content').innerHTML = html;
            document.getElementById('admin-total-hours').innerHTML = `${totalCityHours.toFixed(1)} —á`;
            document.getElementById('admin-total-inter').innerHTML = totalInterTrips;
            document.getElementById('admin-total-earn').innerHTML = `${totalEarn} ‚ÇΩ`;
        }
        
        window.switchAdminReportTab = function(tab) {
            const dailyContainer = document.getElementById('admin-daily-report-container');
            const summaryContainer = document.getElementById('admin-summary-report-container');
            
            if (tab === 'daily') {
                dailyContainer.classList.remove('hidden');
                summaryContainer.classList.add('hidden');
            } else {
                dailyContainer.classList.add('hidden');
                summaryContainer.classList.remove('hidden');
            }
        };
        
        // ============ –ê–†–•–ò–í ============
        function updateArchiveSelectors() {
            const months = new Set();
            
            LOCAL_ARCHIVE.forEach(arch => {
                months.add(arch.month);
            });
            
            const sortedMonths = Array.from(months).sort().reverse();
            
            let adminOptions = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü</option>';
            
            sortedMonths.forEach(month => {
                const displayMonth = month.replace('-', '.');
                adminOptions += `<option value="${month}">${displayMonth}</option>`;
            });
            
            const adminSelect = document.getElementById('admin-archive-month-select');
            if (adminSelect) adminSelect.innerHTML = adminOptions;
        }
        
        function loadArchiveList() {
            let html = '';
            
            LOCAL_ARCHIVE.slice().reverse().forEach((arch, index) => {
                html += `<div class="archive-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="fw-bold mb-1">${arch.month}</h4>
                            <div class="text-secondary">
                                <i class="bi bi-truck"></i> ${arch.trips.length} –ø–æ–µ–∑–¥–æ–∫ ‚Ä¢ ${arch.total} ‚ÇΩ
                            </div>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-success me-2" onclick="exportArchive(${index})">
                                <i class="bi bi-file-earmark-excel"></i>
                            </button>
                            <button class="btn btn-sm btn-primary me-2" onclick="printArchive(${index})">
                                <i class="bi bi-printer"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteArchive(${index})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mt-3">
                        <h6>–ò—Ç–æ–≥–∏ –ø–æ –≤–æ–¥–∏—Ç–µ–ª—è–º:</h6>
                        ${Object.keys(arch.summary || {}).map(name => `
                            <div class="d-flex justify-content-between mb-2">
                                <span>${name}</span>
                                <span class="fw-bold">${arch.summary[name]?.totalEarn || 0} ‚ÇΩ</span>
                            </div>
                            <div class="d-flex gap-3 text-secondary small mb-2">
                                <span>üöï ${arch.summary[name]?.cityHours?.toFixed(1) || 0} —á</span>
                                <span>üõ£Ô∏è ${arch.summary[name]?.interTrips || 0} –ø–æ–µ–∑–¥–æ–∫</span>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
            });
            
            document.getElementById('admin-archive-content').innerHTML = html || '<p class="text-center py-5 text-secondary"><i class="bi bi-archive fs-1"></i><br>–ù–µ—Ç –∞—Ä—Ö–∏–≤–æ–≤</p>';
        }
        
        window.loadAdminArchiveMonth = function() {
            const month = document.getElementById('admin-archive-month-select').value;
            if (!month) {
                loadArchiveList();
                return;
            }
            
            const archive = LOCAL_ARCHIVE.find(a => a.month === month);
            if (archive) {
                const index = LOCAL_ARCHIVE.findIndex(a => a.month === month);
                let html = `<div class="archive-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="fw-bold mb-1">${archive.month}</h4>
                            <div class="text-secondary">
                                <i class="bi bi-truck"></i> ${archive.trips.length} –ø–æ–µ–∑–¥–æ–∫ ‚Ä¢ ${archive.total} ‚ÇΩ
                            </div>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-success me-2" onclick="exportArchive(${index})">
                                <i class="bi bi-file-earmark-excel"></i>
                            </button>
                            <button class="btn btn-sm btn-primary me-2" onclick="printArchive(${index})">
                                <i class="bi bi-printer"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteArchive(${index})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mt-3">
                        <h6>–ò—Ç–æ–≥–∏ –ø–æ –≤–æ–¥–∏—Ç–µ–ª—è–º:</h6>
                        ${Object.keys(archive.summary || {}).map(name => `
                            <div class="d-flex justify-content-between mb-2">
                                <span>${name}</span>
                                <span class="fw-bold">${archive.summary[name]?.totalEarn || 0} ‚ÇΩ</span>
                            </div>
                            <div class="d-flex gap-3 text-secondary small mb-2">
                                <span>üöï ${archive.summary[name]?.cityHours?.toFixed(1) || 0} —á</span>
                                <span>üõ£Ô∏è ${archive.summary[name]?.interTrips || 0} –ø–æ–µ–∑–¥–æ–∫</span>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
                document.getElementById('admin-archive-content').innerHTML = html;
            }
        };
        
        window.deleteArchive = function(index) {
            if (confirm('‚ö†Ô∏è –£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∞—Ä—Ö–∏–≤?\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
                LOCAL_ARCHIVE.splice(index, 1);
                saveToStorage();
                alert('‚úÖ –ê—Ä—Ö–∏–≤ —É–¥–∞–ª–µ–Ω');
                loadArchiveList();
                updateArchiveSelectors();
            }
        };
        
        window.clearAllArchives = function() {
            if (confirm('‚ö†Ô∏è –£–¥–∞–ª–∏—Ç—å –í–°–ï –∞—Ä—Ö–∏–≤—ã?\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
                LOCAL_ARCHIVE = [];
                saveToStorage();
                alert('‚úÖ –í—Å–µ –∞—Ä—Ö–∏–≤—ã —É–¥–∞–ª–µ–Ω—ã');
                loadArchiveList();
                updateArchiveSelectors();
            }
        };
        
        window.exportArchive = function(index) {
            const archive = LOCAL_ARCHIVE[index];
            if (!archive) return;
            
            let csv = "–í–æ–¥–∏—Ç–µ–ª—å,–î–∞—Ç–∞,–¢–∏–ø,–ß–∞—Å—ã/–ú–∞—Ä—à—Ä—É—Ç,–°—É–º–º–∞,–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π\n";
            archive.trips.forEach(t => {
                const details = t.type === '–≥–æ—Ä–æ–¥' ? t.hours + ' —á' : (t.direction || '–ú–µ–∂–≥–æ—Ä–æ–¥');
                csv += `${t.driverName},${t.date},${t.type},${details},${t.earn},${t.comment || ''}\n`;
            });
            
            csv += `\n–û–ë–©–ò–ô –ò–¢–û–ì,,,${archive.total} ‚ÇΩ`;
            
            const blob = new Blob(["\uFEFF" + csv], {type: 'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `shintorg_${archive.month}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        };
        
        window.printArchive = function(index) {
            const archive = LOCAL_ARCHIVE[index];
            if (!archive) return;
            
            const w = window.open('', '_blank');
            w.document.write(`
                <html>
                <head>
                    <title>–®–∏–Ω—Ç–æ—Ä–≥ - –ê—Ä—Ö–∏–≤ ${archive.month}</title>
                    <style>
                        body { font-family: Arial; padding: 30px; max-width: 1200px; margin: 0 auto; }
                        h1 { color: #0f5e7e; border-bottom: 2px solid #0f5e7e; padding-bottom: 10px; }
                        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
                        th { background: #0f5e7e; color: white; padding: 12px; }
                        td { padding: 10px; border: 1px solid #ddd; }
                        .total { font-weight: bold; font-size: 20px; margin-top: 30px; }
                    </style>
                </head>
                <body>
                    <h1>–®–∏–Ω—Ç–æ—Ä–≥ –°—É—Ä–≥—É—Ç</h1>
                    <h2>–ê—Ä—Ö–∏–≤: ${archive.month}</h2>
                    
                    <h3>–ò—Ç–æ–≥–∏ –ø–æ –≤–æ–¥–∏—Ç–µ–ª—è–º</h3>
                    ${Object.keys(archive.summary || {}).map(name => `
                        <div style="margin-bottom: 15px;">
                            <div><strong>${name}</strong> - ${archive.summary[name]?.totalEarn || 0} ‚ÇΩ</div>
                            <div style="color: #666; margin-left: 20px;">
                                –ì–æ—Ä–æ–¥: ${archive.summary[name]?.cityHours?.toFixed(1) || 0} —á, 
                                –ú–µ–∂–≥–æ—Ä–æ–¥: ${archive.summary[name]?.interTrips || 0} –ø–æ–µ–∑–¥–æ–∫
                            </div>
                        </div>
                    `).join('')}
                    
                    <h3>–ü–æ–µ–∑–¥–∫–∏</h3>
                    <table>
                        <tr>
                            <th>–í–æ–¥–∏—Ç–µ–ª—å</th>
                            <th>–î–∞—Ç–∞</th>
                            <th>–¢–∏–ø</th>
                            <th>–ú–∞—Ä—à—Ä—É—Ç</th>
                            <th>–°—É–º–º–∞</th>
                        </tr>
                        ${archive.trips.map(t => `
                            <tr>
                                <td>${t.driverName}</td>
                                <td>${t.date}</td>
                                <td>${t.type}</td>
                                <td>${t.type === '–≥–æ—Ä–æ–¥' ? t.hours + ' —á' : (t.direction || '–ú–µ–∂–≥–æ—Ä–æ–¥')}</td>
                                <td>${t.earn} ‚ÇΩ</td>
                            </tr>
                        `).join('')}
                    </table>
                    
                    <div class="total">–û–±—â–∏–π –∏—Ç–æ–≥: ${archive.total} ‚ÇΩ</div>
                    <p style="margin-top: 40px; color: #666;">–î–∞—Ç–∞ –∑–∞–∫—Ä—ã—Ç–∏—è: ${new Date(archive.closedAt).toLocaleDateString()}</p>
                </body>
                </html>
            `);
            w.document.close();
            w.print();
        };
        
        // ============ –≠–ö–°–ü–û–†–¢ –û–¢–ß–ï–¢–û–í ============
        window.exportDailyReportToExcel = function() {
            if (!window.currentMonthTrips || window.currentMonthTrips.length === 0) {
                alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
                return;
            }
            
            let csv = "–í–æ–¥–∏—Ç–µ–ª—å,–î–∞—Ç–∞,–¢–∏–ø,–ú–∞—Ä—à—Ä—É—Ç,–°—É–º–º–∞,–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π\n";
            window.currentMonthTrips.forEach(t => {
                const route = t.type === '–≥–æ—Ä–æ–¥' ? t.hours + ' —á' : (t.direction || '–ú–µ–∂–≥–æ—Ä–æ–¥');
                csv += `${t.driverName},${t.date},${t.type},${route},${t.earn},${t.comment || ''}\n`;
            });
            
            const blob = new Blob(["\uFEFF" + csv], {type: 'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `shintorg_report_daily.csv`;
            a.click();
            URL.revokeObjectURL(url);
        };
        
        window.exportSummaryReportToExcel = function() {
            if (!window.currentMonthTrips || window.currentMonthTrips.length === 0) {
                alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
                return;
            }
            
            const summary = {};
            window.currentMonthTrips.forEach(t => {
                if (!summary[t.driverName]) {
                    summary[t.driverName] = { cityHours: 0, interTrips: 0, earn: 0 };
                }
                if (t.type === '–≥–æ—Ä–æ–¥') summary[t.driverName].cityHours += t.hours || 0;
                else summary[t.driverName].interTrips += 1;
                summary[t.driverName].earn += t.earn || 0;
            });
            
            let csv = "–í–æ–¥–∏—Ç–µ–ª—å,–ß–∞—Å—ã (–≥–æ—Ä–æ–¥),–ü–æ–µ–∑–¥–∫–∏ (–ú–ì),–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ\n";
            Object.keys(summary).sort().forEach(name => {
                const s = summary[name];
                csv += `${name},${s.cityHours.toFixed(1)} —á,${s.interTrips},${s.earn} ‚ÇΩ\n`;
            });
            
            const total = window.currentMonthTrips.reduce((s, t) => s + (t.earn || 0), 0);
            csv += `\n–û–ë–©–ò–ô –ò–¢–û–ì,,,${total} ‚ÇΩ`;
            
            const blob = new Blob(["\uFEFF" + csv], {type: 'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `shintorg_report_summary.csv`;
            a.click();
            URL.revokeObjectURL(url);
        };
        
        window.printDailyReport = function() {
            if (!window.currentMonthTrips || window.currentMonthTrips.length === 0) {
                alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–µ—á–∞—Ç–∏');
                return;
            }
            
            const w = window.open('', '_blank');
            
            let tableHtml = '';
            window.currentMonthTrips.slice().reverse().forEach(t => {
                const route = t.type === '–≥–æ—Ä–æ–¥' ? t.hours + ' —á' : (t.direction || '–ú–µ–∂–≥–æ—Ä–æ–¥');
                tableHtml += `<tr>
                    <td>${t.driverName}</td>
                    <td>${t.date}</td>
                    <td>${t.type}</td>
                    <td>${route}</td>
                    <td>${t.earn} ‚ÇΩ</td>
                </tr>`;
            });
            
            w.document.write(`
                <html>
                <head>
                    <title>–®–∏–Ω—Ç–æ—Ä–≥ - –û—Ç—á–µ—Ç</title>
                    <style>
                        body { font-family: Arial; padding: 30px; }
                        h1 { color: #0f5e7e; }
                        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
                        th { background: #0f5e7e; color: white; padding: 12px; }
                        td { padding: 10px; border: 1px solid #ddd; }
                    </style>
                </head>
                <body>
                    <h1>–®–∏–Ω—Ç–æ—Ä–≥ –°—É—Ä–≥—É—Ç</h1>
                    <h2>–ü–æ—Å–º–µ–Ω–Ω—ã–π –æ—Ç—á–µ—Ç</h2>
                    <table>
                        <tr>
                            <th>–í–æ–¥–∏—Ç–µ–ª—å</th>
                            <th>–î–∞—Ç–∞</th>
                            <th>–¢–∏–ø</th>
                            <th>–ú–∞—Ä—à—Ä—É—Ç</th>
                            <th>–°—É–º–º–∞</th>
                        </tr>
                        ${tableHtml}
                    </table>
                </body>
                </html>
            `);
            w.document.close();
            w.print();
        };
        
        window.printSummaryReport = function() {
            if (!window.currentMonthTrips || window.currentMonthTrips.length === 0) {
                alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–µ—á–∞—Ç–∏');
                return;
            }
            
            const summary = {};
            let totalEarn = 0;
            
            window.currentMonthTrips.forEach(t => {
                if (!summary[t.driverName]) {
                    summary[t.driverName] = { cityHours: 0, interTrips: 0, earn: 0 };
                }
                if (t.type === '–≥–æ—Ä–æ–¥') summary[t.driverName].cityHours += t.hours || 0;
                else summary[t.driverName].interTrips += 1;
                summary[t.driverName].earn += t.earn || 0;
                totalEarn += t.earn || 0;
            });
            
            let tableHtml = '';
            Object.keys(summary).sort().forEach(name => {
                const s = summary[name];
                tableHtml += `<tr>
                    <td>${name}</td>
                    <td>${s.cityHours.toFixed(1)} —á</td>
                    <td>${s.interTrips}</td>
                    <td>${s.earn} ‚ÇΩ</td>
                </tr>`;
            });
            
            const w = window.open('', '_blank');
            w.document.write(`
                <html>
                <head>
                    <title>–®–∏–Ω—Ç–æ—Ä–≥ - –°–≤–æ–¥–∫–∞</title>
                    <style>
                        body { font-family: Arial; padding: 30px; }
                        h1 { color: #0f5e7e; }
                        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
                        th { background: #0f5e7e; color: white; padding: 12px; }
                        td { padding: 10px; border: 1px solid #ddd; }
                        .total { font-size: 24px; margin-top: 30px; color: #0f5e7e; }
                    </style>
                </head>
                <body>
                    <h1>–®–∏–Ω—Ç–æ—Ä–≥ –°—É—Ä–≥—É—Ç</h1>
                    <h2>–°–≤–æ–¥–Ω—ã–π –æ—Ç—á–µ—Ç</h2>
                    <table>
                        <tr>
                            <th>–í–æ–¥–∏—Ç–µ–ª—å</th>
                            <th>–ß–∞—Å—ã (–≥–æ—Ä–æ–¥)</th>
                            <th>–ü–æ–µ–∑–¥–∫–∏ (–ú–ì)</th>
                            <th>–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ</th>
                        </tr>
                        ${tableHtml}
                    </table>
                    <div class="total">–û–ë–©–ò–ô –ó–ê–†–ê–ë–û–¢–û–ö: ${totalEarn} ‚ÇΩ</div>
                </body>
                </html>
            `);
            w.document.close();
            w.print();
        };
        
        // ============ –ó–ê–ö–†–´–¢–ò–ï –ú–ï–°–Ø–¶–ê ============
        window.closeMonth = function() {
            if (!confirm('‚ö†Ô∏è –ó–∞–∫—Ä—ã—Ç—å —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü? –í—Å–µ –ø–æ–µ–∑–¥–∫–∏ –±—É–¥—É—Ç –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω—ã –∏ —É–¥–∞–ª–µ–Ω—ã –∏–∑ –æ—Ç—á–µ—Ç–æ–≤.')) return;
            
            const month = new Date().toISOString().slice(0, 7);
            const monthTrips = LOCAL_TRIPS.filter(t => t.date && t.date.startsWith(month));
            
            if (monthTrips.length === 0) {
                alert('‚ùå –ù–µ—Ç –ø–æ–µ–∑–¥–æ–∫ –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü');
                return;
            }
            
            const total = monthTrips.reduce((s, t) => s + (t.earn || 0), 0);
            
            // –°–æ—Å—Ç–∞–≤–ª—è–µ–º —Å–≤–æ–¥–∫—É –ø–æ –≤–æ–¥–∏—Ç–µ–ª—è–º
            const summary = {};
            monthTrips.forEach(t => {
                if (!summary[t.driverName]) {
                    summary[t.driverName] = { cityHours: 0, interTrips: 0, totalEarn: 0 };
                }
                if (t.type === '–≥–æ—Ä–æ–¥') summary[t.driverName].cityHours += t.hours || 0;
                else summary[t.driverName].interTrips += 1;
                summary[t.driverName].totalEarn += t.earn || 0;
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∞—Ä—Ö–∏–≤
            LOCAL_ARCHIVE.push({
                month: month,
                trips: JSON.parse(JSON.stringify(monthTrips)),
                summary: summary,
                total: total,
                closedAt: new Date().toISOString()
            });
            
            // –£–¥–∞–ª—è–µ–º –ø–æ–µ–∑–¥–∫–∏ –∑–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü
            LOCAL_TRIPS = LOCAL_TRIPS.filter(t => !t.date || !t.date.startsWith(month));
            saveToStorage();
            
            alert(`‚úÖ –ú–µ—Å—è—Ü ${month} –∑–∞–∫—Ä—ã—Ç! –ò—Ç–æ–≥–æ: ${total} ‚ÇΩ`);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            if (currentRole === 'admin') {
                loadAdminData();
                document.getElementById('report-month-select').value = '';
                document.getElementById('admin-daily-report-content').innerHTML = '<p class="text-center text-secondary py-4">–ù–µ—Ç –ø–æ–µ–∑–¥–æ–∫ –∑–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü</p>';
                document.getElementById('admin-summary-report-content').innerHTML = '<p class="text-center text-secondary py-4">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
                document.getElementById('admin-total-hours').innerHTML = '0 —á';
                document.getElementById('admin-total-inter').innerHTML = '0';
                document.getElementById('admin-total-earn').innerHTML = '0 ‚ÇΩ';
            }
            
            updateMonthSelectors();
            updateArchiveSelectors();
        };
        
        // ============ –ù–ê–°–¢–†–û–ô–ö–ò ============
        window.updateRate = function() {
            const rate = parseFloat(document.getElementById('admin-rate-input').value);
            if (rate > 0) {
                currentRate = rate;
                document.getElementById('rate-display').innerHTML = `${rate} ‚ÇΩ/—á`;
                localStorage.setItem('shintorg_rate', rate.toString());
                alert('‚úÖ –¢–∞—Ä–∏—Ñ –æ–±–Ω–æ–≤–ª–µ–Ω');
            }
        };
        
        window.changeAdminPassword = function() {
            const newPass = document.getElementById('admin-new-pass').value;
            if (newPass) {
                ADMIN_CRED.password = newPass;
                saveToStorage();
                alert('‚úÖ –ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏–∑–º–µ–Ω–µ–Ω');
                document.getElementById('admin-new-pass').value = '';
            }
        };
        
        function loadMessageDriversList() {
            let html = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤–æ–¥–∏—Ç–µ–ª—è</option>';
            LOCAL_DRIVERS.forEach(driver => {
                html += `<option value="${driver.phone}">${driver.short || driver.name}</option>`;
            });
            document.getElementById('message-driver-select').innerHTML = html;
        }
        
        // ============ –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï ============
        window.switchDriverMode = function(mode) {
            document.getElementById('driver-city-panel').classList.toggle('hidden', mode !== 'city');
            document.getElementById('driver-inter-panel').classList.toggle('hidden', mode !== 'inter');
        };
        
        window.switchAdminTab = function(tab) {
            const tabs = ['drivers', 'all-drivers', 'trips', 'reports', 'archive', 'settings'];
            tabs.forEach(t => {
                document.getElementById(`admin-${t}-tab`).classList.add('hidden');
            });
            document.getElementById(`admin-${tab}-tab`).classList.remove('hidden');
            
            document.querySelectorAll('#admin-cabinet .mobile-tabs .mobile-tab').forEach((el, i) => {
                el.classList.toggle('active', i === tabs.indexOf(tab));
            });
            
            if (tab === 'archive') {
                loadArchiveList();
                updateArchiveSelectors();
            }
            if (tab === 'reports') {
                loadAdminReports();
            }
        };
        
        window.showRegister = function() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('register-screen').classList.remove('hidden');
        };
        
        window.backToLogin = function() {
            document.getElementById('register-screen').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
        };
        
        window.logout = function() {
            if (geoWatchId) navigator.geolocation.clearWatch(geoWatchId);
            if (shiftTimer) clearInterval(shiftTimer);
            
            currentUser = null;
            currentRole = null;
            shiftActive = false;
            
            clearStoredSession();
            
            document.getElementById('driver-cabinet').classList.add('hidden');
            document.getElementById('admin-cabinet').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
            closeMap();
            
            document.getElementById('timer-display').innerText = '00:00:00';
            document.getElementById('shift-start-btn').classList.remove('hidden');
            document.getElementById('shift-end-btn').classList.add('hidden');
        };
        
        function loadAdminReports() {
            const month = new Date().toISOString().slice(0, 7);
            const select = document.getElementById('report-month-select');
            if (select) {
                select.value = month;
                loadAdminMonthReport();
            }
        }
    </script>
</body>
</html>
