<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–®–∏–Ω—Ç–æ—Ä–≥ ‚Ä¢ –£—á–µ—Ç —Å–º–µ–Ω</title>
    
    <!-- FAVICON - –ì–†–£–ó–û–í–ò–ö -->
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%230f5e7e'/%3E%3Ctext x='50' y='68' font-size='50' text-anchor='middle' fill='white' font-family='Arial'%3Eüöõ%3C/text%3E%3C/svg%3E">
    <link rel="icon" type="image/png" sizes="32x32" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Ccircle cx='16' cy='16' r='14' fill='%230f5e7e'/%3E%3Ctext x='16' y='22' font-size='20' text-anchor='middle' fill='white' font-family='Arial'%3Eüöõ%3C/text%3E%3C/svg%3E">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f5e7e">
    
    <!-- Bootstrap 5 + Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    
    <!-- Leaflet –¥–ª—è –∫–∞—Ä—Ç -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #0a3a4a; font-family: 'Segoe UI', Roboto, sans-serif; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; padding: 0; }
        
        /* –ú–û–ë–ò–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø (–¥–ª—è –≤–æ–¥–∏—Ç–µ–ª—è –∏ –∫—É—Ä–∞—Ç–æ—Ä–∞) */
        .mobile-container { max-width: 450px; width: 100%; background: #f5f9fc; min-height: 100vh; box-shadow: 0 0 30px rgba(0,0,0,0.2); overflow-x: hidden; margin: 0 auto; }
        
        /* –î–ï–°–ö–¢–û–ü–ù–ê–Ø –í–ï–†–°–ò–Ø (–¥–ª—è –∞–¥–º–∏–Ω–∞) */
        .desktop-container { max-width: 1400px; width: 100%; background: #f5f9fc; min-height: 100vh; box-shadow: 0 0 30px rgba(0,0,0,0.2); margin: 0 auto; padding: 20px; }
        
        .app-header { background: linear-gradient(135deg, #0f5e7e, #0a405a); color: white; padding: 20px 18px; border-bottom-left-radius: 30px; border-bottom-right-radius: 30px; position: sticky; top: 0; z-index: 1000; }
        .mobile-card { background: white; border-radius: 24px; padding: 18px; margin: 12px 16px; box-shadow: 0 6px 16px rgba(0,0,0,0.03); border: 1px solid rgba(255,255,255,0.8); }
        .mobile-btn { border-radius: 60px !important; padding: 14px 20px !important; font-weight: 700 !important; border: none !important; box-shadow: 0 6px 0 rgba(0,0,0,0.08) !important; transition: 0.08s !important; width: 100%; }
        .mobile-btn:active { transform: translateY(6px) !important; box-shadow: 0 2px 0 rgba(0,0,0,0.08) !important; }
        .timer-big { font-size: 52px; font-weight: 900; font-family: monospace; text-align: center; color: #0f5e7e; background: #e8f4fa; padding: 16px; border-radius: 30px; letter-spacing: 6px; }
        .geo-active { background: #d4f0d4; color: #1e6b3b; padding: 10px 16px; border-radius: 50px; font-weight: 600; }
        .geo-inactive { background: #ffe6e6; color: #b34141; padding: 10px 16px; border-radius: 50px; }
        .mobile-tabs { display: flex; background: white; border-radius: 50px; margin: 12px 16px; padding: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        .mobile-tab { flex: 1; text-align: center; padding: 12px 6px; border-radius: 50px; font-weight: 700; color: #5f7e8c; cursor: pointer; }
        .mobile-tab.active { background: #0f5e7e; color: white; }
        .report-tabs { display: flex; background: white; border-radius: 50px; margin: 12px 16px; padding: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        .report-tab { flex: 1; text-align: center; padding: 12px 6px; border-radius: 50px; font-weight: 700; color: #5f7e8c; cursor: pointer; }
        .report-tab.active { background: #0f5e7e; color: white; }
        .status-working { background: #d4f0d4; color: #1e6b3b; padding: 6px 14px; border-radius: 50px; font-weight: 600; }
        .status-intercity { background: #ffeab6; color: #8e6200; padding: 6px 14px; border-radius: 50px; }
        .status-offline { background: #ecf0f3; color: #5d6f7e; padding: 6px 14px; border-radius: 50px; }
        .message-bubble { background: #e3f2fd; border-radius: 24px 24px 24px 8px; padding: 16px; margin: 12px 16px; border-left: 8px solid #0f5e7e; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .driver-stat-item { background: white; border-radius: 18px; padding: 16px; margin-bottom: 12px; border-left: 6px solid #0f5e7e; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
        .trip-row { background: white; border-radius: 16px; padding: 14px; margin-bottom: 8px; border: 1px solid #ecf3f7; }
        .summary-card { background: linear-gradient(145deg, #f6fafe, #e9f2f8); border-radius: 20px; padding: 20px; margin: 16px 0; border: 2px solid rgba(15,94,126,0.1); }
        .summary-item { text-align: center; padding: 12px; border-radius: 16px; background: white; box-shadow: 0 4px 10px rgba(0,0,0,0.02); }
        .archive-card { background: linear-gradient(145deg, #fcf8e7, #fef9e9); border-radius: 20px; padding: 18px; margin-bottom: 16px; border-left: 8px solid #ffae42; }
        .archive-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .archive-content { margin-top: 16px; padding-top: 16px; border-top: 2px dashed #ffae42; }
        .hidden { display: none !important; }
        .sync-badge { background: #4caf50; color: white; padding: 4px 12px; border-radius: 50px; font-size: 11px; font-weight: 700; display: inline-block; }
        .offline-badge { background: #ff9800; color: white; padding: 4px 12px; border-radius: 50px; font-size: 11px; font-weight: 700; }
        .message-status-item { background: white; border-radius: 12px; padding: 12px; margin-bottom: 8px; border: 1px solid #ecf3f7; position: relative; }
        .delete-msg-btn { position: absolute; top: 8px; right: 8px; padding: 2px 8px; font-size: 12px; }
        
        /* –î–ï–°–ö–¢–û–ü–ù–´–ï –¢–ê–ë–õ–ò–¶–´ */
        .desktop-table { width: 100%; border-collapse: collapse; background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .desktop-table th { background: #0f5e7e; color: white; padding: 12px; font-weight: 600; text-align: left; }
        .desktop-table td { padding: 12px; border-bottom: 1px solid #ecf3f7; }
        .desktop-table tr:hover { background: #f8fcff; }
        
        /* –î–ï–°–ö–¢–û–ü–ù–ê–Ø –°–ï–¢–ö–ê */
        .desktop-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin: 20px; }
        .desktop-card { background: white; border-radius: 24px; padding: 20px; box-shadow: 0 6px 16px rgba(0,0,0,0.03); border: 1px solid rgba(255,255,255,0.8); }
        
        /* –î–ï–°–ö–¢–û–ü–ù–´–ï –ö–û–ù–¢–ï–ô–ù–ï–†–´ */
        .desktop-row { display: flex; flex-wrap: wrap; gap: 20px; margin: 20px; }
        .desktop-col { flex: 1; min-width: 300px; }
        
        @media (max-width: 768px) {
            .desktop-container { padding: 10px; }
            .desktop-grid { grid-template-columns: 1fr; margin: 10px; }
            .desktop-row { flex-direction: column; margin: 10px; }
        }
        
        @media (max-width: 450px) { .timer-big { font-size: 42px; } }
    </style>
</head>
<body>
    <div id="app">
        <!-- –ò–ù–î–ò–ö–ê–¢–û–†–´ -->
        <div id="sync-indicator" style="position: fixed; top: 10px; right: 10px; z-index: 1000; display: none;">
            <span class="sync-badge"><i class="bi bi-cloud-check"></i> –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...</span>
        </div>
        <div id="offline-indicator" style="position: fixed; top: 10px; right: 10px; z-index: 1000; display: none;">
            <span class="offline-badge"><i class="bi bi-wifi-off"></i> –û—Ñ–ª–∞–π–Ω</span>
        </div>
        
        <!-- –≠–ö–†–ê–ù –ó–ê–ì–†–£–ó–ö–ò -->
        <div id="loading-screen" class="vh-100 d-flex flex-column justify-content-center align-items-center" style="background: linear-gradient(145deg, #0f5e7e, #0a405a);">
            <div class="spinner-border text-white mb-3" style="width: 4rem; height: 4rem;"></div>
            <h4 class="text-white">–®–∏–Ω—Ç–æ—Ä–≥ –°—É—Ä–≥—É—Ç</h4>
            <p class="text-white-50">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        </div>
        
        <!-- –≠–ö–†–ê–ù –í–•–û–î–ê -->
        <div id="login-screen" class="hidden">
            <div class="mobile-container" style="margin:0 auto;">
                <div class="app-header text-center">
                    <h2><i class="bi bi-truck"></i> –®–ò–ù–¢–û–†–ì</h2>
                    <p class="mb-0 opacity-75">–£—á–µ—Ç —Å–º–µ–Ω –∏ –∑–∞—Ä–∞–±–æ—Ç–∫–∞</p>
                </div>
                
                <div class="mobile-card mt-4">
                    <div class="mobile-tabs mb-4" id="login-tabs">
                        <div class="mobile-tab active" onclick="switchLoginTab('driver')"><i class="bi bi-person"></i> –í–æ–¥–∏—Ç–µ–ª—å</div>
                        <div class="mobile-tab" onclick="switchLoginTab('admin')"><i class="bi bi-shield-lock"></i> –ê–¥–º–∏–Ω</div>
                        <div class="mobile-tab" onclick="switchLoginTab('curator')"><i class="bi bi-eye"></i> –ö—É—Ä–∞—Ç–æ—Ä</div>
                    </div>
                    
                    <!-- –í–û–î–ò–¢–ï–õ–¨ -->
                    <div id="driver-login-panel">
                        <div class="mb-3"><input type="text" class="form-control form-control-lg rounded-pill" id="driver-login" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω / –õ–æ–≥–∏–Ω"></div>
                        <div class="mb-4"><input type="password" class="form-control form-control-lg rounded-pill" id="driver-password" placeholder="–ü–∞—Ä–æ–ª—å"></div>
                        <button class="btn btn-primary mobile-btn" onclick="loginDriver()"><i class="bi bi-box-arrow-in-right"></i> –í–æ–π—Ç–∏</button>
                        <div class="text-center mt-4"><a href="#" onclick="showRegister()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a></div>
                    </div>
                    
                    <!-- –ê–î–ú–ò–ù -->
                    <div id="admin-login-panel" class="hidden">
                        <div class="mb-3"><input type="text" class="form-control form-control-lg rounded-pill" id="admin-login" placeholder="–õ–æ–≥–∏–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"></div>
                        <div class="mb-4"><input type="password" class="form-control form-control-lg rounded-pill" id="admin-password" placeholder="–ü–∞—Ä–æ–ª—å"></div>
                        <button class="btn btn-primary mobile-btn" style="background: #8e44ad;" onclick="loginAdmin()"><i class="bi bi-shield-lock"></i> –í–æ–π—Ç–∏</button>
                        <div class="text-center mt-3"><a href="#" onclick="showAdminSecret()">–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</a></div>
                    </div>
                    
                    <!-- –ö–£–†–ê–¢–û–† -->
                    <div id="curator-login-panel" class="hidden">
                        <div class="mb-3"><input type="text" class="form-control form-control-lg rounded-pill" id="curator-login" placeholder="–õ–æ–≥–∏–Ω –∫—É—Ä–∞—Ç–æ—Ä–∞"></div>
                        <div class="mb-4"><input type="password" class="form-control form-control-lg rounded-pill" id="curator-password" placeholder="–ü–∞—Ä–æ–ª—å"></div>
                        <button class="btn btn-primary mobile-btn" style="background: #2980b9;" onclick="loginCurator()"><i class="bi bi-eye"></i> –í–æ–π—Ç–∏</button>
                    </div>
                </div>
                
                <div class="mobile-card bg-light">
                    <div class="row text-center">
                        <div class="col-6">
                            <i class="bi bi-building fs-2" style="color: #0f5e7e;"></i>
                            <h6>–ì–æ—Ä–æ–¥</h6>
                            <span class="badge bg-white text-dark p-2" id="rate-display">1400 ‚ÇΩ/—á</span>
                        </div>
                        <div class="col-6">
                            <i class="bi bi-tree fs-2" style="color: #b86d0e;"></i>
                            <h6>–ú–µ–∂–≥–æ—Ä–æ–¥</h6>
                            <span class="badge bg-white text-dark p-2">–°—Ç–∞–≤–∫–∞ –≤–æ–¥–∏—Ç–µ–ª—è</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –°–ï–ö–†–ï–¢–ù–´–ô –í–•–û–î -->
        <div id="admin-secret-screen" class="hidden">
            <div class="mobile-container">
                <div class="app-header">
                    <button class="btn btn-sm btn-light position-absolute" style="left: 15px; top: 15px; border-radius: 50px;" onclick="backToLogin()"><i class="bi bi-arrow-left"></i></button>
                    <h4 class="text-center">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ</h4>
                </div>
                <div class="mobile-card mt-4">
                    <div class="text-center mb-4"><i class="bi bi-shield-shaded" style="font-size: 64px; color: #8e44ad;"></i><h5 class="mt-3">–°–µ–∫—Ä–µ—Ç–Ω—ã–π –≤—Ö–æ–¥</h5></div>
                    <div class="mb-3"><input type="password" class="form-control form-control-lg rounded-pill" id="admin-secret-key" placeholder="–°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á"></div>
                    <div class="mb-3"><input type="password" class="form-control form-control-lg rounded-pill" id="admin-new-password-secret" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å"></div>
                    <button class="btn btn-warning mobile-btn" onclick="resetAdminWithSecret()"><i class="bi bi-check-circle"></i> –í–æ–π—Ç–∏ –∏ —Å–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
                </div>
            </div>
        </div>
        
        <!-- –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø -->
        <div id="register-screen" class="hidden">
            <div class="mobile-container">
                <div class="app-header">
                    <button class="btn btn-sm btn-light position-absolute" style="left: 15px; top: 15px; border-radius: 50px;" onclick="backToLogin()"><i class="bi bi-arrow-left"></i></button>
                    <h4 class="text-center">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h4>
                </div>
                <div class="mobile-card mt-4">
                    <div class="mb-3"><input type="text" class="form-control form-control-lg rounded-pill" id="reg-name" placeholder="–§–ò–û –ø–æ–ª–Ω–æ—Å—Ç—å—é"></div>
                    <div class="mb-3"><input type="text" class="form-control form-control-lg rounded-pill" id="reg-phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω (–ª–æ–≥–∏–Ω)"></div>
                    <div class="mb-4"><input type="password" class="form-control form-control-lg rounded-pill" id="reg-pass" placeholder="–ü–∞—Ä–æ–ª—å"></div>
                    <button class="btn btn-success mobile-btn" onclick="registerDriver()"><i class="bi bi-check-circle"></i> –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                </div>
            </div>
        </div>
        
        <!-- –ö–ê–ë–ò–ù–ï–¢ –í–û–î–ò–¢–ï–õ–Ø (–ú–û–ë–ò–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø) -->
        <div id="driver-cabinet" class="hidden">
            <div class="mobile-container">
                <div class="app-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0"><i class="bi bi-truck"></i> –®–ò–ù–¢–û–†–ì</h4>
                    <span class="badge bg-white text-dark p-3 rounded-pill" id="driver-name-badge"></span>
                </div>
                
                <div class="mobile-card">
                    <div class="row">
                        <div class="col-6"><small class="text-secondary">–°–µ–≥–æ–¥–Ω—è</small><h3 class="text-success fw-bold" id="driver-today-earn">0 ‚ÇΩ</h3><small id="driver-today-hours">0 —á</small></div>
                        <div class="col-6"><small class="text-secondary">–ó–∞ –º–µ—Å—è—Ü</small><h3 class="text-primary fw-bold" id="driver-month-earn">0 ‚ÇΩ</h3><small id="driver-total-earn">–≤—Å–µ–≥–æ: 0 ‚ÇΩ</small></div>
                    </div>
                </div>
                
                <div id="driver-messages-container"></div>
                
                <div class="d-flex gap-2 mx-3 my-3">
                    <button class="btn btn-primary flex-fill rounded-pill" onclick="switchDriverMode('city')"><i class="bi bi-building"></i> –ü–æ –≥–æ—Ä–æ–¥—É</button>
                    <button class="btn btn-outline-primary flex-fill rounded-pill" onclick="switchDriverMode('inter')"><i class="bi bi-route"></i> –ú–µ–∂–≥–æ—Ä–æ–¥</button>
                </div>
                
                <div id="driver-city-panel">
                    <div class="mobile-card">
                        <div class="timer-big mb-3" id="timer-display">00:00:00</div>
                        <button class="btn btn-success mobile-btn mb-2" id="shift-start-btn" onclick="startShift()"><i class="bi bi-play-fill"></i> –ù–∞—á–∞—Ç—å —Å–º–µ–Ω—É</button>
                        <button class="btn btn-warning mobile-btn mb-2 hidden" id="shift-end-btn" onclick="endShift()"><i class="bi bi-stop-fill"></i> –ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–º–µ–Ω—É</button>
                        <div class="mt-3"><textarea class="form-control rounded-4" id="shift-comment" rows="2" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."></textarea></div>
                        <div class="mt-3 p-3 rounded-4 text-center" id="geo-status-block"><span class="geo-inactive"><i class="bi bi-satellite"></i> –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞</span></div>
                    </div>
                </div>
                
                <div id="driver-inter-panel" class="hidden">
                    <div class="mobile-card">
                        <div class="mb-3"><input type="text" class="form-control form-control-lg rounded-pill" id="inter-direction" placeholder="–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ"></div>
                        <div class="mb-3"><input type="number" class="form-control form-control-lg rounded-pill" id="inter-sum" placeholder="–°—É–º–º–∞ —Å—Ç–∞–≤–∫–∏"></div>
                        <div class="mb-3"><textarea class="form-control rounded-4" id="inter-comment" rows="2" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."></textarea></div>
                        <button class="btn btn-warning mobile-btn" onclick="addIntercityTrip()"><i class="bi bi-truck"></i> –ü–æ–µ—Ö–∞–ª!</button>
                    </div>
                </div>
                
                <div class="mobile-card">
                    <h5 class="mb-3">–ú–æ–∏ –ø–æ–µ–∑–¥–∫–∏</h5>
                    <div style="max-height: 350px; overflow-y: auto;">
                        <table class="table table-sm">
                            <thead><tr><th>–î–∞—Ç–∞</th><th>–¢–∏–ø</th><th>–°—É–º–º–∞</th><th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th></tr></thead>
                            <tbody id="driver-trips-table"></tbody>
                        </table>
                    </div>
                </div>
                
                <div class="text-center mb-4">
                    <button class="btn btn-outline-secondary rounded-pill px-5" onclick="logout()"><i class="bi bi-box-arrow-right"></i> –í—ã–π—Ç–∏</button>
                </div>
            </div>
        </div>
        
        <!-- –ö–ê–ë–ò–ù–ï–¢ –ê–î–ú–ò–ù–ê (–î–ï–°–ö–¢–û–ü–ù–ê–Ø –í–ï–†–°–ò–Ø) -->
        <div id="admin-cabinet" class="hidden">
            <div class="desktop-container">
                <div class="app-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0"><i class="bi bi-shield-lock"></i> –ê–î–ú–ò–ù</h4>
                    <button class="btn btn-sm btn-light rounded-pill px-4" onclick="logout()"><i class="bi bi-box-arrow-right"></i></button>
                </div>
                
                <!-- –°–¢–ê–¢–ò–°–¢–ò–ö–ê -->
                <div class="row mx-2 my-3 g-2">
                    <div class="col-4"><div class="bg-primary text-white p-3 rounded-4 text-center"><small>–ê–∫—Ç–∏–≤–Ω—ã</small><h3 id="admin-active-count">0</h3></div></div>
                    <div class="col-4"><div class="bg-warning p-3 rounded-4 text-center"><small>–ù–∞ —Å–º–µ–Ω–µ</small><h3 id="admin-city-count">0</h3></div></div>
                    <div class="col-4"><div class="bg-success text-white p-3 rounded-4 text-center"><small>–ú–µ–∂–≥–æ—Ä–æ–¥</small><h3 id="admin-inter-count">0</h3></div></div>
                </div>
                
                <!-- –í–ö–õ–ê–î–ö–ò -->
                <div class="mobile-tabs">
                    <div class="mobile-tab active" onclick="switchAdminTab('drivers')">–ê–∫—Ç–∏–≤–Ω—ã–µ</div>
                    <div class="mobile-tab" onclick="switchAdminTab('all-drivers')">–í—Å–µ –≤–æ–¥–∏—Ç–µ–ª–∏</div>
                    <div class="mobile-tab" onclick="switchAdminTab('trips')">–ü–æ–µ–∑–¥–∫–∏</div>
                    <div class="mobile-tab" onclick="switchAdminTab('reports')">–û—Ç—á–µ—Ç—ã</div>
                    <div class="mobile-tab" onclick="switchAdminTab('archive')">–ê—Ä—Ö–∏–≤</div>
                    <div class="mobile-tab" onclick="switchAdminTab('settings')">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
                </div>
                
                <!-- –ê–ö–¢–ò–í–ù–´–ï –í–û–î–ò–¢–ï–õ–ò -->
                <div id="admin-drivers-tab">
                    <div class="desktop-row">
                        <div class="desktop-col">
                            <div class="desktop-card">
                                <h5 class="mb-3"><i class="bi bi-people-fill"></i> –ê–∫—Ç–∏–≤–Ω—ã–µ –≤–æ–¥–∏—Ç–µ–ª–∏</h5>
                                <div style="max-height: 400px; overflow-y: auto;">
                                    <table class="desktop-table">
                                        <thead><tr><th>–í–æ–¥–∏—Ç–µ–ª—å</th><th>–°—Ç–∞—Ç—É—Å</th><th>üìç</th><th>–ö–∞—Ä—Ç–∞</th><th>–ü–∞—Ä–æ–ª—å</th></tr></thead>
                                        <tbody id="admin-drivers-table-mobile"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <div class="desktop-col">
                            <div class="desktop-card">
                                <h5 class="mb-3"><i class="bi bi-chat-dots"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</h5>
                                <select class="form-select rounded-pill mb-2" id="message-driver-select"><option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤–æ–¥–∏—Ç–µ–ª—è</option></select>
                                <textarea class="form-control rounded-4 mb-2" id="message-text" rows="2" placeholder="–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è..."></textarea>
                                <button class="btn btn-primary mobile-btn" onclick="sendMessageToDriver()"><i class="bi bi-send"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                                <hr class="my-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6><i class="bi bi-envelope-check"></i> –°—Ç–∞—Ç—É—Å —Å–æ–æ–±—â–µ–Ω–∏–π</h6>
                                    <button class="btn btn-sm btn-outline-danger" onclick="clearAllMessages()"><i class="bi bi-trash"></i> –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ</button>
                                </div>
                                <div id="message-status-container" style="max-height: 300px; overflow-y: auto;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- –í–°–ï –í–û–î–ò–¢–ï–õ–ò -->
                <div id="admin-all-drivers-tab" class="hidden">
                    <div class="desktop-card">
                        <h5 class="mb-3"><i class="bi bi-database"></i> –í—Å–µ –≤–æ–¥–∏—Ç–µ–ª–∏</h5>
                        <div style="max-height: 500px; overflow-y: auto;">
                            <table class="desktop-table">
                                <thead><tr><th>–í–æ–¥–∏—Ç–µ–ª—å</th><th>–¢–µ–ª–µ—Ñ–æ–Ω</th><th>–ü–∞—Ä–æ–ª—å</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
                                <tbody id="admin-all-drivers-table"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- –ü–û–ï–ó–î–ö–ò -->
                <div id="admin-trips-tab" class="hidden">
                    <div class="desktop-card">
                        <h5 class="mb-3"><i class="bi bi-pencil-square"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–µ–∑–¥–æ–∫</h5>
                        <div style="max-height: 500px; overflow-y: auto;">
                            <table class="desktop-table">
                                <thead><tr><th>–í–æ–¥–∏—Ç–µ–ª—å</th><th>–î–∞—Ç–∞</th><th>–í—Ä–µ–º—è</th><th>–¢–∏–ø</th><th>–ß–∞—Å—ã</th><th>–°—É–º–º–∞</th><th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th><th></th></tr></thead>
                                <tbody id="admin-trips-table-mobile"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- –û–¢–ß–ï–¢–´ -->
                <div id="admin-reports-tab" class="hidden">
                    <div class="desktop-card">
                        <h5 class="mb-3 text-center"><i class="bi bi-calendar-check"></i> –û—Ç—á–µ—Ç –ø–æ –º–µ—Å—è—Ü–∞–º</h5>
                        
                        <div class="d-flex gap-2 mb-4">
                            <select class="form-select rounded-pill" id="report-month-select" onchange="loadAdminMonthReport()"><option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü</option></select>
                            <button class="btn btn-outline-primary rounded-pill px-4" onclick="loadAdminMonthReport()"><i class="bi bi-search"></i></button>
                        </div>
                        
                        <div class="report-tabs mb-3">
                            <div class="report-tab active" onclick="switchAdminReportTab('daily')"><i class="bi bi-list-ul"></i> –ö—Ç–æ –∫–æ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞–ª</div>
                            <div class="report-tab" onclick="switchAdminReportTab('summary')"><i class="bi bi-pie-chart"></i> –ò—Ç–æ–≥–∏ –ø–æ –≤–æ–¥–∏—Ç–µ–ª—è–º</div>
                        </div>
                        
                        <div id="admin-daily-report-container">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="fw-bold">–ü–æ–µ–∑–¥–∫–∏ –∑–∞ –º–µ—Å—è—Ü</h6>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-success" onclick="exportDailyReportToExcel()"><i class="bi bi-file-earmark-excel"></i></button>
                                    <button class="btn btn-sm btn-primary" onclick="printDailyReport()"><i class="bi bi-printer"></i></button>
                                </div>
                            </div>
                            <div id="admin-daily-report-content" style="max-height: 400px; overflow-y: auto;"></div>
                        </div>
                        
                        <div id="admin-summary-report-container" class="hidden">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="fw-bold">–°–≤–æ–¥–∫–∞ –ø–æ –≤–æ–¥–∏—Ç–µ–ª—è–º</h6>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-success" onclick="exportSummaryReportToExcel()"><i class="bi bi-file-earmark-excel"></i></button>
                                    <button class="btn btn-sm btn-primary" onclick="printSummaryReport()"><i class="bi bi-printer"></i></button>
                                </div>
                            </div>
                            <div id="admin-summary-report-content" style="max-height: 400px; overflow-y: auto;"></div>
                            
                            <div class="summary-card mt-3">
                                <div class="row g-2">
                                    <div class="col-6"><div class="summary-item"><small class="text-secondary">–í—Å–µ–≥–æ —á–∞—Å–æ–≤</small><h4 class="text-primary mb-0" id="admin-total-hours">0 —á</h4></div></div>
                                    <div class="col-6"><div class="summary-item"><small class="text-secondary">–í—Å–µ–≥–æ –ø–æ–µ–∑–¥–æ–∫ –ú–ì</small><h4 class="text-warning mb-0" id="admin-total-inter">0</h4></div></div>
                                    <div class="col-12 mt-2"><div class="summary-item bg-success bg-opacity-10"><small class="text-success">–û–ë–©–ò–ô –ó–ê–†–ê–ë–û–¢–û–ö</small><h3 class="text-success mb-0" id="admin-total-earn">0 ‚ÇΩ</h3></div></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <button class="btn btn-warning mobile-btn" onclick="closeMonth()"><i class="bi bi-file-earmark-check"></i> –ó–∞–∫—Ä—ã—Ç—å –º–µ—Å—è—Ü</button>
                        </div>
                    </div>
                </div>
                
                <!-- –ê–†–•–ò–í -->
                <div id="admin-archive-tab" class="hidden">
                    <div class="desktop-card">
                        <h5 class="mb-3"><i class="bi bi-archive"></i> –ê—Ä—Ö–∏–≤ –∑–∞–∫—Ä—ã—Ç—ã—Ö –º–µ—Å—è—Ü–µ–≤</h5>
                        
                        <div class="d-flex gap-2 mb-4">
                            <select class="form-select rounded-pill" id="admin-archive-month-select" onchange="loadAdminArchiveMonth()"><option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü</option></select>
                            <button class="btn btn-outline-primary rounded-pill px-4" onclick="loadAdminArchiveMonth()"><i class="bi bi-search"></i></button>
                            <button class="btn btn-outline-danger rounded-pill px-4" onclick="clearAllArchives()"><i class="bi bi-trash"></i></button>
                        </div>
                        
                        <div id="admin-archive-content" style="max-height: 500px; overflow-y: auto;"></div>
                    </div>
                </div>
                
                <!-- –ù–ê–°–¢–†–û–ô–ö–ò -->
                <div id="admin-settings-tab" class="hidden">
                    <div class="desktop-row">
                        <div class="desktop-col">
                            <div class="desktop-card">
                                <h5 class="mb-3"><i class="bi bi-tag"></i> –¢–∞—Ä–∏—Ñ –ø–æ –≥–æ—Ä–æ–¥—É</h5>
                                <div class="mb-3">
                                    <label class="form-label">–¢–µ–∫—É—â–∏–π —Ç–∞—Ä–∏—Ñ: <strong id="current-rate-label">1400 ‚ÇΩ/—á</strong></label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="admin-rate-input" value="1400" min="0" step="50">
                                        <button class="btn btn-success" onclick="updateRate()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                                    </div>
                                </div>
                                <div class="alert alert-info mt-2 mb-0 py-2">
                                    <small><i class="bi bi-info-circle"></i> –ù–æ–≤—ã–µ —Å–º–µ–Ω—ã —Å—á–∏—Ç–∞—é—Ç—Å—è –ø–æ –Ω–æ–≤–æ–º—É —Ç–∞—Ä–∏—Ñ—É</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="desktop-col">
                            <div class="desktop-card">
                                <h5 class="mb-3"><i class="bi bi-key"></i> –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª–µ–π</h5>
                                <div class="mb-3">
                                    <label class="form-label">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="admin-new-pass" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å">
                                        <button class="btn btn-warning" onclick="changeAdminPassword()">–ò–∑–º–µ–Ω–∏—Ç—å</button>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">–ö—É—Ä–∞—Ç–æ—Ä</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="curator-new-pass" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å">
                                        <button class="btn btn-outline-warning" onclick="changeCuratorPassword()">–ò–∑–º–µ–Ω–∏—Ç—å</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="desktop-col">
                            <div class="desktop-card">
                                <h5 class="mb-3"><i class="bi bi-cloud-arrow-up"></i> –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ</h5>
                                <button class="btn btn-outline-primary mobile-btn mb-2" onclick="exportBackup()"><i class="bi bi-download"></i> –°–∫–∞—á–∞—Ç—å –±–µ–∫–∞–ø</button>
                                <div class="mt-2">
                                    <label class="form-label">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –±–µ–∫–∞–ø–∞</label>
                                    <input type="file" class="form-control rounded-pill" id="backup-file" accept=".json">
                                    <button class="btn btn-outline-warning mobile-btn mt-2" onclick="importBackup()"><i class="bi bi-upload"></i> –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –ö–ê–ë–ò–ù–ï–¢ –ö–£–†–ê–¢–û–†–ê (–ú–û–ë–ò–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø) -->
        <div id="curator-cabinet" class="hidden">
            <div class="mobile-container">
                <div class="app-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0"><i class="bi bi-eye"></i> –ö–£–†–ê–¢–û–†</h4>
                    <button class="btn btn-sm btn-light rounded-pill px-4" onclick="logout()"><i class="bi bi-box-arrow-right"></i></button>
                </div>
                
                <div class="row mx-2 my-3 g-2">
                    <div class="col-4"><div class="bg-info text-white p-3 rounded-4 text-center"><small>–ê–∫—Ç–∏–≤–Ω—ã</small><h3 id="curator-active-count">0</h3></div></div>
                    <div class="col-4"><div class="bg-warning p-3 rounded-4 text-center"><small>–ù–∞ —Å–º–µ–Ω–µ</small><h3 id="curator-city-count">0</h3></div></div>
                    <div class="col-4"><div class="bg-success text-white p-3 rounded-4 text-center"><small>–ú–µ–∂–≥–æ—Ä–æ–¥</small><h3 id="curator-inter-count">0</h3></div></div>
                </div>
                
                <div class="mobile-card">
                    <h5 class="mb-3"><i class="bi bi-people"></i> –í–æ–¥–∏—Ç–µ–ª–∏ –Ω–∞ –ª–∏–Ω–∏–∏</h5>
                    <div style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-sm">
                            <thead><tr><th>–í–æ–¥–∏—Ç–µ–ª—å</th><th>–°—Ç–∞—Ç—É—Å</th><th>üìç</th><th>–ö–∞—Ä—Ç–∞</th></tr></thead>
                            <tbody id="curator-drivers-table"></tbody>
                        </table>
                    </div>
                </div>
                
                <div class="mobile-tabs">
                    <div class="mobile-tab active" onclick="switchCuratorTab('reports')">–û—Ç—á–µ—Ç—ã</div>
                    <div class="mobile-tab" onclick="switchCuratorTab('archive')">–ê—Ä—Ö–∏–≤</div>
                </div>
                
                <!-- –û–¢–ß–ï–¢–´ –ö–£–†–ê–¢–û–†–ê -->
                <div id="curator-reports-tab">
                    <div class="mobile-card">
                        <h5 class="mb-3 text-center"><i class="bi bi-calendar-check"></i> –û—Ç—á–µ—Ç –ø–æ –º–µ—Å—è—Ü–∞–º</h5>
                        
                        <div class="d-flex gap-2 mb-4">
                            <select class="form-select rounded-pill" id="curator-report-month" onchange="loadCuratorMonthReport()"><option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü</option></select>
                            <button class="btn btn-outline-primary rounded-pill px-4" onclick="loadCuratorMonthReport()"><i class="bi bi-search"></i></button>
                        </div>
                        
                        <div class="report-tabs mb-3">
                            <div class="report-tab active" onclick="switchCuratorReportTab('daily')"><i class="bi bi-list-ul"></i> –ö—Ç–æ –∫–æ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞–ª</div>
                            <div class="report-tab" onclick="switchCuratorReportTab('summary')"><i class="bi bi-pie-chart"></i> –ò—Ç–æ–≥–∏ –ø–æ –≤–æ–¥–∏—Ç–µ–ª—è–º</div>
                        </div>
                        
                        <div id="curator-daily-report-container">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="fw-bold">–ü–æ–µ–∑–¥–∫–∏ –∑–∞ –º–µ—Å—è—Ü</h6>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-success" onclick="exportCuratorDailyReportToExcel()"><i class="bi bi-file-earmark-excel"></i></button>
                                    <button class="btn btn-sm btn-primary" onclick="printCuratorDailyReport()"><i class="bi bi-printer"></i></button>
                                </div>
                            </div>
                            <div id="curator-daily-report-content" style="max-height: 400px; overflow-y: auto;"></div>
                        </div>
                        
                        <div id="curator-summary-report-container" class="hidden">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="fw-bold">–°–≤–æ–¥–∫–∞ –ø–æ –≤–æ–¥–∏—Ç–µ–ª—è–º</h6>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-success" onclick="exportCuratorSummaryReportToExcel()"><i class="bi bi-file-earmark-excel"></i></button>
                                    <button class="btn btn-sm btn-primary" onclick="printCuratorSummaryReport()"><i class="bi bi-printer"></i></button>
                                </div>
                            </div>
                            <div id="curator-summary-report-content" style="max-height: 400px; overflow-y: auto;"></div>
                            
                            <div class="summary-card mt-3">
                                <div class="row g-2">
                                    <div class="col-6"><div class="summary-item"><small class="text-secondary">–í—Å–µ–≥–æ —á–∞—Å–æ–≤</small><h4 class="text-primary mb-0" id="curator-total-hours">0 —á</h4></div></div>
                                    <div class="col-6"><div class="summary-item"><small class="text-secondary">–í—Å–µ–≥–æ –ø–æ–µ–∑–¥–æ–∫ –ú–ì</small><h4 class="text-warning mb-0" id="curator-total-inter">0</h4></div></div>
                                    <div class="col-12 mt-2"><div class="summary-item bg-success bg-opacity-10"><small class="text-success">–û–ë–©–ò–ô –ó–ê–†–ê–ë–û–¢–û–ö</small><h3 class="text-success mb-0" id="curator-total-earn">0 ‚ÇΩ</h3></div></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <button class="btn btn-warning mobile-btn" onclick="closeMonth()"><i class="bi bi-file-earmark-check"></i> –ó–∞–∫—Ä—ã—Ç—å –º–µ—Å—è—Ü</button>
                        </div>
                    </div>
                </div>
                
                <div id="curator-archive-tab" class="hidden">
                    <div class="mobile-card">
                        <h5><i class="bi bi-archive"></i> –ê—Ä—Ö–∏–≤ –∑–∞–∫—Ä—ã—Ç—ã—Ö –º–µ—Å—è—Ü–µ–≤</h5>
                        <div class="d-flex gap-2 mb-4">
                            <select class="form-select rounded-pill" id="curator-archive-month-select" onchange="loadCuratorArchiveMonth()"><option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü</option></select>
                            <button class="btn btn-outline-primary rounded-pill px-4" onclick="loadCuratorArchiveMonth()"><i class="bi bi-search"></i></button>
                        </div>
                        <div id="curator-archive-content" style="max-height: 500px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –ö–ê–†–¢–ê -->
        <div id="map-modal" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); z-index: 2000;">
            <div style="padding: 16px; background: #0f5e7e; color: white; display: flex; justify-content: space-between;">
                <h5 class="mb-0" id="map-driver-name"></h5>
                <button class="btn btn-sm btn-light rounded-pill px-4" onclick="closeMap()"><i class="bi bi-x-lg"></i> –ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
            <div id="driver-map" style="height: 90vh; width: 100%;"></div>
        </div>
    </div>

    <script>
        // üî• –¢–í–û–ò FIREBASE –ö–õ–Æ–ß–ò!
        const firebaseConfig = {
            apiKey: "AIzaSyASdFFIJbPOvGCs0IP66pojpFfCO1FU81A",
            authDomain: "shintorg86-crm.firebaseapp.com",
            projectId: "shintorg86-crm",
            storageBucket: "shintorg86-crm.firebasestorage.app",
            messagingSenderId: "501323511960",
            appId: "1:501323511960:web:0cb6d55502d82aaf58f8ed"
        };

        // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø FIREBASE
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // ============ –ì–õ–û–ë–ê–õ–¨–ù–´–ï –î–ê–ù–ù–´–ï ============
        let LOCAL_DRIVERS = [];
        let LOCAL_TRIPS = [];
        let LOCAL_MESSAGES = [];
        let LOCAL_ARCHIVE = [];
        
        // –£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        let ADMIN_CRED = { login: 'admin', password: 'adminshintorg86' };
        let CURATOR_CRED = { login: 'curator', password: 'curator123' };
        const SECRET_ADMIN_KEY = 'shintorg2024super';
        
        // –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        let currentUser = null;
        let currentRole = null;
        let currentRate = 1400;
        
        // –°–º–µ–Ω–∞
        let shiftActive = false;
        let shiftStartTime = null;
        let shiftTimer = null;
        let geoWatchId = null;
        let currentMap = null;
        let mapMarker = null;
        
        // –ü–æ–¥–ø–∏—Å–∫–∏ Firebase
        let unsubscribeDrivers = null;
        let unsubscribeTrips = null;
        let unsubscribeMessages = null;
        let unsubscribeArchive = null;
        
        // –¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤
        let currentReportMonth = null;
        
        // ============ –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï –î–ê–¢–´ ============
        function formatDate(dateString) {
            if (!dateString) return '';
            const parts = dateString.split('-');
            if (parts.length === 3) {
                return `${parts[2]}.${parts[1]}.${parts[0].slice(2)}`;
            }
            return dateString;
        }
        
        function formatDateTimeRange(startTime, endTime) {
            if (!startTime) return '';
            const start = new Date(startTime);
            const end = endTime ? new Date(endTime) : new Date();
            const startStr = `${start.getHours().toString().padStart(2,'0')}:${start.getMinutes().toString().padStart(2,'0')}`;
            const endStr = endTime ? `${end.getHours().toString().padStart(2,'0')}:${end.getMinutes().toString().padStart(2,'0')}` : '';
            return endStr ? `${startStr}-${endStr}` : startStr;
        }
        
        // ============ –ó–ê–ì–†–£–ó–ö–ê –ò–ó FIREBASE ============
        async function loadFromFirebase() {
            try {
                const driversSnapshot = await db.collection('drivers').get();
                LOCAL_DRIVERS = [];
                driversSnapshot.forEach(doc => { LOCAL_DRIVERS.push({ id: doc.id, ...doc.data() }); });
                
                const tripsSnapshot = await db.collection('trips').orderBy('date', 'desc').get();
                LOCAL_TRIPS = [];
                tripsSnapshot.forEach(doc => { LOCAL_TRIPS.push({ id: doc.id, ...doc.data() }); });
                
                const messagesSnapshot = await db.collection('messages').get();
                LOCAL_MESSAGES = [];
                messagesSnapshot.forEach(doc => { LOCAL_MESSAGES.push({ id: doc.id, ...doc.data() }); });
                
                const archiveSnapshot = await db.collection('archive').orderBy('month', 'desc').get();
                LOCAL_ARCHIVE = [];
                archiveSnapshot.forEach(doc => { LOCAL_ARCHIVE.push({ id: doc.id, ...doc.data() }); });
            } catch (error) { console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ Firebase:', error); }
        }
        
        // ============ –ü–û–î–ü–ò–°–ö–ò –ù–ê –û–ë–ù–û–í–õ–ï–ù–ò–Ø ============
        function subscribeToDrivers() {
            if (unsubscribeDrivers) unsubscribeDrivers();
            unsubscribeDrivers = db.collection('drivers').onSnapshot((snapshot) => {
                LOCAL_DRIVERS = [];
                snapshot.forEach(doc => { LOCAL_DRIVERS.push({ id: doc.id, ...doc.data() }); });
                if (currentRole === 'admin') { 
                    loadAdminDrivers(); 
                    loadAllDrivers(); 
                    loadMessageDriversList(); 
                }
                else if (currentRole === 'curator') { 
                    loadCuratorDrivers(); 
                    document.getElementById('curator-active-count').innerHTML = LOCAL_DRIVERS.filter(d => d.status === 'active').length;
                    document.getElementById('curator-city-count').innerHTML = LOCAL_DRIVERS.filter(d => d.status === 'active' && d.shiftType === 'city').length;
                    document.getElementById('curator-inter-count').innerHTML = LOCAL_DRIVERS.filter(d => d.status === 'active' && d.shiftType === 'intercity').length;
                }
            });
        }
        
        function subscribeToTrips() {
            if (unsubscribeTrips) unsubscribeTrips();
            unsubscribeTrips = db.collection('trips').orderBy('date', 'desc').onSnapshot((snapshot) => {
                LOCAL_TRIPS = [];
                snapshot.forEach(doc => { LOCAL_TRIPS.push({ id: doc.id, ...doc.data() }); });
                if (currentRole === 'admin') { 
                    loadAdminTrips(); 
                    loadAdminReports(); 
                }
                else if (currentRole === 'curator') { 
                    loadCuratorReports(); 
                }
                if (currentRole === 'driver' && currentUser) { 
                    loadDriverData(); 
                }
            });
        }
        
        function subscribeToMessages() {
            if (unsubscribeMessages) unsubscribeMessages();
            unsubscribeMessages = db.collection('messages').orderBy('timestamp', 'desc').onSnapshot((snapshot) => {
                LOCAL_MESSAGES = [];
                snapshot.forEach(doc => { LOCAL_MESSAGES.push({ id: doc.id, ...doc.data() }); });
                if (currentRole === 'driver' && currentUser) { 
                    checkDriverMessages(); 
                }
                if (currentRole === 'admin') { 
                    loadMessageStatus(); 
                }
            });
        }
        
        function subscribeToArchive() {
            if (unsubscribeArchive) unsubscribeArchive();
            unsubscribeArchive = db.collection('archive').orderBy('month', 'desc').onSnapshot((snapshot) => {
                LOCAL_ARCHIVE = [];
                snapshot.forEach(doc => { LOCAL_ARCHIVE.push({ id: doc.id, ...doc.data() }); });
                if (currentRole === 'admin') { 
                    loadArchiveList(); 
                    updateArchiveSelectors(); 
                }
                else if (currentRole === 'curator') { 
                    loadCuratorArchiveList(); 
                    updateArchiveSelectors(); 
                }
            });
        }
        
        // ============ –°–û–•–†–ê–ù–ï–ù–ò–ï –°–ï–°–°–ò–ò ============
        function saveSession() { 
            if (currentUser && currentRole) { 
                localStorage.setItem('shintorg_current_user', JSON.stringify(currentUser)); 
                localStorage.setItem('shintorg_current_role', currentRole); 
            } 
        }
        
        async function loadSession() {
            const savedUser = localStorage.getItem('shintorg_current_user');
            const savedRole = localStorage.getItem('shintorg_current_role');
            if (savedUser && savedRole) {
                currentUser = JSON.parse(savedUser);
                currentRole = savedRole;
                await loadFromFirebase();
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('login-screen').classList.add('hidden');
                
                if (currentRole === 'driver') {
                    document.getElementById('driver-cabinet').classList.remove('hidden');
                    document.getElementById('driver-name-badge').innerHTML = `<i class="bi bi-person-circle"></i> ${currentUser.short || currentUser.name}`;
                    loadDriverData(); 
                    checkDriverMessages();
                    if (currentUser.status === 'active' && currentUser.shiftType === 'city') {
                        shiftActive = true; 
                        shiftStartTime = currentUser.shiftStartTime ? new Date(currentUser.shiftStartTime) : new Date();
                        document.getElementById('shift-start-btn').classList.add('hidden'); 
                        document.getElementById('shift-end-btn').classList.remove('hidden');
                        startShiftTimer(); 
                        startGeolocation();
                    }
                } else if (currentRole === 'admin') {
                    document.getElementById('admin-cabinet').classList.remove('hidden');
                    subscribeToDrivers(); 
                    subscribeToTrips(); 
                    subscribeToMessages(); 
                    subscribeToArchive();
                    loadAdminData();
                } else if (currentRole === 'curator') {
                    document.getElementById('curator-cabinet').classList.remove('hidden');
                    subscribeToDrivers(); 
                    subscribeToTrips(); 
                    subscribeToArchive();
                    loadCuratorData();
                }
                return true;
            }
            return false;
        }
        
        // ============ –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ============
        window.switchLoginTab = function(tab) {
            document.querySelectorAll('#login-tabs .mobile-tab').forEach(el => el.classList.remove('active'));
            if (tab === 'driver') {
                document.querySelector('#login-tabs .mobile-tab:nth-child(1)').classList.add('active');
                document.getElementById('driver-login-panel').classList.remove('hidden');
                document.getElementById('admin-login-panel').classList.add('hidden');
                document.getElementById('curator-login-panel').classList.add('hidden');
            } else if (tab === 'admin') {
                document.querySelector('#login-tabs .mobile-tab:nth-child(2)').classList.add('active');
                document.getElementById('driver-login-panel').classList.add('hidden');
                document.getElementById('admin-login-panel').classList.remove('hidden');
                document.getElementById('curator-login-panel').classList.add('hidden');
            } else if (tab === 'curator') {
                document.querySelector('#login-tabs .mobile-tab:nth-child(3)').classList.add('active');
                document.getElementById('driver-login-panel').classList.add('hidden');
                document.getElementById('admin-login-panel').classList.add('hidden');
                document.getElementById('curator-login-panel').classList.remove('hidden');
            }
        };
        
        window.loginDriver = async function() {
            const phone = document.getElementById('driver-login').value;
            const pass = document.getElementById('driver-password').value;
            try {
                const query = await db.collection('drivers').where('phone', '==', phone).where('password', '==', pass).get();
                if (!query.empty) {
                    const driverData = query.docs[0].data();
                    driverData.id = query.docs[0].id;
                    currentUser = driverData; 
                    currentRole = 'driver';
                    saveSession();
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('driver-cabinet').classList.remove('hidden');
                    document.getElementById('driver-name-badge').innerHTML = `<i class="bi bi-person-circle"></i> ${driverData.short || driverData.name}`;
                    subscribeToTrips(); 
                    subscribeToMessages();
                    if (driverData.status === 'active' && driverData.shiftType === 'city') {
                        shiftActive = true; 
                        shiftStartTime = driverData.shiftStartTime ? new Date(driverData.shiftStartTime) : new Date();
                        document.getElementById('shift-start-btn').classList.add('hidden'); 
                        document.getElementById('shift-end-btn').classList.remove('hidden');
                        startShiftTimer(); 
                        startGeolocation();
                    }
                    loadDriverData(); 
                    checkDriverMessages();
                    alert(`‚úÖ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${driverData.short || driverData.name}`);
                } else { 
                    alert('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å'); 
                }
            } catch (error) { 
                console.error('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:', error); 
                alert('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É'); 
            }
        };
        
        window.loginAdmin = function() {
            const login = document.getElementById('admin-login').value;
            const pass = document.getElementById('admin-password').value;
            if (login === ADMIN_CRED.login && pass === ADMIN_CRED.password) {
                currentRole = 'admin'; 
                currentUser = { login: ADMIN_CRED.login, name: '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' };
                saveSession();
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('admin-cabinet').classList.remove('hidden');
                subscribeToDrivers(); 
                subscribeToTrips(); 
                subscribeToMessages(); 
                subscribeToArchive();
                loadAdminData();
                alert('‚úÖ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä');
            } else { 
                alert('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å'); 
            }
        };
        
        window.loginCurator = function() {
            const login = document.getElementById('curator-login').value;
            const pass = document.getElementById('curator-password').value;
            if (login === CURATOR_CRED.login && pass === CURATOR_CRED.password) {
                currentRole = 'curator'; 
                currentUser = { login: CURATOR_CRED.login, name: '–ö—É—Ä–∞—Ç–æ—Ä' };
                saveSession();
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('curator-cabinet').classList.remove('hidden');
                subscribeToDrivers(); 
                subscribeToTrips(); 
                subscribeToArchive();
                loadCuratorData();
                alert('‚úÖ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –ö—É—Ä–∞—Ç–æ—Ä');
            } else { 
                alert('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å'); 
            }
        };
        
        // ============ –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø ============
        window.registerDriver = async function() {
            const name = document.getElementById('reg-name').value;
            const phone = document.getElementById('reg-phone').value;
            const pass = document.getElementById('reg-pass').value;
            if (!name || !phone || !pass) { 
                alert('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è'); 
                return; 
            }
            try {
                const existing = await db.collection('drivers').where('phone', '==', phone).get();
                if (!existing.empty) { 
                    alert('‚ùå –≠—Ç–æ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω'); 
                    return; 
                }
                const nameParts = name.split(' ');
                let short = nameParts[0];
                if (nameParts.length > 1) short += ' ' + nameParts[1][0] + '.';
                if (nameParts.length > 2) short += nameParts[2][0] + '.';
                const newDriver = {
                    name, short, phone, password: pass,
                    status: 'offline', shiftType: null, shiftStartTime: null,
                    location: '', lat: null, lng: null, lastSeen: null,
                    registeredAt: new Date().toISOString().split('T')[0]
                };
                await db.collection('drivers').add(newDriver);
                alert('‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ.');
                backToLogin();
            } catch (error) { 
                console.error('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', error); 
                alert('‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏'); 
            }
        };
        
        // ============ –ì–ï–û–õ–û–ö–ê–¶–ò–Ø ============
        async function updateDriverLocation(lat, lng) {
            if (!currentUser || !currentUser.id) return;
            try {
                await db.collection('drivers').doc(currentUser.id).update({ 
                    lat, lng, 
                    location: `${lat.toFixed(6)}, ${lng.toFixed(6)}`, 
                    lastSeen: new Date().toISOString() 
                });
                currentUser.lat = lat; 
                currentUser.lng = lng; 
                saveSession();
            } catch (error) { 
                console.error('–û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏:', error); 
            }
        }
        
        function startGeolocation() {
            if (!currentUser || !currentUser.id || !navigator.geolocation) return;
            if (geoWatchId) navigator.geolocation.clearWatch(geoWatchId);
            geoWatchId = navigator.geolocation.watchPosition(
                (position) => { 
                    const lat = position.coords.latitude; 
                    const lng = position.coords.longitude; 
                    updateDriverLocation(lat, lng); 
                    document.getElementById('geo-status-block').innerHTML = `<span class="geo-active"><i class="bi bi-satellite"></i> üü¢ ${lat.toFixed(4)}, ${lng.toFixed(4)}</span>`; 
                },
                (error) => { 
                    document.getElementById('geo-status-block').innerHTML = `<span class="geo-inactive"><i class="bi bi-satellite"></i> üî¥ –û—à–∏–±–∫–∞</span>`; 
                },
                { enableHighAccuracy: true, maximumAge: 5000, timeout: 10000 }
            );
        }
        
        // ============ –ö–ê–†–¢–ê ============
        window.showDriverMap = async function(driverId, driverName) {
            try {
                const doc = await db.collection('drivers').doc(driverId).get();
                const driver = doc.data();
                if (!driver || !driver.lat || !driver.lng) { 
                    alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏'); 
                    return; 
                }
                document.getElementById('map-modal').classList.remove('hidden');
                document.getElementById('map-driver-name').innerHTML = `<i class="bi bi-geo-alt-fill"></i> ${driverName}`;
                setTimeout(() => {
                    if (currentMap) currentMap.remove();
                    currentMap = L.map('driver-map').setView([driver.lat, driver.lng], 15);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(currentMap);
                    if (mapMarker) mapMarker.remove();
                    mapMarker = L.marker([driver.lat, driver.lng]).addTo(currentMap).bindPopup(`<b>${driver.short || driver.name}</b>`).openPopup();
                }, 100);
            } catch (error) { 
                console.error('–û—à–∏–±–∫–∞ –∫–∞—Ä—Ç—ã:', error); 
                alert('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã'); 
            }
        };
        
        window.closeMap = function() { 
            document.getElementById('map-modal').classList.add('hidden'); 
            if (currentMap) { 
                currentMap.remove(); 
                currentMap = null; 
            } 
        };
        
        // ============ –°–ú–ï–ù–ê - –ò–°–ü–†–ê–í–õ–ï–ù–û! ============
        window.startShift = async function() {
            if (!currentUser || !currentUser.id) {
                alert('–û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }
            shiftActive = true; 
            shiftStartTime = new Date();
            try {
                await db.collection('drivers').doc(currentUser.id).update({ 
                    status: 'active', 
                    shiftType: 'city', 
                    shiftStartTime: shiftStartTime.toISOString() 
                });
                currentUser.status = 'active'; 
                currentUser.shiftType = 'city'; 
                currentUser.shiftStartTime = shiftStartTime.toISOString(); 
                saveSession();
                document.getElementById('shift-start-btn').classList.add('hidden'); 
                document.getElementById('shift-end-btn').classList.remove('hidden');
                startShiftTimer(); 
                startGeolocation();
                alert('üöï –°–º–µ–Ω–∞ –Ω–∞—á–∞—Ç–∞!');
            } catch (error) { 
                console.error('–û—à–∏–±–∫–∞ –Ω–∞—á–∞–ª–∞ —Å–º–µ–Ω—ã:', error); 
                alert('‚ùå –û—à–∏–±–∫–∞ –Ω–∞—á–∞–ª–∞ —Å–º–µ–Ω—ã'); 
            }
        };
        
        window.endShift = async function() {
            if (!shiftActive || !currentUser || !currentUser.id) {
                alert('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π —Å–º–µ–Ω—ã');
                return;
            }
            
            try {
                // –†–∞—Å—á—ë—Ç —á–∞—Å–æ–≤
                const seconds = Math.floor((new Date() - shiftStartTime) / 1000);
                let hours = seconds / 3600;
                let whole = Math.floor(hours);
                let mins = (hours - whole) * 60;
                if (mins < 15) hours = whole;
                else if (mins < 45) hours = whole + 0.5;
                else hours = whole + 1;
                if (hours < 1) hours = 1;
                
                // ‚úÖ –ò–°–ü–û–õ–¨–ó–£–ï–ú –ê–ö–¢–£–ê–õ–¨–ù–´–ô –¢–ê–†–ò–§
                const earn = Math.round(hours * currentRate);
                const comment = document.getElementById('shift-comment').value || '';
                
                // –°–æ–∑–¥–∞—ë–º –ø–æ–µ–∑–¥–∫—É
                const newTrip = {
                    id: Date.now().toString(),
                    driverId: currentUser.phone,
                    driverName: currentUser.short || currentUser.name,
                    date: new Date().toISOString().split('T')[0],
                    type: '–≥–æ—Ä–æ–¥',
                    hours: hours,
                    earn: earn,
                    comment: comment,
                    startTime: shiftStartTime.toISOString(),
                    endTime: new Date().toISOString(),
                    location: currentUser.location || '',
                    timestamp: new Date().toISOString()
                };
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
                LOCAL_TRIPS.push(newTrip);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤–æ–¥–∏—Ç–µ–ª—è
                const driver = LOCAL_DRIVERS.find(d => d.phone === currentUser.phone);
                if (driver) {
                    driver.status = 'offline';
                    driver.shiftType = null;
                    driver.shiftStartTime = null;
                    saveToStorage();
                }
                
                currentUser.status = 'offline';
                currentUser.shiftType = null;
                currentUser.shiftStartTime = null;
                saveSession();
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é
                if (geoWatchId) { 
                    navigator.geolocation.clearWatch(geoWatchId); 
                    geoWatchId = null; 
                }
                
                shiftActive = false;
                clearInterval(shiftTimer);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                document.getElementById('timer-display').innerText = '00:00:00';
                document.getElementById('shift-start-btn').classList.remove('hidden');
                document.getElementById('shift-end-btn').classList.add('hidden');
                document.getElementById('shift-comment').value = '';
                document.getElementById('geo-status-block').innerHTML = '<span class="geo-inactive"><i class="bi bi-satellite"></i> –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞</span>';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É –ø–æ–µ–∑–¥–æ–∫
                loadDriverData();
                
                alert(`‚úÖ –°–º–µ–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ: ${earn} ‚ÇΩ`);
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Firebase (–≤ —Ñ–æ–Ω–µ)
                try {
                    await db.collection('trips').add({
                        driverId: currentUser.phone,
                        driverName: currentUser.short || currentUser.name,
                        date: newTrip.date,
                        type: '–≥–æ—Ä–æ–¥',
                        hours: hours,
                        earn: earn,
                        comment: comment,
                        startTime: shiftStartTime.toISOString(),
                        endTime: new Date().toISOString(),
                        timestamp: new Date().toISOString()
                    });
                    
                    await db.collection('drivers').doc(currentUser.id).update({ 
                        status: 'offline', 
                        shiftType: null, 
                        shiftStartTime: null 
                    });
                    
                } catch (error) { 
                    console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Firebase:', error);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–º–µ–Ω—ã:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–º–µ–Ω—ã');
            }
        };
        
        // ============ –ú–ï–ñ–ì–û–†–û–î - –ò–°–ü–†–ê–í–õ–ï–ù–û! ============
        window.addIntercityTrip = async function() {
            if (!currentUser || !currentUser.id) {
                alert('–û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }
            
            try {
                const direction = document.getElementById('inter-direction').value || '–ú–µ–∂–≥–æ—Ä–æ–¥';
                const sum = parseFloat(document.getElementById('inter-sum').value);
                if (!sum || sum <= 0) { 
                    alert('‚ùå –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É —Å—Ç–∞–≤–∫–∏'); 
                    return; 
                }
                const comment = document.getElementById('inter-comment').value || '';
                
                const newTrip = {
                    id: Date.now().toString(),
                    driverId: currentUser.phone,
                    driverName: currentUser.short || currentUser.name,
                    date: new Date().toISOString().split('T')[0],
                    type: '–º–µ–∂–≥–æ—Ä–æ–¥',
                    direction: direction,
                    earn: sum,
                    comment: comment,
                    timestamp: new Date().toISOString()
                };
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
                LOCAL_TRIPS.push(newTrip);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É
                loadDriverData();
                
                // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
                document.getElementById('inter-direction').value = ''; 
                document.getElementById('inter-sum').value = ''; 
                document.getElementById('inter-comment').value = '';
                
                alert(`üöõ –†–µ–π—Å –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω! ${sum} ‚ÇΩ`);
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Firebase (–≤ —Ñ–æ–Ω–µ)
                try {
                    await db.collection('trips').add({
                        driverId: currentUser.phone,
                        driverName: currentUser.short || currentUser.name,
                        date: newTrip.date,
                        type: '–º–µ–∂–≥–æ—Ä–æ–¥',
                        direction: direction,
                        earn: sum,
                        comment: comment,
                        timestamp: new Date().toISOString()
                    });
                } catch (error) { 
                    console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–µ–π—Å–∞:', error); 
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–µ–π—Å–∞');
            }
        };
        
        // ============ –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• –í–û–î–ò–¢–ï–õ–Ø ============
        function loadDriverData() {
            if (!currentUser) return;
            const driverTrips = LOCAL_TRIPS.filter(t => t.driverId === currentUser.phone);
            const today = new Date().toISOString().split('T')[0];
            const month = today.slice(0, 7);
            const todayTrips = driverTrips.filter(t => t.date === today);
            const todayEarn = todayTrips.reduce((s, t) => s + (t.earn || 0), 0);
            const todayHours = todayTrips.filter(t => t.type === '–≥–æ—Ä–æ–¥').reduce((s, t) => s + (t.hours || 0), 0);
            const monthTrips = driverTrips.filter(t => t.date.startsWith(month));
            const monthEarn = monthTrips.reduce((s, t) => s + (t.earn || 0), 0);
            const totalEarn = driverTrips.reduce((s, t) => s + (t.earn || 0), 0);
            document.getElementById('driver-today-earn').innerHTML = `${todayEarn} ‚ÇΩ`;
            document.getElementById('driver-today-hours').innerHTML = `${todayHours.toFixed(1)} —á`;
            document.getElementById('driver-month-earn').innerHTML = `${monthEarn} ‚ÇΩ`;
            document.getElementById('driver-total-earn').innerHTML = `–≤—Å–µ–≥–æ: ${totalEarn} ‚ÇΩ`;
            
            let html = '';
            driverTrips.slice().reverse().forEach(trip => {
                const dateStr = formatDate(trip.date);
                html += `<tr>
                    <td>${dateStr}</td>
                    <td><span class="badge ${trip.type === '–≥–æ—Ä–æ–¥' ? 'bg-primary' : 'bg-warning'}">${trip.type}</span></td>
                    <td>${trip.earn} ‚ÇΩ</td>
                    <td><small>${trip.comment || ''}</small></td>
                </tr>`;
            });
            document.getElementById('driver-trips-table').innerHTML = html || '<tr><td colspan="4" class="text-center">–ù–µ—Ç –ø–æ–µ–∑–¥–æ–∫</td></tr>';
        }
        
        // ============ –°–û–û–ë–©–ï–ù–ò–Ø ============
        function checkDriverMessages() {
            if (!currentUser) return;
            const messages = LOCAL_MESSAGES.filter(m => m.driverPhone === currentUser.phone && !m.read);
            if (messages.length > 0) {
                let html = '';
                messages.forEach(msg => {
                    html += `<div class="message-bubble" id="message-${msg.id}">
                        <div class="d-flex justify-content-between">
                            <strong><i class="bi bi-envelope-fill"></i> –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∞–¥–º–∏–Ω–∞</strong>
                            <small>${msg.time || ''}</small>
                        </div>
                        <p class="mb-2 mt-2">${msg.text}</p>
                        <button class="btn btn-sm btn-outline-primary rounded-pill px-4" onclick="markMessageRead('${msg.id}')">
                            <i class="bi bi-check2-all"></i> –ü—Ä–æ—á–∏—Ç–∞–Ω–æ
                        </button>
                    </div>`;
                });
                document.getElementById('driver-messages-container').innerHTML = html;
            } else {
                document.getElementById('driver-messages-container').innerHTML = '';
            }
        }
        
        window.markMessageRead = async function(messageId) {
            try {
                await db.collection('messages').doc(messageId).update({ 
                    read: true, 
                    readAt: new Date().toISOString() 
                });
                const messageElement = document.getElementById(`message-${messageId}`);
                if (messageElement) messageElement.remove();
            } catch (error) { 
                console.error('–û—à–∏–±–∫–∞:', error); 
            }
        };
        
        window.sendMessageToDriver = async function() {
            const driverPhone = document.getElementById('message-driver-select').value;
            const text = document.getElementById('message-text').value;
            if (!driverPhone || !text) { 
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –≤–æ–¥–∏—Ç–µ–ª—è –∏ –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç'); 
                return; 
            }
            try {
                await db.collection('messages').add({
                    driverPhone, 
                    text, 
                    time: new Date().toLocaleTimeString().slice(0,5),
                    read: false, 
                    readAt: null, 
                    timestamp: new Date().toISOString()
                });
                document.getElementById('message-text').value = '';
                alert('‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
            } catch (error) { 
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error); 
                alert('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏'); 
            }
        };
        
        function loadMessageStatus() {
            let html = '';
            LOCAL_MESSAGES.slice().reverse().forEach(msg => {
                const driver = LOCAL_DRIVERS.find(d => d.phone === msg.driverPhone);
                const status = msg.read ? `<span class="badge bg-success">‚úÖ –ü—Ä–æ—á–∏—Ç–∞–Ω–æ</span>` : `<span class="badge bg-warning">‚è≥ –û–∂–∏–¥–∞–µ—Ç</span>`;
                html += `<div class="message-status-item">
                    <button class="btn btn-sm btn-outline-danger delete-msg-btn" onclick="deleteMessage('${msg.id}')"><i class="bi bi-trash"></i></button>
                    <div><strong>${driver?.short || msg.driverPhone}</strong> ${status}</div>
                    <div class="text-secondary">${msg.text}</div>
                    <small class="text-muted">${msg.time || ''}</small>
                </div>`;
            });
            document.getElementById('message-status-container').innerHTML = html || '<p class="text-center">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</p>';
        }
        
        window.deleteMessage = async function(messageId) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ?')) {
                try {
                    await db.collection('messages').doc(messageId).delete();
                    alert('‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ');
                } catch (error) { 
                    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error); 
                    alert('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è'); 
                }
            }
        };
        
        window.clearAllMessages = async function() {
            if (confirm('‚ö†Ô∏è –£–¥–∞–ª–∏—Ç—å –í–°–ï —Å–æ–æ–±—â–µ–Ω–∏—è? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
                try {
                    const snapshot = await db.collection('messages').get();
                    snapshot.forEach(async (doc) => { await doc.ref.delete(); });
                    alert('‚úÖ –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω—ã');
                } catch (error) { 
                    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error); 
                    alert('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è'); 
                }
            }
        };
        
        // ============ –ê–î–ú–ò–ù ============
        function loadAdminData() {
            document.getElementById('admin-rate-input').value = currentRate;
            document.getElementById('current-rate-label').innerHTML = `${currentRate} ‚ÇΩ/—á`;
            loadAdminDrivers(); 
            loadAllDrivers(); 
            loadAdminTrips(); 
            loadAdminReports(); 
            loadArchiveList();
            loadMessageDriversList(); 
            loadMessageStatus();
            updateMonthSelectors(); 
            updateArchiveSelectors();
        }
        
        function loadAdminDrivers() {
            let html = ''; 
            let active = 0, city = 0, inter = 0;
            LOCAL_DRIVERS.forEach(driver => {
                if (driver.status === 'active') { 
                    active++; 
                    if (driver.shiftType === 'city') city++; 
                    if (driver.shiftType === 'intercity') inter++; 
                }
                let statusText = '‚ö™ –û—Ñ–ª–∞–π–Ω'; 
                let statusClass = 'status-offline';
                if (driver.status === 'active') {
                    if (driver.shiftType === 'city') { 
                        statusText = 'üèôÔ∏è –†–∞–±–æ—Ç–∞–µ—Ç'; 
                        statusClass = 'status-working'; 
                    }
                    else if (driver.shiftType === 'intercity') { 
                        statusText = 'üõ£Ô∏è –ú–µ–∂–≥–æ—Ä–æ–¥'; 
                        statusClass = 'status-intercity'; 
                    }
                }
                const hasGeo = driver.lat && driver.lng && driver.status === 'active';
                html += `<tr>
                    <td><div class="fw-bold">${driver.short || driver.name}</div><small class="text-secondary">${driver.phone}</small></td>
                    <td><span class="${statusClass} px-3 py-2">${statusText}</span></td>
                    <td>${hasGeo ? `<span class="text-success"><i class="bi bi-geo-alt-fill"></i> –î–≤–∏–∂–µ—Ç—Å—è</span>` : '‚Äî'}</td>
                    <td>${hasGeo ? `<button class="btn btn-sm btn-outline-info" onclick="showDriverMap('${driver.id}', '${driver.short || driver.name}')"><i class="bi bi-map"></i></button>` : '‚Äî'}</td>
                    <td><div class="d-flex align-items-center gap-1"><span class="text-monospace" id="pass-${driver.phone}">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span><button class="btn btn-sm btn-link" onclick="togglePasswordVisibility('${driver.phone}')"><i class="bi bi-eye"></i></button><button class="btn btn-sm btn-outline-primary" onclick="editDriverPassword('${driver.id}')"><i class="bi bi-pencil"></i></button></div></td>
                </tr>`;
            });
            document.getElementById('admin-drivers-table-mobile').innerHTML = html || '<tr><td colspan="5" class="text-center">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤–æ–¥–∏—Ç–µ–ª–µ–π</td></tr>';
            document.getElementById('admin-active-count').innerHTML = active; 
            document.getElementById('admin-city-count').innerHTML = city; 
            document.getElementById('admin-inter-count').innerHTML = inter;
        }
        
        function loadAllDrivers() {
            let html = '';
            LOCAL_DRIVERS.forEach(driver => {
                html += `<tr>
                    <td><div class="fw-bold">${driver.short || driver.name}</div><small class="text-secondary">${driver.phone}</small></td>
                    <td>${driver.phone}</td>
                    <td><div class="d-flex align-items-center gap-1"><span class="text-monospace" id="all-pass-${driver.phone}">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span><button class="btn btn-sm btn-link" onclick="toggleAllPasswordVisibility('${driver.phone}')"><i class="bi bi-eye"></i></button></div></td>
                    <td><span class="${driver.status === 'active' ? 'status-working' : 'status-offline'} px-3 py-2">${driver.status === 'active' ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–û—Ñ–ª–∞–π–Ω'}</span></td>
                    <td><button class="btn btn-sm btn-outline-primary" onclick="editDriverPassword('${driver.id}')"><i class="bi bi-pencil"></i></button><button class="btn btn-sm btn-outline-danger" onclick="deleteDriver('${driver.id}')"><i class="bi bi-trash"></i></button></td>
                </tr>`;
            });
            document.getElementById('admin-all-drivers-table').innerHTML = html || '<tr><td colspan="5" class="text-center">–ù–µ—Ç –≤–æ–¥–∏—Ç–µ–ª–µ–π</td></tr>';
        }
        
        window.deleteDriver = async function(driverId) {
            if (confirm('‚ö†Ô∏è –£–¥–∞–ª–∏—Ç—å –≤–æ–¥–∏—Ç–µ–ª—è? –í—Å–µ –µ–≥–æ –ø–æ–µ–∑–¥–∫–∏ –∏ —Å–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.')) {
                try {
                    await db.collection('drivers').doc(driverId).delete();
                    const trips = await db.collection('trips').where('driverId', '==', driverId).get();
                    trips.forEach(async (doc) => { await doc.ref.delete(); });
                    const messages = await db.collection('messages').where('driverPhone', '==', driverId).get();
                    messages.forEach(async (doc) => { await doc.ref.delete(); });
                    alert('‚úÖ –í–æ–¥–∏—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω');
                } catch (error) { 
                    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error); 
                    alert('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è'); 
                }
            }
        };
        
        window.togglePasswordVisibility = function(phone) {
            const span = document.getElementById(`pass-${phone}`);
            const driver = LOCAL_DRIVERS.find(d => d.phone === phone);
            if (span.innerText.includes('‚Ä¢')) { 
                span.innerText = driver.password; 
            } else { 
                span.innerText = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'; 
            }
        };
        
        window.toggleAllPasswordVisibility = function(phone) {
            const span = document.getElementById(`all-pass-${phone}`);
            const driver = LOCAL_DRIVERS.find(d => d.phone === phone);
            if (span.innerText.includes('‚Ä¢')) { 
                span.innerText = driver.password; 
            } else { 
                span.innerText = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'; 
            }
        };
        
        window.editDriverPassword = async function(driverId) {
            const newPass = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å:');
            if (newPass) {
                try { 
                    await db.collection('drivers').doc(driverId).update({ password: newPass }); 
                    alert('‚úÖ –ü–∞—Ä–æ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω'); 
                }
                catch (error) { 
                    console.error('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è:', error); 
                    alert('‚ùå –û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è'); 
                }
            }
        };
        
        function loadAdminTrips() {
            let html = '';
            LOCAL_TRIPS.slice().reverse().forEach(trip => {
                const dateStr = formatDate(trip.date);
                const timeStr = trip.startTime ? formatDateTimeRange(trip.startTime, trip.endTime) : '';
                html += `<tr>
                    <td>${trip.driverName}</td>
                    <td>${dateStr}</td>
                    <td>${timeStr}</td>
                    <td><span class="badge ${trip.type === '–≥–æ—Ä–æ–¥' ? 'bg-primary' : 'bg-warning'}">${trip.type}</span></td>
                    <td><input type="number" class="form-control form-control-sm" style="width: 70px;" value="${trip.hours || 0}" id="hours-${trip.id}" step="0.5" ${trip.type !== '–≥–æ—Ä–æ–¥' ? 'disabled' : ''}></td>
                    <td><input type="number" class="form-control form-control-sm" style="width: 90px;" value="${trip.earn || 0}" id="earn-${trip.id}"></td>
                    <td><small class="text-secondary">${trip.comment || ''}</small></td>
                    <td><button class="btn btn-sm btn-success" onclick="editTrip('${trip.id}')"><i class="bi bi-check-lg"></i></button><button class="btn btn-sm btn-danger" onclick="deleteTrip('${trip.id}')"><i class="bi bi-trash"></i></button></td>
                </tr>`;
            });
            document.getElementById('admin-trips-table-mobile').innerHTML = html || '<tr><td colspan="8" class="text-center">–ù–µ—Ç –ø–æ–µ–∑–¥–æ–∫</td></tr>';
        }
        
        window.editTrip = async function(tripId) {
            const trip = LOCAL_TRIPS.find(t => t.id === tripId); 
            if (!trip) return;
            const newEarn = parseFloat(document.getElementById(`earn-${tripId}`).value);
            const newHours = parseFloat(document.getElementById(`hours-${tripId}`).value);
            try { 
                await db.collection('trips').doc(tripId).update({ earn: newEarn, hours: newHours }); 
                alert('‚úÖ –ü–æ–µ–∑–¥–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞'); 
            }
            catch (error) { 
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', error); 
                alert('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è'); 
            }
        };
        
        window.deleteTrip = async function(tripId) {
            if (confirm('‚ö†Ô∏è –£–¥–∞–ª–∏—Ç—å –ø–æ–µ–∑–¥–∫—É?')) {
                try { 
                    await db.collection('trips').doc(tripId).delete(); 
                    alert('‚úÖ –ü–æ–µ–∑–¥–∫–∞ —É–¥–∞–ª–µ–Ω–∞'); 
                }
                catch (error) { 
                    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error); 
                    alert('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è'); 
                }
            }
        };
        
        // ============ –ù–ê–°–¢–†–û–ô–ö–ò –¢–ê–†–ò–§–ê ============
        window.updateRate = function() {
            const rate = parseFloat(document.getElementById('admin-rate-input').value);
            if (rate > 0) {
                currentRate = rate;
                document.getElementById('rate-display').innerHTML = `${rate} ‚ÇΩ/—á`;
                document.getElementById('current-rate-label').innerHTML = `${rate} ‚ÇΩ/—á`;
                alert(`‚úÖ –¢–∞—Ä–∏—Ñ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ ${rate} ‚ÇΩ/—á`);
            }
        };
        
        // ============ –û–¢–ß–ï–¢–´ ============
        function updateMonthSelectors() {
            const months = new Set();
            LOCAL_TRIPS.forEach(trip => { if (trip.date) months.add(trip.date.slice(0, 7)); });
            LOCAL_ARCHIVE.forEach(arch => { months.add(arch.month); });
            const currentMonth = new Date().toISOString().slice(0, 7); 
            months.add(currentMonth);
            const sortedMonths = Array.from(months).sort().reverse();
            let adminOptions = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü</option>';
            let curatorOptions = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü</option>';
            sortedMonths.forEach(month => {
                const displayMonth = month.replace('-', '.');
                adminOptions += `<option value="${month}">${displayMonth}</option>`;
                curatorOptions += `<option value="${month}">${displayMonth}</option>`;
            });
            const adminSelect = document.getElementById('report-month-select');
            const curatorSelect = document.getElementById('curator-report-month');
            if (adminSelect) adminSelect.innerHTML = adminOptions;
            if (curatorSelect) curatorSelect.innerHTML = curatorOptions;
        }
        
        window.loadAdminMonthReport = function() {
            const month = document.getElementById('report-month-select').value;
            if (!month) return;
            let monthTrips = LOCAL_TRIPS.filter(t => t.date && t.date.startsWith(month));
            if (monthTrips.length === 0) { 
                const archive = LOCAL_ARCHIVE.find(a => a.month === month); 
                if (archive) monthTrips = archive.trips; 
            }
            currentReportMonth = month;
            
            // –î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç
            let dailyHtml = '';
            monthTrips.slice().reverse().forEach(trip => {
                const dateStr = formatDate(trip.date);
                const timeStr = trip.startTime ? formatDateTimeRange(trip.startTime, trip.endTime) : '';
                const route = trip.type === '–≥–æ—Ä–æ–¥' ? `${trip.hours?.toFixed(1) || ''} —á` : (trip.direction || '–ú–µ–∂–≥–æ—Ä–æ–¥');
                dailyHtml += `<div class="trip-row">
                    <div class="d-flex justify-content-between">
                        <div><div class="fw-bold">${trip.driverName}</div><div class="text-secondary small">${dateStr} ${timeStr}</div></div>
                        <div class="text-end"><span class="badge ${trip.type === '–≥–æ—Ä–æ–¥' ? 'bg-primary' : 'bg-warning'}">${trip.type}</span><div class="fw-bold text-success">${trip.earn} ‚ÇΩ</div></div>
                    </div>
                    <div class="mt-1"><small class="text-secondary">‚è±Ô∏è ${route}</small>${trip.comment ? `<div><small class="text-secondary">üí¨ ${trip.comment}</small></div>` : ''}</div>
                </div>`;
            });
            document.getElementById('admin-daily-report-content').innerHTML = dailyHtml || '<p class="text-center py-4">–ù–µ—Ç –ø–æ–µ–∑–¥–æ–∫</p>';
            document.getElementById('curator-daily-report-content').innerHTML = document.getElementById('admin-daily-report-content').innerHTML;
            
            // –°–≤–æ–¥–Ω—ã–π –æ—Ç—á–µ—Ç
            const summary = {}; 
            let totalCityHours = 0, totalInterTrips = 0, totalEarn = 0;
            monthTrips.forEach(trip => {
                if (!summary[trip.driverName]) summary[trip.driverName] = { cityHours: 0, interTrips: 0, earn: 0 };
                if (trip.type === '–≥–æ—Ä–æ–¥') { 
                    summary[trip.driverName].cityHours += trip.hours || 0; 
                    totalCityHours += trip.hours || 0; 
                } else { 
                    summary[trip.driverName].interTrips += 1; 
                    totalInterTrips += 1; 
                }
                summary[trip.driverName].earn += trip.earn || 0; 
                totalEarn += trip.earn || 0;
            });
            
            let summaryHtml = '';
            Object.keys(summary).sort().forEach(name => {
                const s = summary[name];
                summaryHtml += `<div class="driver-stat-item">
                    <div class="d-flex justify-content-between">
                        <div><strong>${name}</strong></div>
                        <div class="text-end"><span class="fw-bold text-success">${s.earn} ‚ÇΩ</span></div>
                    </div>
                    <div class="d-flex gap-3 mt-1 small">
                        <span>üöï –ì–æ—Ä–æ–¥: ${s.cityHours.toFixed(1)} —á</span>
                        <span>üõ£Ô∏è –ú–µ–∂–≥–æ—Ä–æ–¥: ${s.interTrips} –ø–æ–µ–∑–¥–æ–∫</span>
                    </div>
                </div>`;
            });
            
            document.getElementById('admin-summary-report-content').innerHTML = summaryHtml || '<p class="text-center py-4">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
            document.getElementById('curator-summary-report-content').innerHTML = document.getElementById('admin-summary-report-content').innerHTML;
            
            document.getElementById('admin-total-hours').innerHTML = `${totalCityHours.toFixed(1)} —á`;
            document.getElementById('admin-total-inter').innerHTML = totalInterTrips;
            document.getElementById('admin-total-earn').innerHTML = `${totalEarn} ‚ÇΩ`;
            
            document.getElementById('curator-total-hours').innerHTML = `${totalCityHours.toFixed(1)} —á`;
            document.getElementById('curator-total-inter').innerHTML = totalInterTrips;
            document.getElementById('curator-total-earn').innerHTML = `${totalEarn} ‚ÇΩ`;
        };
        
        window.switchAdminReportTab = function(tab) {
            const daily = document.getElementById('admin-daily-report-container');
            const summary = document.getElementById('admin-summary-report-container');
            const tabs = document.querySelectorAll('#admin-reports-tab .report-tab');
            if (tab === 'daily') {
                daily.classList.remove('hidden'); 
                summary.classList.add('hidden');
                tabs[0].classList.add('active'); 
                tabs[1].classList.remove('active');
            } else {
                daily.classList.add('hidden'); 
                summary.classList.remove('hidden');
                tabs[0].classList.remove('active'); 
                tabs[1].classList.add('active');
            }
        };
        
        window.switchCuratorReportTab = function(tab) {
            const daily = document.getElementById('curator-daily-report-container');
            const summary = document.getElementById('curator-summary-report-container');
            const tabs = document.querySelectorAll('#curator-reports-tab .report-tab');
            if (tab === 'daily') {
                daily.classList.remove('hidden'); 
                summary.classList.add('hidden');
                tabs[0].classList.add('active'); 
                tabs[1].classList.remove('active');
            } else {
                daily.classList.add('hidden'); 
                summary.classList.remove('hidden');
                tabs[0].classList.remove('active'); 
                tabs[1].classList.add('active');
            }
        };
        
        function loadAdminReports() {
            const month = new Date().toISOString().slice(0, 7);
            document.getElementById('report-month-select').value = month;
            loadAdminMonthReport();
        }
        
        // ============ –ó–ê–ö–†–´–¢–ò–ï –ú–ï–°–Ø–¶–ê ============
        window.closeMonth = function() {
            if (!confirm('‚ö†Ô∏è –ó–∞–∫—Ä—ã—Ç—å —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü? –í—Å–µ –ø–æ–µ–∑–¥–∫–∏ –±—É–¥—É—Ç –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω—ã –∏ —É–¥–∞–ª–µ–Ω—ã –∏–∑ –æ—Ç—á–µ—Ç–æ–≤.')) return;
            
            const month = new Date().toISOString().slice(0, 7);
            const monthTrips = LOCAL_TRIPS.filter(t => t.date && t.date.startsWith(month));
            
            if (monthTrips.length === 0) {
                alert('‚ùå –ù–µ—Ç –ø–æ–µ–∑–¥–æ–∫ –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü');
                return;
            }
            
            const total = monthTrips.reduce((s, t) => s + (t.earn || 0), 0);
            
            // –°–æ—Å—Ç–∞–≤–ª—è–µ–º —Å–≤–æ–¥–∫—É –ø–æ –≤–æ–¥–∏—Ç–µ–ª—è–º
            const summary = {};
            monthTrips.forEach(t => {
                if (!summary[t.driverName]) {
                    summary[t.driverName] = { cityHours: 0, interTrips: 0, totalEarn: 0 };
                }
                if (t.type === '–≥–æ—Ä–æ–¥') summary[t.driverName].cityHours += t.hours || 0;
                else summary[t.driverName].interTrips += 1;
                summary[t.driverName].totalEarn += t.earn || 0;
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∞—Ä—Ö–∏–≤
            LOCAL_ARCHIVE.push({
                month: month,
                trips: JSON.parse(JSON.stringify(monthTrips)),
                summary: summary,
                total: total,
                closedAt: new Date().toISOString()
            });
            
            // –£–î–ê–õ–Ø–ï–ú –í–°–ï –ü–û–ï–ó–î–ö–ò –ó–ê –≠–¢–û–¢ –ú–ï–°–Ø–¶
            LOCAL_TRIPS = LOCAL_TRIPS.filter(t => !t.date || !t.date.startsWith(month));
            saveToStorage();
            
            alert(`‚úÖ –ú–µ—Å—è—Ü ${month} –∑–∞–∫—Ä—ã—Ç! –ò—Ç–æ–≥–æ: ${total} ‚ÇΩ`);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
            if (currentRole === 'admin') {
                loadAdminData();
                // –û—á–∏—â–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –º–µ—Å—è—Ü –≤ –æ—Ç—á–µ—Ç–∞—Ö
                document.getElementById('report-month-select').value = '';
                // –û—á–∏—â–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –æ—Ç—á–µ—Ç–æ–≤
                document.getElementById('admin-daily-report-content').innerHTML = '<p class="text-center text-secondary py-4">–ù–µ—Ç –ø–æ–µ–∑–¥–æ–∫ –∑–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü</p>';
                document.getElementById('admin-summary-report-content').innerHTML = '<p class="text-center text-secondary py-4">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
                document.getElementById('admin-total-hours').innerHTML = '0 —á';
                document.getElementById('admin-total-inter').innerHTML = '0';
                document.getElementById('admin-total-earn').innerHTML = '0 ‚ÇΩ';
            }
            
            if (currentRole === 'curator') {
                loadCuratorData();
                // –û—á–∏—â–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –º–µ—Å—è—Ü –≤ –æ—Ç—á–µ—Ç–∞—Ö
                document.getElementById('curator-report-month').value = '';
                // –û—á–∏—â–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –æ—Ç—á–µ—Ç–æ–≤
                document.getElementById('curator-daily-report-content').innerHTML = '<p class="text-center text-secondary py-4">–ù–µ—Ç –ø–æ–µ–∑–¥–æ–∫ –∑–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü</p>';
                document.getElementById('curator-summary-report-content').innerHTML = '<p class="text-center text-secondary py-4">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
                document.getElementById('curator-total-hours').innerHTML = '0 —á';
                document.getElementById('curator-total-inter').innerHTML = '0';
                document.getElementById('curator-total-earn').innerHTML = '0 ‚ÇΩ';
            }
            
            updateMonthSelectors();
            updateArchiveSelectors();
        };
        
        // ============ –≠–ö–°–ü–û–†–¢ –í EXCEL ============
        window.exportDailyReportToExcel = function() {
            if (!currentReportMonth) { 
                alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü'); 
                return; 
            }
            let monthTrips = LOCAL_TRIPS.filter(t => t.date && t.date.startsWith(currentReportMonth));
            if (monthTrips.length === 0) { 
                const archive = LOCAL_ARCHIVE.find(a => a.month === currentReportMonth); 
                if (archive) monthTrips = archive.trips; 
            }
            if (monthTrips.length === 0) { 
                alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞'); 
                return; 
            }
            let csv = "–í–æ–¥–∏—Ç–µ–ª—å,–î–∞—Ç–∞,–í—Ä–µ–º—è,–¢–∏–ø,–ú–∞—Ä—à—Ä—É—Ç,–°—É–º–º–∞,–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π\n";
            monthTrips.forEach(t => {
                const dateStr = formatDate(t.date);
                const timeStr = t.startTime ? formatDateTimeRange(t.startTime, t.endTime) : '';
                const route = t.type === '–≥–æ—Ä–æ–¥' ? t.hours + ' —á' : (t.direction || '–ú–µ–∂–≥–æ—Ä–æ–¥');
                csv += `${t.driverName},${dateStr},${timeStr},${t.type},${route},${t.earn},${t.comment || ''}\n`;
            });
            const blob = new Blob(["\uFEFF" + csv], {type: 'text/csv'});
            const url = URL.createObjectURL(blob); 
            const a = document.createElement('a');
            a.href = url; 
            a.download = `shintorg_${currentReportMonth}_daily.csv`; 
            a.click();
            URL.revokeObjectURL(url);
        };
        
        window.exportSummaryReportToExcel = function() {
            if (!currentReportMonth) { 
                alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü'); 
                return; 
            }
            let monthTrips = LOCAL_TRIPS.filter(t => t.date && t.date.startsWith(currentReportMonth));
            if (monthTrips.length === 0) { 
                const archive = LOCAL_ARCHIVE.find(a => a.month === currentReportMonth); 
                if (archive) monthTrips = archive.trips; 
            }
            if (monthTrips.length === 0) { 
                alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞'); 
                return; 
            }
            const summary = {};
            monthTrips.forEach(t => {
                if (!summary[t.driverName]) summary[t.driverName] = { cityHours: 0, interTrips: 0, earn: 0 };
                if (t.type === '–≥–æ—Ä–æ–¥') summary[t.driverName].cityHours += t.hours || 0;
                else summary[t.driverName].interTrips += 1;
                summary[t.driverName].earn += t.earn || 0;
            });
            let csv = "–í–æ–¥–∏—Ç–µ–ª—å,–ß–∞—Å—ã (–≥–æ—Ä–æ–¥),–ü–æ–µ–∑–¥–∫–∏ (–ú–ì),–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ\n";
            Object.keys(summary).sort().forEach(name => {
                const s = summary[name];
                csv += `${name},${s.cityHours.toFixed(1)} —á,${s.interTrips},${s.earn} ‚ÇΩ\n`;
            });
            const total = monthTrips.reduce((s, t) => s + (t.earn || 0), 0);
            csv += `\n–û–ë–©–ò–ô –ò–¢–û–ì,,,${total} ‚ÇΩ`;
            const blob = new Blob(["\uFEFF" + csv], {type: 'text/csv'});
            const a = document.createElement('a'); 
            a.href = URL.createObjectURL(blob);
            a.download = `shintorg_${currentReportMonth}_summary.csv`; 
            a.click();
            URL.revokeObjectURL(URL);
        };
        
        window.exportCuratorDailyReportToExcel = window.exportDailyReportToExcel;
        window.exportCuratorSummaryReportToExcel = window.exportSummaryReportToExcel;
        
        // ============ –ü–ï–ß–ê–¢–¨ ============
        window.printDailyReport = function() {
            if (!currentReportMonth) { 
                alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü'); 
                return; 
            }
            let monthTrips = LOCAL_TRIPS.filter(t => t.date && t.date.startsWith(currentReportMonth));
            if (monthTrips.length === 0) { 
                const archive = LOCAL_ARCHIVE.find(a => a.month === currentReportMonth); 
                if (archive) monthTrips = archive.trips; 
            }
            if (monthTrips.length === 0) { 
                alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–µ—á–∞—Ç–∏'); 
                return; 
            }
            
            const printWindow = window.open('', '_blank');
            if (!printWindow) {
                alert('–†–∞–∑—Ä–µ—à–∏—Ç–µ –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞ –¥–ª—è –ø–µ—á–∞—Ç–∏');
                return;
            }
            
            let tableHtml = '';
            monthTrips.slice().reverse().forEach(t => {
                const dateStr = formatDate(t.date);
                const timeStr = t.startTime ? formatDateTimeRange(t.startTime, t.endTime) : '';
                const route = t.type === '–≥–æ—Ä–æ–¥' ? t.hours + ' —á' : (t.direction || '–ú–µ–∂–≥–æ—Ä–æ–¥');
                tableHtml += `<tr><td>${t.driverName}</td><td>${dateStr}</td><td>${timeStr}</td><td>${t.type}</td><td>${route}</td><td>${t.earn} ‚ÇΩ</td><td>${t.comment || ''}</td></tr>`;
            });
            
            printWindow.document.write(`
                <html>
                <head>
                    <title>–®–∏–Ω—Ç–æ—Ä–≥ - –û—Ç—á–µ—Ç ${currentReportMonth}</title>
                    <style>
                        body { font-family: Arial; padding: 30px; }
                        h1 { color: #0f5e7e; }
                        table { border-collapse: collapse; width: 100%; }
                        th { background: #0f5e7e; color: white; padding: 12px; }
                        td { padding: 10px; border: 1px solid #ddd; }
                        @media print { body { padding: 15px; } }
                    </style>
                </head>
                <body>
                    <h1>–®–∏–Ω—Ç–æ—Ä–≥ –°—É—Ä–≥—É—Ç</h1>
                    <h2>–ü–æ—Å–º–µ–Ω–Ω—ã–π –æ—Ç—á–µ—Ç: ${currentReportMonth}</h2>
                    <table>
                        <tr>
                            <th>–í–æ–¥–∏—Ç–µ–ª—å</th>
                            <th>–î–∞—Ç–∞</th>
                            <th>–í—Ä–µ–º—è</th>
                            <th>–¢–∏–ø</th>
                            <th>–ú–∞—Ä—à—Ä—É—Ç</th>
                            <th>–°—É–º–º–∞</th>
                            <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                        </tr>
                        ${tableHtml}
                    </table>
                    <p style="margin-top: 30px; color: #666;">–î–∞—Ç–∞ –ø–µ—á–∞—Ç–∏: ${new Date().toLocaleString()}</p>
                </body>
                </html>
            `);
            printWindow.document.close();
            setTimeout(() => { printWindow.print(); }, 250);
        };
        
        window.printSummaryReport = function() {
            if (!currentReportMonth) { 
                alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü'); 
                return; 
            }
            let monthTrips = LOCAL_TRIPS.filter(t => t.date && t.date.startsWith(currentReportMonth));
            if (monthTrips.length === 0) { 
                const archive = LOCAL_ARCHIVE.find(a => a.month === currentReportMonth); 
                if (archive) monthTrips = archive.trips; 
            }
            if (monthTrips.length === 0) { 
                alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–µ—á–∞—Ç–∏'); 
                return; 
            }
            
            const summary = {}; 
            let totalCityHours = 0, totalInterTrips = 0, totalEarn = 0;
            monthTrips.forEach(t => {
                if (!summary[t.driverName]) summary[t.driverName] = { cityHours: 0, interTrips: 0, earn: 0 };
                if (t.type === '–≥–æ—Ä–æ–¥') { 
                    summary[t.driverName].cityHours += t.hours || 0; 
                    totalCityHours += t.hours || 0; 
                } else { 
                    summary[t.driverName].interTrips += 1; 
                    totalInterTrips += 1; 
                }
                summary[t.driverName].earn += t.earn || 0; 
                totalEarn += t.earn || 0;
            });
            
            let tableHtml = '';
            Object.keys(summary).sort().forEach(name => {
                const s = summary[name];
                tableHtml += `<tr><td>${name}</td><td>${s.cityHours.toFixed(1)} —á</td><td>${s.interTrips}</td><td>${s.earn} ‚ÇΩ</td></tr>`;
            });
            
            const printWindow = window.open('', '_blank');
            if (!printWindow) {
                alert('–†–∞–∑—Ä–µ—à–∏—Ç–µ –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞ –¥–ª—è –ø–µ—á–∞—Ç–∏');
                return;
            }
            
            printWindow.document.write(`
                <html>
                <head>
                    <title>–®–∏–Ω—Ç–æ—Ä–≥ - –°–≤–æ–¥–∫–∞ ${currentReportMonth}</title>
                    <style>
                        body { font-family: Arial; padding: 30px; }
                        h1 { color: #0f5e7e; }
                        table { border-collapse: collapse; width: 100%; }
                        th { background: #0f5e7e; color: white; padding: 12px; }
                        td { padding: 10px; border: 1px solid #ddd; }
                        .total { background: #ffe68f; font-weight: bold; }
                        @media print { body { padding: 15px; } }
                    </style>
                </head>
                <body>
                    <h1>–®–∏–Ω—Ç–æ—Ä–≥ –°—É—Ä–≥—É—Ç</h1>
                    <h2>–°–≤–æ–¥–Ω—ã–π –æ—Ç—á–µ—Ç: ${currentReportMonth}</h2>
                    <table>
                        <tr>
                            <th>–í–æ–¥–∏—Ç–µ–ª—å</th>
                            <th>–ß–∞—Å—ã (–≥–æ—Ä–æ–¥)</th>
                            <th>–ü–æ–µ–∑–¥–∫–∏ (–ú–ì)</th>
                            <th>–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ</th>
                        </tr>
                        ${tableHtml}
                    </table>
                    <h3 style="margin-top:30px;">–û–ë–©–ò–ô –ó–ê–†–ê–ë–û–¢–û–ö: ${totalEarn} ‚ÇΩ</h3>
                    <p>–í—Å–µ–≥–æ —á–∞—Å–æ–≤: ${totalCityHours.toFixed(1)} —á</p>
                    <p>–í—Å–µ–≥–æ –ø–æ–µ–∑–¥–æ–∫ –ú–ì: ${totalInterTrips}</p>
                    <p style="margin-top: 30px; color: #666;">–î–∞—Ç–∞ –ø–µ—á–∞—Ç–∏: ${new Date().toLocaleString()}</p>
                </body>
                </html>
            `);
            printWindow.document.close();
            setTimeout(() => { printWindow.print(); }, 250);
        };
        
        window.printCuratorDailyReport = window.printDailyReport;
        window.printCuratorSummaryReport = window.printSummaryReport;
        
        // ============ –ê–†–•–ò–í ============
        function updateArchiveSelectors() {
            const months = new Set();
            LOCAL_ARCHIVE.forEach(arch => { months.add(arch.month); });
            const sortedMonths = Array.from(months).sort().reverse();
            let adminOptions = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü</option>';
            let curatorOptions = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü</option>';
            sortedMonths.forEach(month => {
                const displayMonth = month.replace('-', '.');
                adminOptions += `<option value="${month}">${displayMonth}</option>`;
                curatorOptions += `<option value="${month}">${displayMonth}</option>`;
            });
            const adminSelect = document.getElementById('admin-archive-month-select');
            const curatorSelect = document.getElementById('curator-archive-month-select');
            if (adminSelect) adminSelect.innerHTML = adminOptions;
            if (curatorSelect) curatorSelect.innerHTML = curatorOptions;
        }
        
        function loadArchiveList() {
            let html = '';
            LOCAL_ARCHIVE.slice().reverse().forEach((arch, index) => {
                html += `<div class="archive-card">
                    <div class="archive-header" onclick="toggleArchiveContent(this)">
                        <div class="d-flex justify-content-between w-100">
                            <div><h5 class="fw-bold mb-1">${arch.month}</h5><div class="text-secondary small"><i class="bi bi-truck"></i> ${arch.trips?.length || 0} –ø–æ–µ–∑–¥–æ–∫</div></div>
                            <div class="text-end"><span class="fs-5 fw-bold text-success">${arch.total || 0} ‚ÇΩ</span><div><i class="bi bi-chevron-down"></i></div></div>
                        </div>
                    </div>
                    <div class="archive-content hidden">
                        <h6 class="fw-bold mb-3">–ò—Ç–æ–≥–∏ –ø–æ –≤–æ–¥–∏—Ç–µ–ª—è–º:</h6>
                        ${Object.keys(arch.summary || {}).map(name => `
                            <div class="d-flex justify-content-between mb-2"><span>${name}</span><span class="fw-bold text-success">${arch.summary[name]?.totalEarn || 0} ‚ÇΩ</span></div>
                            <div class="d-flex gap-3 text-secondary small mb-2"><span>üöï ${arch.summary[name]?.cityHours?.toFixed(1) || 0} —á</span><span>üõ£Ô∏è ${arch.summary[name]?.interTrips || 0} –ø–æ–µ–∑–¥–æ–∫</span></div>
                        `).join('')}
                        <hr class="my-3">
                        <div class="d-flex gap-2 mt-3">
                            <button class="btn btn-sm btn-success flex-fill" onclick="exportArchive('${arch.id}')"><i class="bi bi-file-earmark-excel"></i> Excel</button>
                            <button class="btn btn-sm btn-primary flex-fill" onclick="printArchive('${arch.id}')"><i class="bi bi-printer"></i> –ü–µ—á–∞—Ç—å</button>
                            <button class="btn btn-sm btn-danger flex-fill" onclick="deleteArchive('${arch.id}')"><i class="bi bi-trash"></i> –£–¥–∞–ª–∏—Ç—å</button>
                        </div>
                    </div>
                </div>`;
            });
            document.getElementById('admin-archive-content').innerHTML = html || '<p class="text-center py-5 text-secondary"><i class="bi bi-archive fs-1"></i><br>–ù–µ—Ç –∞—Ä—Ö–∏–≤–æ–≤</p>';
        }
        
        function loadCuratorArchiveList() {
            let html = '';
            LOCAL_ARCHIVE.slice().reverse().forEach((arch) => {
                html += `<div class="archive-card">
                    <div class="archive-header" onclick="toggleArchiveContent(this)">
                        <div class="d-flex justify-content-between w-100">
                            <div><h5 class="fw-bold mb-1">${arch.month}</h5><div class="text-secondary small"><i class="bi bi-truck"></i> ${arch.trips?.length || 0} –ø–æ–µ–∑–¥–æ–∫</div></div>
                            <div class="text-end"><span class="fs-5 fw-bold text-success">${arch.total || 0} ‚ÇΩ</span><div><i class="bi bi-chevron-down"></i></div></div>
                        </div>
                    </div>
                    <div class="archive-content hidden">
                        <h6 class="fw-bold mb-3">–ò—Ç–æ–≥–∏ –ø–æ –≤–æ–¥–∏—Ç–µ–ª—è–º:</h6>
                        ${Object.keys(arch.summary || {}).map(name => `
                            <div class="d-flex justify-content-between mb-2"><span>${name}</span><span class="fw-bold text-success">${arch.summary[name]?.totalEarn || 0} ‚ÇΩ</span></div>
                            <div class="d-flex gap-3 text-secondary small mb-2"><span>üöï ${arch.summary[name]?.cityHours?.toFixed(1) || 0} —á</span><span>üõ£Ô∏è ${arch.summary[name]?.interTrips || 0} –ø–æ–µ–∑–¥–æ–∫</span></div>
                        `).join('')}
                    </div>
                </div>`;
            });
            document.getElementById('curator-archive-content').innerHTML = html || '<p class="text-center py-5 text-secondary"><i class="bi bi-archive fs-1"></i><br>–ù–µ—Ç –∞—Ä—Ö–∏–≤–æ–≤</p>';
        }
        
        window.loadAdminArchiveMonth = function() {
            const month = document.getElementById('admin-archive-month-select').value; 
            if (!month) return;
            const archive = LOCAL_ARCHIVE.find(a => a.month === month);
            if (archive) {
                let html = `<div class="archive-card">
                    <div class="archive-header" onclick="toggleArchiveContent(this)">
                        <div class="d-flex justify-content-between w-100">
                            <div><h5 class="fw-bold mb-1">${archive.month}</h5><div class="text-secondary small"><i class="bi bi-truck"></i> ${archive.trips?.length || 0} –ø–æ–µ–∑–¥–æ–∫</div></div>
                            <div class="text-end"><span class="fs-5 fw-bold text-success">${archive.total || 0} ‚ÇΩ</span><div><i class="bi bi-chevron-down"></i></div></div>
                        </div>
                    </div>
                    <div class="archive-content">
                        <h6 class="fw-bold mb-3">–ò—Ç–æ–≥–∏ –ø–æ –≤–æ–¥–∏—Ç–µ–ª—è–º:</h6>
                        ${Object.keys(archive.summary || {}).map(name => `
                            <div class="d-flex justify-content-between mb-2"><span>${name}</span><span class="fw-bold text-success">${archive.summary[name]?.totalEarn || 0} ‚ÇΩ</span></div>
                            <div class="d-flex gap-3 text-secondary small mb-2"><span>üöï ${archive.summary[name]?.cityHours?.toFixed(1) || 0} —á</span><span>üõ£Ô∏è ${archive.summary[name]?.interTrips || 0} –ø–æ–µ–∑–¥–æ–∫</span></div>
                        `).join('')}
                        <hr class="my-3">
                        <div class="d-flex gap-2 mt-3">
                            <button class="btn btn-sm btn-success flex-fill" onclick="exportArchive('${archive.id}')"><i class="bi bi-file-earmark-excel"></i> Excel</button>
                            <button class="btn btn-sm btn-primary flex-fill" onclick="printArchive('${archive.id}')"><i class="bi bi-printer"></i> –ü–µ—á–∞—Ç—å</button>
                            <button class="btn btn-sm btn-danger flex-fill" onclick="deleteArchive('${archive.id}')"><i class="bi bi-trash"></i> –£–¥–∞–ª–∏—Ç—å</button>
                        </div>
                    </div>
                </div>`;
                document.getElementById('admin-archive-content').innerHTML = html;
            }
        };
        
        window.loadCuratorArchiveMonth = function() {
            const month = document.getElementById('curator-archive-month-select').value; 
            if (!month) return;
            const archive = LOCAL_ARCHIVE.find(a => a.month === month);
            if (archive) {
                let html = `<div class="archive-card">
                    <div class="archive-header" onclick="toggleArchiveContent(this)">
                        <div class="d-flex justify-content-between w-100">
                            <div><h5 class="fw-bold mb-1">${archive.month}</h5><div class="text-secondary small"><i class="bi bi-truck"></i> ${archive.trips?.length || 0} –ø–æ–µ–∑–¥–æ–∫</div></div>
                            <div class="text-end"><span class="fs-5 fw-bold text-success">${archive.total || 0} ‚ÇΩ</span><div><i class="bi bi-chevron-down"></i></div></div>
                        </div>
                    </div>
                    <div class="archive-content">
                        <h6 class="fw-bold mb-3">–ò—Ç–æ–≥–∏ –ø–æ –≤–æ–¥–∏—Ç–µ–ª—è–º:</h6>
                        ${Object.keys(archive.summary || {}).map(name => `
                            <div class="d-flex justify-content-between mb-2"><span>${name}</span><span class="fw-bold text-success">${archive.summary[name]?.totalEarn || 0} ‚ÇΩ</span></div>
                            <div class="d-flex gap-3 text-secondary small mb-2"><span>üöï ${archive.summary[name]?.cityHours?.toFixed(1) || 0} —á</span><span>üõ£Ô∏è ${archive.summary[name]?.interTrips || 0} –ø–æ–µ–∑–¥–æ–∫</span></div>
                        `).join('')}
                    </div>
                </div>`;
                document.getElementById('curator-archive-content').innerHTML = html;
            }
        };
        
        window.toggleArchiveContent = function(header) {
            const content = header.nextElementSibling;
            const icon = header.querySelector('.bi-chevron-down, .bi-chevron-up');
            content.classList.toggle('hidden');
            if (content.classList.contains('hidden')) {
                icon.classList.remove('bi-chevron-up'); 
                icon.classList.add('bi-chevron-down');
            } else {
                icon.classList.remove('bi-chevron-down'); 
                icon.classList.add('bi-chevron-up');
            }
        };
        
        window.exportArchive = async function(archiveId) {
            try {
                const doc = await db.collection('archive').doc(archiveId).get();
                const arch = doc.data();
                let csv = "–í–æ–¥–∏—Ç–µ–ª—å,–î–∞—Ç–∞,–í—Ä–µ–º—è,–¢–∏–ø,–ß–∞—Å—ã/–ú–∞—Ä—à—Ä—É—Ç,–°—É–º–º–∞,–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π\n";
                arch.trips.forEach(t => {
                    const dateStr = formatDate(t.date);
                    const timeStr = t.startTime ? formatDateTimeRange(t.startTime, t.endTime) : '';
                    const details = t.type === '–≥–æ—Ä–æ–¥' ? t.hours + ' —á' : (t.direction || '–ú–µ–∂–≥–æ—Ä–æ–¥');
                    csv += `${t.driverName},${dateStr},${timeStr},${t.type},${details},${t.earn},${t.comment || ''}\n`;
                });
                csv += `\n–û–ë–©–ò–ô –ò–¢–û–ì,,,${arch.total} ‚ÇΩ`;
                const blob = new Blob(["\uFEFF" + csv], {type: 'text/csv'});
                const url = URL.createObjectURL(blob); 
                const a = document.createElement('a');
                a.href = url; 
                a.download = `shintorg_${arch.month}.csv`; 
                a.click();
                URL.revokeObjectURL(url);
            } catch (error) { 
                console.error('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:', error); 
                alert('‚ùå –û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞'); 
            }
        };
        
        window.printArchive = async function(archiveId) {
            try {
                const doc = await db.collection('archive').doc(archiveId).get();
                const arch = doc.data();
                let tableHtml = '';
                arch.trips.forEach(t => {
                    const dateStr = formatDate(t.date);
                    const timeStr = t.startTime ? formatDateTimeRange(t.startTime, t.endTime) : '';
                    const route = t.type === '–≥–æ—Ä–æ–¥' ? t.hours + ' —á' : (t.direction || '–ú–µ–∂–≥–æ—Ä–æ–¥');
                    tableHtml += `<tr><td>${t.driverName}</td><td>${dateStr}</td><td>${timeStr}</td><td>${t.type}</td><td>${route}</td><td>${t.earn} ‚ÇΩ</td><td>${t.comment || ''}</td></tr>`;
                });
                let summaryHtml = '';
                Object.keys(arch.summary || {}).forEach(name => {
                    summaryHtml += `<p><strong>${name}:</strong> ${arch.summary[name]?.totalEarn || 0} ‚ÇΩ (üöï ${arch.summary[name]?.cityHours?.toFixed(1) || 0} —á, üõ£Ô∏è ${arch.summary[name]?.interTrips || 0} –ø–æ–µ–∑–¥–æ–∫)</p>`;
                });
                
                const printWindow = window.open('', '_blank');
                if (!printWindow) {
                    alert('–†–∞–∑—Ä–µ—à–∏—Ç–µ –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞ –¥–ª—è –ø–µ—á–∞—Ç–∏');
                    return;
                }
                
                printWindow.document.write(`
                    <html>
                    <head>
                        <title>–®–∏–Ω—Ç–æ—Ä–≥ - –ê—Ä—Ö–∏–≤ ${arch.month}</title>
                        <style>
                            body { font-family: Arial; padding: 30px; }
                            h1 { color: #0f5e7e; }
                            table { border-collapse: collapse; width: 100%; }
                            th { background: #0f5e7e; color: white; padding: 12px; }
                            td { padding: 10px; border: 1px solid #ddd; }
                            @media print { body { padding: 15px; } }
                        </style>
                    </head>
                    <body>
                        <h1>–®–∏–Ω—Ç–æ—Ä–≥ –°—É—Ä–≥—É—Ç</h1>
                        <h2>–ê—Ä—Ö–∏–≤: ${arch.month}</h2>
                        <h3>–ò—Ç–æ–≥–∏ –ø–æ –≤–æ–¥–∏—Ç–µ–ª—è–º:</h3>
                        ${summaryHtml}
                        <h3>–î–µ—Ç–∞–ª—å–Ω—ã–µ –ø–æ–µ–∑–¥–∫–∏:</h3>
                        <table>
                            <tr>
                                <th>–í–æ–¥–∏—Ç–µ–ª—å</th>
                                <th>–î–∞—Ç–∞</th>
                                <th>–í—Ä–µ–º—è</th>
                                <th>–¢–∏–ø</th>
                                <th>–ú–∞—Ä—à—Ä—É—Ç</th>
                                <th>–°—É–º–º–∞</th>
                                <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                            </tr>
                            ${tableHtml}
                        </table>
                        <h3 style="margin-top:30px;">–û–±—â–∏–π –∏—Ç–æ–≥: ${arch.total} ‚ÇΩ</h3>
                        <p style="margin-top: 30px; color: #666;">–î–∞—Ç–∞ –ø–µ—á–∞—Ç–∏: ${new Date().toLocaleString()}</p>
                    </body>
                    </html>
                `);
                printWindow.document.close();
                setTimeout(() => { printWindow.print(); }, 250);
            } catch (error) { 
                console.error('–û—à–∏–±–∫–∞ –ø–µ—á–∞—Ç–∏:', error); 
                alert('‚ùå –û—à–∏–±–∫–∞ –ø–µ—á–∞—Ç–∏'); 
            }
        };
        
        window.deleteArchive = async function(archiveId) {
            if (confirm('‚ö†Ô∏è –£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∞—Ä—Ö–∏–≤? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
                try { 
                    await db.collection('archive').doc(archiveId).delete(); 
                    alert('‚úÖ –ê—Ä—Ö–∏–≤ —É–¥–∞–ª–µ–Ω'); 
                }
                catch (error) { 
                    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∞—Ä—Ö–∏–≤–∞:', error); 
                    alert('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∞—Ä—Ö–∏–≤–∞'); 
                }
            }
        };
        
        window.clearAllArchives = async function() {
            if (confirm('‚ö†Ô∏è –£–¥–∞–ª–∏—Ç—å –í–°–ï –∞—Ä—Ö–∏–≤—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
                try { 
                    const snapshot = await db.collection('archive').get(); 
                    snapshot.forEach(async (doc) => { await doc.ref.delete(); }); 
                    alert('‚úÖ –í—Å–µ –∞—Ä—Ö–∏–≤—ã —É–¥–∞–ª–µ–Ω—ã'); 
                }
                catch (error) { 
                    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∞—Ä—Ö–∏–≤–æ–≤:', error); 
                    alert('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∞—Ä—Ö–∏–≤–æ–≤'); 
                }
            }
        };
        
        // ============ –ö–£–†–ê–¢–û–† ============
        function loadCuratorData() {
            loadCuratorDrivers(); 
            loadCuratorReports(); 
            loadCuratorArchiveList();
            updateMonthSelectors(); 
            updateArchiveSelectors();
            document.getElementById('curator-active-count').innerHTML = LOCAL_DRIVERS.filter(d => d.status === 'active').length;
            document.getElementById('curator-city-count').innerHTML = LOCAL_DRIVERS.filter(d => d.status === 'active' && d.shiftType === 'city').length;
            document.getElementById('curator-inter-count').innerHTML = LOCAL_DRIVERS.filter(d => d.status === 'active' && d.shiftType === 'intercity').length;
        }
        
        function loadCuratorDrivers() {
            let html = '';
            LOCAL_DRIVERS.forEach(driver => {
                if (driver.status !== 'active') return;
                let statusText = driver.shiftType === 'city' ? 'üèôÔ∏è –ì–æ—Ä–æ–¥' : 'üõ£Ô∏è –ú–µ–∂–≥–æ—Ä–æ–¥';
                let statusClass = driver.shiftType === 'city' ? 'status-working' : 'status-intercity';
                const hasGeo = driver.lat && driver.lng;
                html += `<tr><td>${driver.short || driver.name}</td><td><span class="${statusClass} px-3 py-2">${statusText}</span></td><td>${hasGeo ? '<span class="text-success">–î–≤–∏–∂–µ—Ç—Å—è</span>' : '‚Äî'}</td><td>${hasGeo ? `<button class="btn btn-sm btn-outline-info" onclick="showDriverMap('${driver.id}', '${driver.short || driver.name}')"><i class="bi bi-map"></i></button>` : '‚Äî'}</td></tr>`;
            });
            document.getElementById('curator-drivers-table').innerHTML = html || '<tr><td colspan="4" class="text-center">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤–æ–¥–∏—Ç–µ–ª–µ–π</td></tr>';
        }
        
        function loadCuratorReports() {
            const month = new Date().toISOString().slice(0, 7);
            document.getElementById('curator-report-month').value = month;
            loadCuratorMonthReport();
        }
        
        window.loadCuratorMonthReport = function() {
            const month = document.getElementById('curator-report-month').value; 
            if (!month) return;
            let monthTrips = LOCAL_TRIPS.filter(t => t.date && t.date.startsWith(month));
            if (monthTrips.length === 0) { 
                const archive = LOCAL_ARCHIVE.find(a => a.month === month); 
                if (archive) monthTrips = archive.trips; 
            }
            currentReportMonth = month;
            
            // –î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç
            let dailyHtml = '';
            monthTrips.slice().reverse().forEach(trip => {
                const dateStr = formatDate(trip.date);
                const timeStr = trip.startTime ? formatDateTimeRange(trip.startTime, trip.endTime) : '';
                const route = trip.type === '–≥–æ—Ä–æ–¥' ? `${trip.hours?.toFixed(1) || ''} —á` : (trip.direction || '–ú–µ–∂–≥–æ—Ä–æ–¥');
                dailyHtml += `<div class="trip-row">
                    <div class="d-flex justify-content-between">
                        <div><div class="fw-bold">${trip.driverName}</div><div class="text-secondary small">${dateStr} ${timeStr}</div></div>
                        <div class="text-end"><span class="badge ${trip.type === '–≥–æ—Ä–æ–¥' ? 'bg-primary' : 'bg-warning'}">${trip.type}</span><div class="fw-bold text-success">${trip.earn} ‚ÇΩ</div></div>
                    </div>
                    <div class="mt-1"><small class="text-secondary">‚è±Ô∏è ${route}</small>${trip.comment ? `<div><small class="text-secondary">üí¨ ${trip.comment}</small></div>` : ''}</div>
                </div>`;
            });
            document.getElementById('curator-daily-report-content').innerHTML = dailyHtml || '<p class="text-center py-4">–ù–µ—Ç –ø–æ–µ–∑–¥–æ–∫</p>';
            
            // –°–≤–æ–¥–Ω—ã–π –æ—Ç—á–µ—Ç
            const summary = {}; 
            let totalCityHours = 0, totalInterTrips = 0, totalEarn = 0;
            monthTrips.forEach(trip => {
                if (!summary[trip.driverName]) summary[trip.driverName] = { cityHours: 0, interTrips: 0, earn: 0 };
                if (trip.type === '–≥–æ—Ä–æ–¥') { 
                    summary[trip.driverName].cityHours += trip.hours || 0; 
                    totalCityHours += trip.hours || 0; 
                } else { 
                    summary[trip.driverName].interTrips += 1; 
                    totalInterTrips += 1; 
                }
                summary[trip.driverName].earn += trip.earn || 0; 
                totalEarn += trip.earn || 0;
            });
            
            let summaryHtml = '';
            Object.keys(summary).sort().forEach(name => {
                const s = summary[name];
                summaryHtml += `<div class="driver-stat-item">
                    <div class="d-flex justify-content-between">
                        <div><strong>${name}</strong></div>
                        <div class="text-end"><span class="fw-bold text-success">${s.earn} ‚ÇΩ</span></div>
                    </div>
                    <div class="d-flex gap-3 mt-1 small">
                        <span>üöï –ì–æ—Ä–æ–¥: ${s.cityHours.toFixed(1)} —á</span>
                        <span>üõ£Ô∏è –ú–µ–∂–≥–æ—Ä–æ–¥: ${s.interTrips} –ø–æ–µ–∑–¥–æ–∫</span>
                    </div>
                </div>`;
            });
            
            document.getElementById('curator-summary-report-content').innerHTML = summaryHtml || '<p class="text-center py-4">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
            document.getElementById('curator-total-hours').innerHTML = `${totalCityHours.toFixed(1)} —á`;
            document.getElementById('curator-total-inter').innerHTML = totalInterTrips;
            document.getElementById('curator-total-earn').innerHTML = `${totalEarn} ‚ÇΩ`;
        };
        
        // ============ –û–°–¢–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ============
        window.switchDriverMode = function(mode) {
            document.getElementById('driver-city-panel').classList.toggle('hidden', mode !== 'city');
            document.getElementById('driver-inter-panel').classList.toggle('hidden', mode !== 'inter');
        };
        
        window.switchAdminTab = function(tab) {
            const tabs = ['drivers', 'all-drivers', 'trips', 'reports', 'archive', 'settings'];
            tabs.forEach(t => { document.getElementById(`admin-${t}-tab`).classList.add('hidden'); });
            document.getElementById(`admin-${tab}-tab`).classList.remove('hidden');
            document.querySelectorAll('#admin-cabinet .mobile-tabs .mobile-tab').forEach((el, i) => { el.classList.toggle('active', i === tabs.indexOf(tab)); });
            if (tab === 'archive') { 
                loadArchiveList(); 
                updateArchiveSelectors(); 
            }
        };
        
        window.switchCuratorTab = function(tab) {
            document.getElementById('curator-reports-tab').classList.toggle('hidden', tab !== 'reports');
            document.getElementById('curator-archive-tab').classList.toggle('hidden', tab !== 'archive');
            document.querySelectorAll('#curator-cabinet .mobile-tabs .mobile-tab').forEach((el, i) => { 
                el.classList.toggle('active', (i === 0 && tab === 'reports') || (i === 1 && tab === 'archive')); 
            });
        };
        
        window.showRegister = function() { 
            document.getElementById('login-screen').classList.add('hidden'); 
            document.getElementById('register-screen').classList.remove('hidden'); 
        };
        
        window.backToLogin = function() { 
            document.getElementById('register-screen').classList.add('hidden'); 
            document.getElementById('admin-secret-screen').classList.add('hidden'); 
            document.getElementById('login-screen').classList.remove('hidden'); 
        };
        
        window.showAdminSecret = function() { 
            document.getElementById('login-screen').classList.add('hidden'); 
            document.getElementById('admin-secret-screen').classList.remove('hidden'); 
        };
        
        window.resetAdminWithSecret = function() {
            const secretKey = document.getElementById('admin-secret-key').value;
            const newPass = document.getElementById('admin-new-password-secret').value;
            if (secretKey !== SECRET_ADMIN_KEY) { 
                alert('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á'); 
                return; 
            }
            if (newPass) { 
                ADMIN_CRED.password = newPass; 
                alert('‚úÖ –ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏–∑–º–µ–Ω–µ–Ω! –ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å: ' + newPass); 
            }
            backToLogin();
        };
        
        window.changeAdminPassword = function() {
            const newPass = document.getElementById('admin-new-pass').value;
            if (newPass) { 
                ADMIN_CRED.password = newPass; 
                alert('‚úÖ –ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏–∑–º–µ–Ω–µ–Ω'); 
                document.getElementById('admin-new-pass').value = ''; 
            }
        };
        
        window.changeCuratorPassword = function() {
            const newPass = document.getElementById('curator-new-pass').value;
            if (newPass) { 
                CURATOR_CRED.password = newPass; 
                alert('‚úÖ –ü–∞—Ä–æ–ª—å –∫—É—Ä–∞—Ç–æ—Ä–∞ –∏–∑–º–µ–Ω–µ–Ω'); 
                document.getElementById('curator-new-pass').value = ''; 
            }
        };
        
        function loadMessageDriversList() {
            let html = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤–æ–¥–∏—Ç–µ–ª—è</option>';
            LOCAL_DRIVERS.forEach(driver => { 
                html += `<option value="${driver.phone}">${driver.short || driver.name}</option>`; 
            });
            document.getElementById('message-driver-select').innerHTML = html;
        }
        
        window.exportBackup = function() {
            const backup = { 
                drivers: LOCAL_DRIVERS, 
                trips: LOCAL_TRIPS, 
                messages: LOCAL_MESSAGES, 
                archive: LOCAL_ARCHIVE, 
                rate: currentRate, 
                adminCred: ADMIN_CRED, 
                curatorCred: CURATOR_CRED, 
                timestamp: new Date().toISOString() 
            };
            const blob = new Blob([JSON.stringify(backup, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob); 
            const a = document.createElement('a');
            a.href = url; 
            a.download = `shintorg_backup_${new Date().toISOString().slice(0,10)}.json`; 
            a.click();
            URL.revokeObjectURL(url); 
            alert('‚úÖ –ë–µ–∫–∞–ø —Å–æ—Ö—Ä–∞–Ω–µ–Ω');
        };
        
        window.importBackup = function() {
            const fileInput = document.getElementById('backup-file');
            if (!fileInput.files[0]) { 
                alert('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª'); 
                return; 
            }
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    if (backup.drivers) LOCAL_DRIVERS = backup.drivers;
                    if (backup.trips) LOCAL_TRIPS = backup.trips;
                    if (backup.messages) LOCAL_MESSAGES = backup.messages;
                    if (backup.archive) LOCAL_ARCHIVE = backup.archive;
                    if (backup.rate) currentRate = backup.rate;
                    if (backup.adminCred) ADMIN_CRED = backup.adminCred;
                    if (backup.curatorCred) CURATOR_CRED = backup.curatorCred;
                    alert('‚úÖ –ë–µ–∫–∞–ø –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
                    if (currentRole === 'admin') loadAdminData();
                    if (currentRole === 'curator') loadCuratorData();
                } catch (e) { 
                    alert('‚ùå –û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è'); 
                }
            };
            reader.readAsText(fileInput.files[0]);
        };
        
        function startShiftTimer() {
            if (shiftTimer) clearInterval(shiftTimer);
            shiftTimer = setInterval(() => {
                if (!shiftActive) return;
                const diff = Math.floor((new Date() - shiftStartTime) / 1000);
                const h = Math.floor(diff / 3600).toString().padStart(2, '0');
                const m = Math.floor((diff % 3600) / 60).toString().padStart(2, '0');
                const s = (diff % 60).toString().padStart(2, '0');
                document.getElementById('timer-display').innerText = `${h}:${m}:${s}`;
            }, 1000);
        }
        
        function addToOfflineQueue(action, data) {
            let queue = JSON.parse(localStorage.getItem('shintorg_offline_queue') || '[]');
            queue.push({ action, data, timestamp: Date.now() });
            localStorage.setItem('shintorg_offline_queue', JSON.stringify(queue));
        }
        
        window.logout = function() {
            if (geoWatchId) navigator.geolocation.clearWatch(geoWatchId);
            if (shiftTimer) clearInterval(shiftTimer);
            if (unsubscribeDrivers) unsubscribeDrivers();
            if (unsubscribeTrips) unsubscribeTrips();
            if (unsubscribeMessages) unsubscribeMessages();
            if (unsubscribeArchive) unsubscribeArchive();
            currentUser = null; 
            currentRole = null; 
            shiftActive = false;
            localStorage.removeItem('shintorg_current_user'); 
            localStorage.removeItem('shintorg_current_role');
            document.getElementById('driver-cabinet').classList.add('hidden');
            document.getElementById('admin-cabinet').classList.add('hidden');
            document.getElementById('curator-cabinet').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
            closeMap();
            document.getElementById('timer-display').innerText = '00:00:00';
            document.getElementById('shift-start-btn').classList.remove('hidden');
            document.getElementById('shift-end-btn').classList.add('hidden');
        };
        
        // ============ –ó–ê–ü–£–°–ö ============
        window.onload = async function() {
            const hasSession = await loadSession();
            if (!hasSession) {
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('rate-display').innerHTML = `${currentRate} ‚ÇΩ/—á`;
                document.getElementById('current-rate-label').innerHTML = `${currentRate} ‚ÇΩ/—á`;
            }
        };
    </script>
</body>
</html>
