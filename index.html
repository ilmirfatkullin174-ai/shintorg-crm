<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–®–∏–Ω—Ç–æ—Ä–≥ ‚Ä¢ –û—Ñ–ª–∞–π–Ω CRM</title>
    
    <!-- Bootstrap 5 + Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <!-- Leaflet –¥–ª—è –∫–∞—Ä—Ç -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #0a3a4a;
            font-family: 'Inter', 'Segoe UI', Roboto, sans-serif;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 0;
        }
        
        .mobile-container {
            max-width: 450px;
            width: 100%;
            background: #f8fcff;
            min-height: 100vh;
            box-shadow: 0 25px 50px -10px rgba(0,0,0,0.4);
            position: relative;
            overflow-x: hidden;
        }
        
        .app-header {
            background: linear-gradient(135deg, #0f5e7e, #0a405a);
            color: white;
            padding: 20px 18px;
            border-bottom-left-radius: 30px;
            border-bottom-right-radius: 30px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .mobile-card {
            background: white;
            border-radius: 24px;
            padding: 18px;
            margin: 12px 16px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.03);
            border: 1px solid rgba(255,255,255,0.8);
        }
        
        .mobile-btn {
            border-radius: 60px !important;
            padding: 14px 20px !important;
            font-weight: 700 !important;
            border: none !important;
            box-shadow: 0 6px 0 rgba(0,0,0,0.08) !important;
            transition: 0.08s !important;
            width: 100%;
        }
        
        .mobile-btn:active {
            transform: translateY(6px) !important;
            box-shadow: 0 2px 0 rgba(0,0,0,0.08) !important;
        }
        
        .timer-big {
            font-size: 52px;
            font-weight: 900;
            font-family: 'Courier New', monospace;
            text-align: center;
            color: #0f5e7e;
            background: #e8f4fa;
            padding: 16px;
            border-radius: 30px;
            letter-spacing: 6px;
        }
        
        .geo-active {
            background: #d4f0d4;
            color: #1e6b3b;
            padding: 10px 16px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .geo-inactive {
            background: #ffe6e6;
            color: #b34141;
            padding: 10px 16px;
            border-radius: 50px;
        }
        
        .mobile-tabs {
            display: flex;
            background: white;
            border-radius: 50px;
            margin: 12px 16px;
            padding: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
        }
        
        .mobile-tab {
            flex: 1;
            text-align: center;
            padding: 12px 6px;
            border-radius: 50px;
            font-weight: 700;
            font-size: 14px;
            color: #5f7e8c;
            cursor: pointer;
            transition: 0.2s;
        }
        
        .mobile-tab.active {
            background: #0f5e7e;
            color: white;
        }
        
        .report-tabs {
            display: flex;
            background: #f0f7fc;
            border-radius: 50px;
            margin-bottom: 20px;
            padding: 4px;
        }
        
        .report-tab {
            flex: 1;
            text-align: center;
            padding: 12px 6px;
            border-radius: 50px;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: 0.2s;
        }
        
        .report-tab.active {
            background: #0f5e7e;
            color: white;
        }
        
        .status-working {
            background: #d4f0d4;
            color: #1e6b3b;
            padding: 6px 14px;
            border-radius: 50px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .status-intercity {
            background: #ffeab6;
            color: #8e6200;
            padding: 6px 14px;
            border-radius: 50px;
        }
        
        .status-offline {
            background: #ecf0f3;
            color: #5d6f7e;
            padding: 6px 14px;
            border-radius: 50px;
        }
        
        .message-bubble {
            background: #e3f2fd;
            border-radius: 24px 24px 24px 8px;
            padding: 16px;
            margin: 12px 16px;
            border-left: 8px solid #0f5e7e;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .driver-stat-item {
            background: white;
            border-radius: 18px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 6px solid #0f5e7e;
            box-shadow: 0 2px 8px rgba(0,0,0,0.02);
        }
        
        .trip-row {
            background: white;
            border-radius: 16px;
            padding: 14px;
            margin-bottom: 8px;
            border: 1px solid #ecf3f7;
            transition: 0.2s;
        }
        
        .trip-row:hover {
            background: #f8fcff;
            border-color: #0f5e7e;
        }
        
        .summary-card {
            background: linear-gradient(145deg, #f6fafe, #e9f2f8);
            border-radius: 20px;
            padding: 20px;
            margin: 16px 0;
            border: 2px solid rgba(15,94,126,0.1);
        }
        
        .summary-item {
            text-align: center;
            padding: 12px;
            border-radius: 16px;
            background: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.02);
        }
        
        .archive-card {
            background: linear-gradient(145deg, #fcf8e7, #fef9e9);
            border-radius: 20px;
            padding: 18px;
            margin-bottom: 16px;
            border-left: 8px solid #ffae42;
            box-shadow: 0 6px 15px rgba(255,174,66,0.1);
            transition: 0.2s;
        }
        
        .archive-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 25px rgba(255,174,66,0.15);
        }
        
        .archive-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        
        .archive-content {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 2px dashed #ffae42;
        }
        
        .offline-badge {
            background: #ff9800;
            color: white;
            padding: 4px 12px;
            border-radius: 50px;
            font-size: 11px;
            font-weight: 700;
            display: inline-block;
        }
        
        .sync-badge {
            background: #4caf50;
            color: white;
            padding: 4px 12px;
            border-radius: 50px;
            font-size: 11px;
            font-weight: 700;
        }
        
        .hidden {
            display: none !important;
        }
        
        @media (max-width: 450px) {
            .mobile-container { max-width: 100%; }
            .timer-big { font-size: 42px; }
        }
    </style>
</head>
<body>
    <div class="mobile-container" id="app">
        
        <!-- ========== –ò–ù–î–ò–ö–ê–¢–û–†–´ ========== -->
        <div id="sync-indicator" style="position: fixed; top: 10px; right: 10px; z-index: 1000; display: none;">
            <span class="sync-badge"><i class="bi bi-cloud-check"></i> –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...</span>
        </div>
        <div id="offline-indicator" style="position: fixed; top: 10px; right: 10px; z-index: 1000; display: none;">
            <span class="offline-badge"><i class="bi bi-wifi-off"></i> –û—Ñ–ª–∞–π–Ω</span>
        </div>
        
        <!-- ========== –≠–ö–†–ê–ù –ó–ê–ì–†–£–ó–ö–ò ========== -->
        <div id="loading-screen" class="vh-100 d-flex flex-column justify-content-center align-items-center" style="background: linear-gradient(145deg, #0f5e7e, #0a405a);">
            <div class="spinner-border text-white mb-3" style="width: 4rem; height: 4rem;"></div>
            <h4 class="text-white">–®–∏–Ω—Ç–æ—Ä–≥ –°—É—Ä–≥—É—Ç</h4>
            <p class="text-white-50">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        </div>
        
        <!-- ========== –≠–ö–†–ê–ù –í–•–û–î–ê ========== -->
        <div id="login-screen" class="hidden">
            <div class="app-header text-center">
                <h2><i class="bi bi-truck"></i> –®–ò–ù–¢–û–†–ì</h2>
                <p class="mb-0 opacity-75">–£—á–µ—Ç —Å–º–µ–Ω –∏ –∑–∞—Ä–∞–±–æ—Ç–∫–∞</p>
            </div>
            
            <div class="mobile-card mt-4">
                <div class="mobile-tabs mb-4" id="login-tabs">
                    <div class="mobile-tab active" onclick="switchLoginTab('driver')">
                        <i class="bi bi-person"></i> –í–æ–¥–∏—Ç–µ–ª—å
                    </div>
                    <div class="mobile-tab" onclick="switchLoginTab('admin')">
                        <i class="bi bi-shield-lock"></i> –ê–¥–º–∏–Ω
                    </div>
                    <div class="mobile-tab" onclick="switchLoginTab('curator')">
                        <i class="bi bi-eye"></i> –ö—É—Ä–∞—Ç–æ—Ä
                    </div>
                </div>
                
                <!-- –í–û–î–ò–¢–ï–õ–¨ -->
                <div id="driver-login-panel">
                    <div class="mb-3">
                        <input type="text" class="form-control form-control-lg rounded-pill" id="driver-login" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω / –õ–æ–≥–∏–Ω" value="+79991234567">
                    </div>
                    <div class="mb-4">
                        <input type="password" class="form-control form-control-lg rounded-pill" id="driver-password" placeholder="–ü–∞—Ä–æ–ª—å" value="123456">
                    </div>
                    <button class="btn btn-primary mobile-btn" onclick="loginDriver()">
                        <i class="bi bi-box-arrow-in-right"></i> –í–æ–π—Ç–∏
                    </button>
                    <div class="text-center mt-4">
                        <a href="#" onclick="showRegister()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
                    </div>
                </div>
                
                <!-- –ê–î–ú–ò–ù -->
                <div id="admin-login-panel" class="hidden">
                    <div class="mb-3">
                        <input type="text" class="form-control form-control-lg rounded-pill" id="admin-login" placeholder="–õ–æ–≥–∏–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞">
                    </div>
                    <div class="mb-4">
                        <input type="password" class="form-control form-control-lg rounded-pill" id="admin-password" placeholder="–ü–∞—Ä–æ–ª—å">
                    </div>
                    <button class="btn btn-primary mobile-btn" style="background: #8e44ad;" onclick="loginAdmin()">
                        <i class="bi bi-shield-lock"></i> –í–æ–π—Ç–∏
                    </button>
                    <div class="text-center mt-3">
                        <a href="#" onclick="showAdminSecret()">–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</a>
                    </div>
                </div>
                
                <!-- –ö–£–†–ê–¢–û–† -->
                <div id="curator-login-panel" class="hidden">
                    <div class="mb-3">
                        <input type="text" class="form-control form-control-lg rounded-pill" id="curator-login" placeholder="–õ–æ–≥–∏–Ω –∫—É—Ä–∞—Ç–æ—Ä–∞">
                    </div>
                    <div class="mb-4">
                        <input type="password" class="form-control form-control-lg rounded-pill" id="curator-password" placeholder="–ü–∞—Ä–æ–ª—å">
                    </div>
                    <button class="btn btn-primary mobile-btn" style="background: #2980b9;" onclick="loginCurator()">
                        <i class="bi bi-eye"></i> –í–æ–π—Ç–∏
                    </button>
                </div>
            </div>
            
            <div class="mobile-card bg-light">
                <div class="row text-center">
                    <div class="col-6">
                        <i class="bi bi-building fs-2" style="color: #0f5e7e;"></i>
                        <h6>–ì–æ—Ä–æ–¥</h6>
                        <span class="badge bg-white text-dark p-2" id="rate-display">1400 ‚ÇΩ/—á</span>
                    </div>
                    <div class="col-6">
                        <i class="bi bi-tree fs-2" style="color: #b86d0e;"></i>
                        <h6>–ú–µ–∂–≥–æ—Ä–æ–¥</h6>
                        <span class="badge bg-white text-dark p-2">–°—Ç–∞–≤–∫–∞ –≤–æ–¥–∏—Ç–µ–ª—è</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ========== –°–ï–ö–†–ï–¢–ù–´–ô –í–•–û–î ========== -->
        <div id="admin-secret-screen" class="hidden">
            <div class="app-header">
                <button class="btn btn-sm btn-light position-absolute" style="left: 15px; top: 15px; border-radius: 50px;" onclick="backToLogin()">
                    <i class="bi bi-arrow-left"></i>
                </button>
                <h4 class="text-center">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ</h4>
            </div>
            <div class="mobile-card mt-4">
                <div class="text-center mb-4">
                    <i class="bi bi-shield-shaded" style="font-size: 64px; color: #8e44ad;"></i>
                    <h5 class="mt-3">–°–µ–∫—Ä–µ—Ç–Ω—ã–π –≤—Ö–æ–¥</h5>
                </div>
                <div class="mb-3">
                    <input type="password" class="form-control form-control-lg rounded-pill" id="admin-secret-key" placeholder="–°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á">
                </div>
                <div class="mb-3">
                    <input type="password" class="form-control form-control-lg rounded-pill" id="admin-new-password-secret" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å">
                </div>
                <button class="btn btn-warning mobile-btn" onclick="resetAdminWithSecret()">
                    <i class="bi bi-check-circle"></i> –í–æ–π—Ç–∏ –∏ —Å–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å
                </button>
            </div>
        </div>
        
        <!-- ========== –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø ========== -->
        <div id="register-screen" class="hidden">
            <div class="app-header">
                <button class="btn btn-sm btn-light position-absolute" style="left: 15px; top: 15px; border-radius: 50px;" onclick="backToLogin()">
                    <i class="bi bi-arrow-left"></i>
                </button>
                <h4 class="text-center">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h4>
            </div>
            <div class="mobile-card mt-4">
                <div class="mb-3">
                    <input type="text" class="form-control form-control-lg rounded-pill" id="reg-name" placeholder="–§–ò–û –ø–æ–ª–Ω–æ—Å—Ç—å—é">
                </div>
                <div class="mb-3">
                    <input type="text" class="form-control form-control-lg rounded-pill" id="reg-phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω (–ª–æ–≥–∏–Ω)">
                </div>
                <div class="mb-4">
                    <input type="password" class="form-control form-control-lg rounded-pill" id="reg-pass" placeholder="–ü–∞—Ä–æ–ª—å">
                </div>
                <button class="btn btn-success mobile-btn" onclick="registerDriver()">
                    <i class="bi bi-check-circle"></i> –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
                </button>
            </div>
        </div>
        
        <!-- ========== –ö–ê–ë–ò–ù–ï–¢ –í–û–î–ò–¢–ï–õ–Ø ========== -->
        <div id="driver-cabinet" class="hidden">
            <div class="app-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0"><i class="bi bi-truck"></i> –®–ò–ù–¢–û–†–ì</h4>
                <span class="badge bg-white text-dark p-3 rounded-pill" id="driver-name-badge"></span>
            </div>
            
            <!-- –°–¢–ê–¢–ò–°–¢–ò–ö–ê –í–û–î–ò–¢–ï–õ–Ø -->
            <div class="mobile-card bg-white">
                <div class="row">
                    <div class="col-6">
                        <small class="text-secondary">–°–µ–≥–æ–¥–Ω—è</small>
                        <h3 class="text-success fw-bold" id="driver-today-earn">0 ‚ÇΩ</h3>
                        <small id="driver-today-hours">0 —á</small>
                    </div>
                    <div class="col-6">
                        <small class="text-secondary">–ó–∞ –º–µ—Å—è—Ü</small>
                        <h3 class="text-primary fw-bold" id="driver-month-earn">0 ‚ÇΩ</h3>
                        <small id="driver-total-earn">–≤—Å–µ–≥–æ: 0 ‚ÇΩ</small>
                    </div>
                </div>
            </div>
            
            <!-- –°–û–û–ë–©–ï–ù–ò–Ø -->
            <div id="driver-messages-container"></div>
            
            <!-- –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –†–ï–ñ–ò–ú–û–í -->
            <div class="d-flex gap-2 mx-3 my-3">
                <button class="btn btn-primary flex-fill rounded-pill" onclick="switchDriverMode('city')">
                    <i class="bi bi-building"></i> –ì–æ—Ä–æ–¥
                </button>
                <button class="btn btn-outline-primary flex-fill rounded-pill" onclick="switchDriverMode('inter')">
                    <i class="bi bi-route"></i> –ú–µ–∂–≥–æ—Ä–æ–¥
                </button>
            </div>
            
            <!-- –ì–û–†–û–î -->
            <div id="driver-city-panel">
                <div class="mobile-card">
                    <div class="timer-big mb-3" id="timer-display">00:00:00</div>
                    
                    <button class="btn btn-success mobile-btn mb-2" id="shift-start-btn" onclick="startShift()">
                        <i class="bi bi-play-fill"></i> –ù–∞—á–∞—Ç—å —Å–º–µ–Ω—É
                    </button>
                    
                    <button class="btn btn-warning mobile-btn mb-2 hidden" id="shift-end-btn" onclick="endShift()">
                        <i class="bi bi-stop-fill"></i> –ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–º–µ–Ω—É
                    </button>
                    
                    <div class="mt-3">
                        <textarea class="form-control rounded-4" id="shift-comment" rows="2" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ —Å–º–µ–Ω–µ..."></textarea>
                    </div>
                    
                    <div class="mt-3 p-3 rounded-4 text-center" id="geo-status-block">
                        <span class="geo-inactive"><i class="bi bi-satellite"></i> –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞</span>
                    </div>
                </div>
            </div>
            
            <!-- –ú–ï–ñ–ì–û–†–û–î -->
            <div id="driver-inter-panel" class="hidden">
                <div class="mobile-card">
                    <div class="mb-3">
                        <input type="text" class="form-control form-control-lg rounded-pill" id="inter-direction" placeholder="–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ">
                    </div>
                    <div class="mb-3">
                        <input type="number" class="form-control form-control-lg rounded-pill" id="inter-sum" placeholder="–°—É–º–º–∞ —Å—Ç–∞–≤–∫–∏">
                    </div>
                    <div class="mb-3">
                        <textarea class="form-control rounded-4" id="inter-comment" rows="2" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ —Ä–µ–π—Å—É..."></textarea>
                    </div>
                    <button class="btn btn-warning mobile-btn" onclick="addIntercityTrip()">
                        <i class="bi bi-truck"></i> –ü–æ–µ—Ö–∞–ª!
                    </button>
                </div>
            </div>
            
            <!-- –ò–°–¢–û–†–ò–Ø –ü–û–ï–ó–î–û–ö -->
            <div class="mobile-card">
                <h5 class="mb-3"><i class="bi bi-clock-history"></i> –ú–æ–∏ –ø–æ–µ–∑–¥–∫–∏</h5>
                <div style="max-height: 350px; overflow-y: auto;">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>–î–∞—Ç–∞</th>
                                <th>–¢–∏–ø</th>
                                <th>–°—É–º–º–∞</th>
                                <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                            </tr>
                        </thead>
                        <tbody id="driver-trips-table"></tbody>
                    </table>
                </div>
            </div>
            
            <div class="text-center mb-4">
                <button class="btn btn-outline-secondary rounded-pill px-5" onclick="logout()">
                    <i class="bi bi-box-arrow-right"></i> –í—ã–π—Ç–∏
                </button>
            </div>
        </div>
        
        <!-- ========== –ö–ê–ë–ò–ù–ï–¢ –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê ========== -->
        <div id="admin-cabinet" class="hidden">
            <div class="app-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0"><i class="bi bi-shield-lock"></i> –ê–î–ú–ò–ù</h4>
                <button class="btn btn-sm btn-light rounded-pill px-4" onclick="logout()">
                    <i class="bi bi-box-arrow-right"></i>
                </button>
            </div>
            
            <!-- –°–¢–ê–¢–ò–°–¢–ò–ö–ê -->
            <div class="row mx-2 my-3 g-2">
                <div class="col-4">
                    <div class="bg-primary text-white p-3 rounded-4 text-center">
                        <small>–ê–∫—Ç–∏–≤–Ω—ã</small>
                        <h3 id="admin-active-count">0</h3>
                    </div>
                </div>
                <div class="col-4">
                    <div class="bg-warning p-3 rounded-4 text-center">
                        <small>–ù–∞ —Å–º–µ–Ω–µ</small>
                        <h3 id="admin-city-count">0</h3>
                    </div>
                </div>
                <div class="col-4">
                    <div class="bg-success text-white p-3 rounded-4 text-center">
                        <small>–ú–µ–∂–≥–æ—Ä–æ–¥</small>
                        <h3 id="admin-inter-count">0</h3>
                    </div>
                </div>
            </div>
            
            <!-- –í–ö–õ–ê–î–ö–ò -->
            <div class="mobile-tabs">
                <div class="mobile-tab active" onclick="switchAdminTab('drivers')">–ê–∫—Ç–∏–≤–Ω—ã–µ</div>
                <div class="mobile-tab" onclick="switchAdminTab('all-drivers')">–í—Å–µ –≤–æ–¥–∏—Ç–µ–ª–∏</div>
                <div class="mobile-tab" onclick="switchAdminTab('trips')">–ü–æ–µ–∑–¥–∫–∏</div>
                <div class="mobile-tab" onclick="switchAdminTab('reports')">–û—Ç—á–µ—Ç—ã</div>
                <div class="mobile-tab" onclick="switchAdminTab('archive')">–ê—Ä—Ö–∏–≤</div>
                <div class="mobile-tab" onclick="switchAdminTab('settings')">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
            </div>
            
            <!-- ===== –í–ö–õ–ê–î–ö–ê: –ê–ö–¢–ò–í–ù–´–ï –í–û–î–ò–¢–ï–õ–ò ===== -->
            <div id="admin-drivers-tab">
                <div class="mobile-card">
                    <h5 class="mb-3"><i class="bi bi-people-fill"></i> –ê–∫—Ç–∏–≤–Ω—ã–µ –≤–æ–¥–∏—Ç–µ–ª–∏</h5>
                    <p class="text-secondary small">–û—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤–æ–¥–∏—Ç–µ–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞—á–∏–Ω–∞–ª–∏ —Å–º–µ–Ω—É –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ</p>
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>–í–æ–¥–∏—Ç–µ–ª—å</th>
                                    <th>–°—Ç–∞—Ç—É—Å</th>
                                    <th>üìç</th>
                                    <th>–ö–∞—Ä—Ç–∞</th>
                                    <th>–ü–∞—Ä–æ–ª—å</th>
                                </tr>
                            </thead>
                            <tbody id="admin-drivers-table-mobile"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- –°–û–û–ë–©–ï–ù–ò–Ø -->
                <div class="mobile-card">
                    <h5 class="mb-3"><i class="bi bi-chat-dots"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</h5>
                    <select class="form-select rounded-pill mb-2" id="message-driver-select">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤–æ–¥–∏—Ç–µ–ª—è</option>
                    </select>
                    <textarea class="form-control rounded-4 mb-2" id="message-text" rows="2" placeholder="–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è..."></textarea>
                    <button class="btn btn-primary mobile-btn" onclick="sendMessageToDriver()">
                        <i class="bi bi-send"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                    </button>
                    
                    <hr class="my-3">
                    <h6><i class="bi bi-envelope-check"></i> –°—Ç–∞—Ç—É—Å —Å–æ–æ–±—â–µ–Ω–∏–π</h6>
                    <div id="message-status-container" style="max-height: 200px; overflow-y: auto;"></div>
                </div>
            </div>
            
            <!-- ===== –í–ö–õ–ê–î–ö–ê: –í–°–ï –í–û–î–ò–¢–ï–õ–ò ===== -->
            <div id="admin-all-drivers-tab" class="hidden">
                <div class="mobile-card">
                    <h5 class="mb-3"><i class="bi bi-database"></i> –í—Å–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–æ–¥–∏—Ç–µ–ª–∏</h5>
                    <div style="max-height: 500px; overflow-y: auto;">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>–í–æ–¥–∏—Ç–µ–ª—å</th>
                                    <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                                    <th>–ü–∞—Ä–æ–ª—å</th>
                                    <th>–°—Ç–∞—Ç—É—Å</th>
                                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody id="admin-all-drivers-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- ===== –í–ö–õ–ê–î–ö–ê: –ü–û–ï–ó–î–ö–ò ===== -->
            <div id="admin-trips-tab" class="hidden">
                <div class="mobile-card">
                    <h5 class="mb-3"><i class="bi bi-pencil-square"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–µ–∑–¥–æ–∫</h5>
                    <div style="max-height: 500px; overflow-y: auto;">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>–í–æ–¥–∏—Ç–µ–ª—å</th>
                                    <th>–î–∞—Ç–∞</th>
                                    <th>–¢–∏–ø</th>
                                    <th>–ß–∞—Å—ã</th>
                                    <th>–°—É–º–º–∞</th>
                                    <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="admin-trips-table-mobile"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- ===== –í–ö–õ–ê–î–ö–ê: –û–¢–ß–ï–¢–´ ===== -->
            <div id="admin-reports-tab" class="hidden">
                <div class="mobile-card">
                    <h5 class="mb-3 text-center">
                        <i class="bi bi-calendar-check"></i> –û—Ç—á–µ—Ç –ø–æ –º–µ—Å—è—Ü–∞–º
                    </h5>
                    
                    <!-- –í–´–ë–û–† –ú–ï–°–Ø–¶–ê -->
                    <div class="d-flex gap-2 mb-4">
                        <select class="form-select rounded-pill" id="report-month-select" onchange="loadAdminMonthReport()">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü</option>
                        </select>
                        <button class="btn btn-outline-primary rounded-pill px-4" onclick="loadAdminMonthReport()">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                    
                    <!-- –í–ö–õ–ê–î–ö–ò –û–¢–ß–ï–¢–û–í -->
                    <div class="report-tabs mb-3">
                        <div class="report-tab active" onclick="switchAdminReportTab('daily')">
                            <i class="bi bi-list-ul"></i> –ö—Ç–æ –∫–æ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞–ª
                        </div>
                        <div class="report-tab" onclick="switchAdminReportTab('summary')">
                            <i class="bi bi-pie-chart"></i> –ò—Ç–æ–≥–∏ –ø–æ –≤–æ–¥–∏—Ç–µ–ª—è–º
                        </div>
                    </div>
                    
                    <!-- –ü–û–°–ú–ï–ù–ù–´–ô –û–¢–ß–ï–¢ -->
                    <div id="admin-daily-report-container">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="fw-bold">–ü–æ–µ–∑–¥–∫–∏ –∑–∞ –º–µ—Å—è—Ü</h6>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-success" onclick="exportDailyReportToExcel()">
                                    <i class="bi bi-file-earmark-excel"></i>
                                </button>
                                <button class="btn btn-sm btn-primary" onclick="printDailyReport()">
                                    <i class="bi bi-printer"></i>
                                </button>
                            </div>
                        </div>
                        <div id="admin-daily-report-content" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>
                    
                    <!-- –°–í–û–î–ù–´–ô –û–¢–ß–ï–¢ -->
                    <div id="admin-summary-report-container" class="hidden">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="fw-bold">–°–≤–æ–¥–∫–∞ –ø–æ –≤–æ–¥–∏—Ç–µ–ª—è–º</h6>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-success" onclick="exportSummaryReportToExcel()">
                                    <i class="bi bi-file-earmark-excel"></i>
                                </button>
                                <button class="btn btn-sm btn-primary" onclick="printSummaryReport()">
                                    <i class="bi bi-printer"></i>
                                </button>
                            </div>
                        </div>
                        <div id="admin-summary-report-content" style="max-height: 400px; overflow-y: auto;"></div>
                        
                        <!-- –û–ë–©–ò–ô –ò–¢–û–ì -->
                        <div class="summary-card mt-3">
                            <div class="row g-2">
                                <div class="col-6">
                                    <div class="summary-item">
                                        <small class="text-secondary">–í—Å–µ–≥–æ —á–∞—Å–æ–≤ (–≥–æ—Ä–æ–¥)</small>
                                        <h4 class="text-primary fw-bold mb-0" id="admin-total-hours">0 —á</h4>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="summary-item">
                                        <small class="text-secondary">–í—Å–µ–≥–æ –ø–æ–µ–∑–¥–æ–∫ (–ú–ì)</small>
                                        <h4 class="text-warning fw-bold mb-0" id="admin-total-inter">0</h4>
                                    </div>
                                </div>
                                <div class="col-12 mt-2">
                                    <div class="summary-item bg-success bg-opacity-10">
                                        <small class="text-success">–û–ë–©–ò–ô –ó–ê–†–ê–ë–û–¢–û–ö</small>
                                        <h3 class="text-success fw-bold mb-0" id="admin-total-earn">0 ‚ÇΩ</h3>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- –ö–ù–û–ü–ö–ê –ó–ê–ö–†–´–¢–ò–Ø –ú–ï–°–Ø–¶–ê -->
                    <div class="mt-4">
                        <button class="btn btn-warning mobile-btn" onclick="closeMonth()">
                            <i class="bi bi-file-earmark-check"></i> –ó–∞–∫—Ä—ã—Ç—å –º–µ—Å—è—Ü
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- ===== –í–ö–õ–ê–î–ö–ê: –ê–†–•–ò–í ===== -->
            <div id="admin-archive-tab" class="hidden">
                <div class="mobile-card">
                    <h5 class="mb-3"><i class="bi bi-archive"></i> –ê—Ä—Ö–∏–≤ –∑–∞–∫—Ä—ã—Ç—ã—Ö –º–µ—Å—è—Ü–µ–≤</h5>
                    
                    <!-- –ü–û–ò–°–ö –ü–û –ê–†–•–ò–í–£ -->
                    <div class="d-flex gap-2 mb-4">
                        <select class="form-select rounded-pill" id="admin-archive-month-select" onchange="loadAdminArchiveMonth()">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü</option>
                        </select>
                        <button class="btn btn-outline-primary rounded-pill px-4" onclick="loadAdminArchiveMonth()">
                            <i class="bi bi-search"></i>
                        </button>
                        <button class="btn btn-outline-danger rounded-pill px-4" onclick="clearAllArchives()">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                    
                    <!-- –°–û–î–ï–†–ñ–ò–ú–û–ï –ê–†–•–ò–í–ê -->
                    <div id="admin-archive-content" style="max-height: 500px; overflow-y: auto;"></div>
                </div>
            </div>
            
            <!-- ===== –í–ö–õ–ê–î–ö–ê: –ù–ê–°–¢–†–û–ô–ö–ò ===== -->
            <div id="admin-settings-tab" class="hidden">
                <div class="mobile-card">
                    <h5 class="mb-3"><i class="bi bi-tag"></i> –¢–∞—Ä–∏—Ñ –ø–æ –≥–æ—Ä–æ–¥—É</h5>
                    <div class="input-group mb-3">
                        <input type="number" class="form-control rounded-pill-start" id="admin-rate-input" value="1400">
                        <span class="input-group-text bg-primary text-white rounded-pill-end">‚ÇΩ/—á</span>
                        <button class="btn btn-success rounded-pill ms-2 px-4" onclick="updateRate()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    </div>
                </div>
                
                <div class="mobile-card">
                    <h5 class="mb-3"><i class="bi bi-key"></i> –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª–µ–π</h5>
                    <div class="mb-3">
                        <label class="form-label">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</label>
                        <div class="input-group">
                            <input type="password" class="form-control rounded-pill-start" id="admin-new-pass" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å">
                            <button class="btn btn-warning rounded-pill-end" onclick="changeAdminPassword()">–ò–∑–º–µ–Ω–∏—Ç—å</button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–ö—É—Ä–∞—Ç–æ—Ä</label>
                        <div class="input-group">
                            <input type="password" class="form-control rounded-pill-start" id="curator-new-pass" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å">
                            <button class="btn btn-outline-warning rounded-pill-end" onclick="changeCuratorPassword()">–ò–∑–º–µ–Ω–∏—Ç—å</button>
                        </div>
                    </div>
                </div>
                
                <!-- –ë–ï–ö–ê–ü -->
                <div class="mobile-card">
                    <h5 class="mb-3"><i class="bi bi-cloud-arrow-up"></i> –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ</h5>
                    <button class="btn btn-outline-primary mobile-btn mb-2" onclick="exportBackup()">
                        <i class="bi bi-download"></i> –°–∫–∞—á–∞—Ç—å –±–µ–∫–∞–ø
                    </button>
                    <div class="mt-2">
                        <label class="form-label">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –±–µ–∫–∞–ø–∞</label>
                        <input type="file" class="form-control rounded-pill" id="backup-file" accept=".json">
                        <button class="btn btn-outline-warning mobile-btn mt-2" onclick="importBackup()">
                            <i class="bi bi-upload"></i> –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ========== –ö–ê–ë–ò–ù–ï–¢ –ö–£–†–ê–¢–û–†–ê ========== -->
        <div id="curator-cabinet" class="hidden">
            <div class="app-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0"><i class="bi bi-eye"></i> –ö–£–†–ê–¢–û–†</h4>
                <button class="btn btn-sm btn-light rounded-pill px-4" onclick="logout()">
                    <i class="bi bi-box-arrow-right"></i>
                </button>
            </div>
            
            <div class="row mx-2 my-3 g-2">
                <div class="col-6">
                    <div class="bg-info text-white p-3 rounded-4 text-center">
                        <small>–ê–∫—Ç–∏–≤–Ω—ã</small>
                        <h3 id="curator-active-count">0</h3>
                    </div>
                </div>
                <div class="col-6">
                    <div class="bg-warning p-3 rounded-4 text-center">
                        <small>–ù–∞ —Å–º–µ–Ω–µ</small>
                        <h3 id="curator-city-count">0</h3>
                    </div>
                </div>
            </div>
            
            <!-- –í–û–î–ò–¢–ï–õ–ò –ù–ê –õ–ò–ù–ò–ò -->
            <div class="mobile-card">
                <h5 class="mb-3"><i class="bi bi-people"></i> –í–æ–¥–∏—Ç–µ–ª–∏ –Ω–∞ –ª–∏–Ω–∏–∏</h5>
                <div style="max-height: 300px; overflow-y: auto;">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>–í–æ–¥–∏—Ç–µ–ª—å</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>üìç</th>
                                <th>–ö–∞—Ä—Ç–∞</th>
                            </tr>
                        </thead>
                        <tbody id="curator-drivers-table"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- –û–¢–ß–ï–¢–´ –ö–£–†–ê–¢–û–†–ê -->
            <div class="mobile-tabs">
                <div class="mobile-tab active" onclick="switchCuratorTab('reports')">–û—Ç—á–µ—Ç—ã</div>
                <div class="mobile-tab" onclick="switchCuratorTab('archive')">–ê—Ä—Ö–∏–≤</div>
            </div>
            
            <!-- –í–ö–õ–ê–î–ö–ê –û–¢–ß–ï–¢–û–í -->
            <div id="curator-reports-tab">
                <div class="mobile-card">
                    <h5 class="text-center mb-3">–û—Ç—á–µ—Ç –ø–æ –º–µ—Å—è—Ü–∞–º</h5>
                    
                    <div class="d-flex gap-2 mb-4">
                        <select class="form-select rounded-pill" id="curator-report-month" onchange="loadCuratorMonthReport()">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü</option>
                        </select>
                        <button class="btn btn-outline-primary rounded-pill px-4" onclick="loadCuratorMonthReport()">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                    
                    <div class="report-tabs mb-3">
                        <div class="report-tab active" onclick="switchCuratorReportTab('daily')">
                            <i class="bi bi-list-ul"></i> –ö—Ç–æ –∫–æ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞–ª
                        </div>
                        <div class="report-tab" onclick="switchCuratorReportTab('summary')">
                            <i class="bi bi-pie-chart"></i> –ò—Ç–æ–≥–∏ –ø–æ –≤–æ–¥–∏—Ç–µ–ª—è–º
                        </div>
                    </div>
                    
                    <div id="curator-daily-report-container">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="fw-bold">–ü–æ–µ–∑–¥–∫–∏ –∑–∞ –º–µ—Å—è—Ü</h6>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-success" onclick="exportCuratorDailyReportToExcel()">
                                    <i class="bi bi-file-earmark-excel"></i>
                                </button>
                                <button class="btn btn-sm btn-primary" onclick="printCuratorDailyReport()">
                                    <i class="bi bi-printer"></i>
                                </button>
                            </div>
                        </div>
                        <div id="curator-daily-report-content" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>
                    
                    <div id="curator-summary-report-container" class="hidden">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="fw-bold">–°–≤–æ–¥–∫–∞ –ø–æ –≤–æ–¥–∏—Ç–µ–ª—è–º</h6>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-success" onclick="exportCuratorSummaryReportToExcel()">
                                    <i class="bi bi-file-earmark-excel"></i>
                                </button>
                                <button class="btn btn-sm btn-primary" onclick="printCuratorSummaryReport()">
                                    <i class="bi bi-printer"></i>
                                </button>
                            </div>
                        </div>
                        <div id="curator-summary-report-content" style="max-height: 400px; overflow-y: auto;"></div>
                        
                        <div class="summary-card mt-3">
                            <div class="row g-2">
                                <div class="col-6">
                                    <div class="summary-item">
                                        <small class="text-secondary">–í—Å–µ–≥–æ —á–∞—Å–æ–≤ (–≥–æ—Ä–æ–¥)</small>
                                        <h4 class="text-primary fw-bold mb-0" id="curator-total-hours">0 —á</h4>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="summary-item">
                                        <small class="text-secondary">–í—Å–µ–≥–æ –ø–æ–µ–∑–¥–æ–∫ (–ú–ì)</small>
                                        <h4 class="text-warning fw-bold mb-0" id="curator-total-inter">0</h4>
                                    </div>
                                </div>
                                <div class="col-12 mt-2">
                                    <div class="summary-item bg-success bg-opacity-10">
                                        <small class="text-success">–û–ë–©–ò–ô –ó–ê–†–ê–ë–û–¢–û–ö</small>
                                        <h3 class="text-success fw-bold mb-0" id="curator-total-earn">0 ‚ÇΩ</h3>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <button class="btn btn-warning mobile-btn" onclick="closeMonth()">
                            <i class="bi bi-file-earmark-check"></i> –ó–∞–∫—Ä—ã—Ç—å –º–µ—Å—è—Ü
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- –í–ö–õ–ê–î–ö–ê –ê–†–•–ò–í–ê –ö–£–†–ê–¢–û–†–ê -->
            <div id="curator-archive-tab" class="hidden">
                <div class="mobile-card">
                    <h5><i class="bi bi-archive"></i> –ê—Ä—Ö–∏–≤ –∑–∞–∫—Ä—ã—Ç—ã—Ö –º–µ—Å—è—Ü–µ–≤</h5>
                    
                    <div class="d-flex gap-2 mb-4">
                        <select class="form-select rounded-pill" id="curator-archive-month-select" onchange="loadCuratorArchiveMonth()">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü</option>
                        </select>
                        <button class="btn btn-outline-primary rounded-pill px-4" onclick="loadCuratorArchiveMonth()">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                    
                    <div id="curator-archive-content" style="max-height: 500px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>
        
        <!-- ========== –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –ö–ê–†–¢–´ ========== -->
        <div id="map-modal" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); z-index: 2000; display: flex; flex-direction: column;">
            <div style="padding: 16px; background: #0f5e7e; color: white; display: flex; justify-content: space-between;">
                <h5 class="mb-0" id="map-driver-name"></h5>
                <button class="btn btn-sm btn-light rounded-pill px-4" onclick="closeMap()">
                    <i class="bi bi-x-lg"></i> –ó–∞–∫—Ä—ã—Ç—å
                </button>
            </div>
            <div id="driver-map" style="flex: 1; width: 100%;"></div>
        </div>
    </div>

    <script>
        // ============ –ì–õ–û–ë–ê–õ–¨–ù–´–ï –î–ê–ù–ù–´–ï ============
        let LOCAL_DRIVERS = [];
        let LOCAL_TRIPS = [];
        let LOCAL_MESSAGES = [];
        let LOCAL_ARCHIVE = [];
        
        // –£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        let ADMIN_CRED = { login: 'admin', password: 'adminshintorg86' };
        let CURATOR_CRED = { login: 'curator', password: 'curator123' };
        
        // –°–ï–ö–†–ï–¢–ù–´–ô –ö–õ–Æ–ß
        const SECRET_ADMIN_KEY = 'shintorg2024super';
        
        // –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        let currentUser = null;
        let currentRole = null;
        let currentRate = 1400;
        
        // –°–º–µ–Ω–∞
        let shiftActive = false;
        let shiftStartTime = null;
        let shiftTimer = null;
        let geoWatchId = null;
        let currentMap = null;
        let mapMarker = null;
        
        // –û—Ñ–ª–∞–π–Ω-–æ—á–µ—Ä–µ–¥—å
        let offlineQueue = [];
        
        // –¢–µ–∫—É—â–∏–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π –º–µ—Å—è—Ü
        let currentReportMonth = null;
        
        // ============ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ============
        window.onload = function() {
            loadFromStorage();
            setupOfflineDetection();
            setupAutoSync();
            
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('rate-display').innerHTML = `${currentRate} ‚ÇΩ/—á`;
            
            // –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
            if (LOCAL_DRIVERS.length === 0) {
                LOCAL_DRIVERS.push({
                    id: '1',
                    name: '–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á',
                    short: '–ò–≤–∞–Ω–æ–≤ –ò.–ò.',
                    phone: '+79991234567',
                    password: '123456',
                    status: 'offline',
                    shiftType: null,
                    shiftStartTime: null,
                    location: '',
                    lat: 61.254,
                    lng: 73.396,
                    lastSeen: null,
                    registeredAt: '2026-02-01'
                });
                
                LOCAL_DRIVERS.push({
                    id: '2',
                    name: '–ü–µ—Ç—Ä–æ–≤ –ü–µ—Ç—Ä –ü–µ—Ç—Ä–æ–≤–∏—á',
                    short: '–ü–µ—Ç—Ä–æ–≤ –ü.–ü.',
                    phone: '+79997654321',
                    password: 'petrov86',
                    status: 'offline',
                    shiftType: null,
                    shiftStartTime: null,
                    location: '',
                    lat: null,
                    lng: null,
                    lastSeen: null,
                    registeredAt: '2026-02-01'
                });
            }
            
            if (LOCAL_TRIPS.length === 0) {
                LOCAL_TRIPS.push({
                    id: '1',
                    driverId: '+79991234567',
                    driverName: '–ò–≤–∞–Ω–æ–≤ –ò.–ò.',
                    date: '2026-02-10',
                    type: '–≥–æ—Ä–æ–¥',
                    hours: 2.5,
                    earn: 3500,
                    comment: '–£–±–æ—Ä–∫–∞ —Å–Ω–µ–≥–∞'
                });
                
                LOCAL_TRIPS.push({
                    id: '2',
                    driverId: '+79991234567',
                    driverName: '–ò–≤–∞–Ω–æ–≤ –ò.–ò.',
                    date: '2026-02-12',
                    type: '–º–µ–∂–≥–æ—Ä–æ–¥',
                    direction: '–õ–∞–Ω–≥–µ–ø–∞—Å',
                    earn: 6000,
                    comment: '–®–∏–Ω—ã'
                });
                
                LOCAL_TRIPS.push({
                    id: '3',
                    driverId: '+79997654321',
                    driverName: '–ü–µ—Ç—Ä–æ–≤ –ü.–ü.',
                    date: '2026-02-11',
                    type: '–º–µ–∂–≥–æ—Ä–æ–¥',
                    direction: '–ö–æ–≥–∞–ª—ã–º',
                    earn: 5400,
                    comment: '–î–æ—Å—Ç–∞–≤–∫–∞'
                });
            }
            
            saveToStorage();
            updateMonthSelectors();
            updateArchiveSelectors();
        };
        
        // ============ localStorage ============
        function loadFromStorage() {
            try {
                const drivers = localStorage.getItem('shintorg_drivers');
                const trips = localStorage.getItem('shintorg_trips');
                const messages = localStorage.getItem('shintorg_messages');
                const archive = localStorage.getItem('shintorg_archive');
                const rate = localStorage.getItem('shintorg_rate');
                
                if (drivers) LOCAL_DRIVERS = JSON.parse(drivers);
                if (trips) LOCAL_TRIPS = JSON.parse(trips);
                if (messages) LOCAL_MESSAGES = JSON.parse(messages);
                if (archive) LOCAL_ARCHIVE = JSON.parse(archive);
                if (rate) currentRate = parseFloat(rate);
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', e);
            }
        }
        
        function saveToStorage() {
            localStorage.setItem('shintorg_drivers', JSON.stringify(LOCAL_DRIVERS));
            localStorage.setItem('shintorg_trips', JSON.stringify(LOCAL_TRIPS));
            localStorage.setItem('shintorg_messages', JSON.stringify(LOCAL_MESSAGES));
            localStorage.setItem('shintorg_archive', JSON.stringify(LOCAL_ARCHIVE));
            localStorage.setItem('shintorg_rate', currentRate.toString());
        }
        
        // ============ –ë–ï–ö–ê–ü ============
        window.exportBackup = function() {
            const backup = {
                drivers: LOCAL_DRIVERS,
                trips: LOCAL_TRIPS,
                messages: LOCAL_MESSAGES,
                archive: LOCAL_ARCHIVE,
                rate: currentRate,
                adminCred: ADMIN_CRED,
                curatorCred: CURATOR_CRED,
                timestamp: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(backup, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `shintorg_backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert('‚úÖ –ë–µ–∫–∞–ø —Å–æ—Ö—Ä–∞–Ω–µ–Ω');
        };
        
        window.importBackup = function() {
            const fileInput = document.getElementById('backup-file');
            if (!fileInput.files[0]) {
                alert('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    
                    if (backup.drivers) LOCAL_DRIVERS = backup.drivers;
                    if (backup.trips) LOCAL_TRIPS = backup.trips;
                    if (backup.messages) LOCAL_MESSAGES = backup.messages;
                    if (backup.archive) LOCAL_ARCHIVE = backup.archive;
                    if (backup.rate) currentRate = backup.rate;
                    if (backup.adminCred) ADMIN_CRED = backup.adminCred;
                    if (backup.curatorCred) CURATOR_CRED = backup.curatorCred;
                    
                    saveToStorage();
                    alert('‚úÖ –ë–µ–∫–∞–ø –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
                    
                    if (currentRole === 'admin') loadAdminData();
                    if (currentRole === 'curator') loadCuratorData();
                } catch (e) {
                    alert('‚ùå –û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è');
                }
            };
            reader.readAsText(fileInput.files[0]);
        };
        
        // ============ –°–ï–ö–†–ï–¢–ù–´–ô –í–•–û–î ============
        window.showAdminSecret = function() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('admin-secret-screen').classList.remove('hidden');
        };
        
        window.resetAdminWithSecret = function() {
            const secretKey = document.getElementById('admin-secret-key').value;
            const newPass = document.getElementById('admin-new-password-secret').value;
            
            if (secretKey !== SECRET_ADMIN_KEY) {
                alert('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á');
                return;
            }
            
            if (newPass) {
                ADMIN_CRED.password = newPass;
                saveToStorage();
                alert('‚úÖ –ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏–∑–º–µ–Ω–µ–Ω! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ —Å –Ω–æ–≤—ã–º –ø–∞—Ä–æ–ª–µ–º.');
            }
            
            backToLogin();
        };
        
        // ============ –û–§–õ–ê–ô–ù ============
        function setupOfflineDetection() {
            window.addEventListener('online', function() {
                document.getElementById('offline-indicator').style.display = 'none';
                processOfflineQueue();
            });
            
            window.addEventListener('offline', function() {
                document.getElementById('offline-indicator').style.display = 'block';
            });
            
            if (!navigator.onLine) {
                document.getElementById('offline-indicator').style.display = 'block';
            }
        }
        
        function setupAutoSync() {
            setInterval(() => {
                if (navigator.onLine) {
                    processOfflineQueue();
                }
            }, 30000);
        }
        
        function processOfflineQueue() {
            if (!navigator.onLine || offlineQueue.length === 0) return;
            
            document.getElementById('sync-indicator').style.display = 'block';
            
            const queue = [...offlineQueue];
            offlineQueue = [];
            localStorage.setItem('shintorg_queue', JSON.stringify(offlineQueue));
            
            setTimeout(() => {
                document.getElementById('sync-indicator').style.display = 'none';
            }, 1000);
        }
        
        // ============ –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ============
        window.switchLoginTab = function(tab) {
            document.querySelectorAll('#login-tabs .mobile-tab').forEach(el => el.classList.remove('active'));
            document.querySelector(`#login-tabs .mobile-tab:nth-child(${tab === 'driver' ? 1 : tab === 'admin' ? 2 : 3})`).classList.add('active');
            
            document.getElementById('driver-login-panel').classList.toggle('hidden', tab !== 'driver');
            document.getElementById('admin-login-panel').classList.toggle('hidden', tab !== 'admin');
            document.getElementById('curator-login-panel').classList.toggle('hidden', tab !== 'curator');
        };
        
        window.loginDriver = function() {
            const phone = document.getElementById('driver-login').value;
            const pass = document.getElementById('driver-password').value;
            
            const driver = LOCAL_DRIVERS.find(d => d.phone === phone && d.password === pass);
            
            if (driver) {
                currentUser = JSON.parse(JSON.stringify(driver));
                currentRole = 'driver';
                
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('driver-cabinet').classList.remove('hidden');
                document.getElementById('driver-name-badge').innerHTML = `<i class="bi bi-person-circle"></i> ${driver.short || driver.name}`;
                
                if (driver.status === 'active' && driver.shiftType === 'city') {
                    shiftActive = true;
                    shiftStartTime = driver.shiftStartTime ? new Date(driver.shiftStartTime) : new Date();
                    
                    document.getElementById('shift-start-btn').classList.add('hidden');
                    document.getElementById('shift-end-btn').classList.remove('hidden');
                    
                    if (shiftTimer) clearInterval(shiftTimer);
                    shiftTimer = setInterval(() => {
                        if (!shiftActive) return;
                        const diff = Math.floor((new Date() - shiftStartTime) / 1000);
                        const h = Math.floor(diff / 3600).toString().padStart(2, '0');
                        const m = Math.floor((diff % 3600) / 60).toString().padStart(2, '0');
                        const s = (diff % 60).toString().padStart(2, '0');
                        document.getElementById('timer-display').innerText = `${h}:${m}:${s}`;
                    }, 1000);
                    
                    startGeolocation();
                }
                
                loadDriverData();
                checkDriverMessages();
                
                alert(`‚úÖ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${driver.short || driver.name}`);
            } else {
                alert('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å');
            }
        };
        
        window.loginAdmin = function() {
            const login = document.getElementById('admin-login').value;
            const pass = document.getElementById('admin-password').value;
            
            if (login === ADMIN_CRED.login && pass === ADMIN_CRED.password) {
                currentRole = 'admin';
                
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('admin-cabinet').classList.remove('hidden');
                
                loadAdminData();
                alert('‚úÖ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä');
            } else {
                alert('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å');
            }
        };
        
        window.loginCurator = function() {
            const login = document.getElementById('curator-login').value;
            const pass = document.getElementById('curator-password').value;
            
            if (login === CURATOR_CRED.login && pass === CURATOR_CRED.password) {
                currentRole = 'curator';
                
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('curator-cabinet').classList.remove('hidden');
                
                loadCuratorData();
                alert('‚úÖ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –ö—É—Ä–∞—Ç–æ—Ä');
            } else {
                alert('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å');
            }
        };
        
        // ============ –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø ============
        window.registerDriver = function() {
            const name = document.getElementById('reg-name').value;
            const phone = document.getElementById('reg-phone').value;
            const pass = document.getElementById('reg-pass').value;
            
            if (!name || !phone || !pass) {
                alert('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }
            
            if (LOCAL_DRIVERS.find(d => d.phone === phone)) {
                alert('‚ùå –≠—Ç–æ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω');
                return;
            }
            
            const nameParts = name.split(' ');
            let short = nameParts[0];
            if (nameParts.length > 1) short += ' ' + nameParts[1][0] + '.';
            if (nameParts.length > 2) short += nameParts[2][0] + '.';
            
            const newDriver = {
                id: Date.now().toString(),
                name: name,
                short: short,
                phone: phone,
                password: pass,
                status: 'offline',
                shiftType: null,
                shiftStartTime: null,
                location: '',
                lat: null,
                lng: null,
                lastSeen: null,
                registeredAt: new Date().toISOString().split('T')[0]
            };
            
            LOCAL_DRIVERS.push(newDriver);
            saveToStorage();
            
            alert('‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ.');
            backToLogin();
        };
        
        // ============ –ì–ï–û–õ–û–ö–ê–¶–ò–Ø ============
        function startGeolocation() {
            if (!currentUser || !navigator.geolocation) return;
            
            if (geoWatchId) navigator.geolocation.clearWatch(geoWatchId);
            
            geoWatchId = navigator.geolocation.watchPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    const driver = LOCAL_DRIVERS.find(d => d.phone === currentUser.phone);
                    if (driver) {
                        driver.lat = lat;
                        driver.lng = lng;
                        driver.location = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                        driver.lastSeen = new Date();
                        saveToStorage();
                    }
                    
                    document.getElementById('geo-status-block').innerHTML = `
                        <span class="geo-active">
                            <i class="bi bi-satellite"></i> üü¢ ${lat.toFixed(4)}, ${lng.toFixed(4)}
                        </span>
                    `;
                    
                    if (currentRole === 'admin') {
                        loadAdminDrivers();
                    }
                    if (currentRole === 'curator') {
                        loadCuratorDrivers();
                    }
                },
                (error) => {
                    document.getElementById('geo-status-block').innerHTML = `
                        <span class="geo-inactive"><i class="bi bi-satellite"></i> üî¥ –û—à–∏–±–∫–∞</span>
                    `;
                },
                {
                    enableHighAccuracy: true,
                    maximumAge: 5000,
                    timeout: 10000
                }
            );
        }
        
        // ============ –ö–ê–†–¢–ê ============
        window.showDriverMap = function(driverPhone, driverName) {
            const driver = LOCAL_DRIVERS.find(d => d.phone === driverPhone);
            if (!driver || !driver.lat || !driver.lng) {
                alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏');
                return;
            }
            
            document.getElementById('map-modal').classList.remove('hidden');
            document.getElementById('map-driver-name').innerHTML = `<i class="bi bi-geo-alt-fill"></i> ${driverName}`;
            
            setTimeout(() => {
                if (currentMap) currentMap.remove();
                
                currentMap = L.map('driver-map').setView([driver.lat, driver.lng], 15);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(currentMap);
                
                if (mapMarker) mapMarker.remove();
                mapMarker = L.marker([driver.lat, driver.lng]).addTo(currentMap)
                    .bindPopup(`<b>${driver.short || driver.name}</b>`)
                    .openPopup();
            }, 100);
        };
        
        window.closeMap = function() {
            document.getElementById('map-modal').classList.add('hidden');
            if (currentMap) {
                currentMap.remove();
                currentMap = null;
            }
        };
        
        // ============ –°–ú–ï–ù–ê ============
        window.startShift = function() {
            if (!currentUser) return;
            
            shiftActive = true;
            shiftStartTime = new Date();
            
            const driver = LOCAL_DRIVERS.find(d => d.phone === currentUser.phone);
            if (driver) {
                driver.status = 'active';
                driver.shiftType = 'city';
                driver.shiftStartTime = shiftStartTime.toISOString();
                saveToStorage();
            }
            
            document.getElementById('shift-start-btn').classList.add('hidden');
            document.getElementById('shift-end-btn').classList.remove('hidden');
            
            if (shiftTimer) clearInterval(shiftTimer);
            shiftTimer = setInterval(() => {
                if (!shiftActive) return;
                const diff = Math.floor((new Date() - shiftStartTime) / 1000);
                const h = Math.floor(diff / 3600).toString().padStart(2, '0');
                const m = Math.floor((diff % 3600) / 60).toString().padStart(2, '0');
                const s = (diff % 60).toString().padStart(2, '0');
                document.getElementById('timer-display').innerText = `${h}:${m}:${s}`;
            }, 1000);
            
            startGeolocation();
            alert('üöï –°–º–µ–Ω–∞ –Ω–∞—á–∞—Ç–∞!');
        };
        
        window.endShift = function() {
            if (!shiftActive || !currentUser) return;
            
            const seconds = Math.floor((new Date() - shiftStartTime) / 1000);
            
            let hours = seconds / 3600;
            let whole = Math.floor(hours);
            let mins = (hours - whole) * 60;
            
            if (mins < 15) hours = whole;
            else if (mins < 45) hours = whole + 0.5;
            else hours = whole + 1;
            if (hours < 1) hours = 1;
            
            const earn = Math.round(hours * currentRate);
            const comment = document.getElementById('shift-comment').value || '';
            
            const newTrip = {
                id: Date.now().toString(),
                driverId: currentUser.phone,
                driverName: currentUser.short || currentUser.name,
                date: new Date().toISOString().split('T')[0],
                type: '–≥–æ—Ä–æ–¥',
                hours: hours,
                earn: earn,
                comment: comment,
                location: currentUser.location || '',
                timestamp: new Date().toISOString()
            };
            
            LOCAL_TRIPS.push(newTrip);
            
            const driver = LOCAL_DRIVERS.find(d => d.phone === currentUser.phone);
            if (driver) {
                driver.status = 'offline';
                driver.shiftType = null;
                driver.shiftStartTime = null;
                saveToStorage();
            }
            
            if (geoWatchId) {
                navigator.geolocation.clearWatch(geoWatchId);
                geoWatchId = null;
            }
            
            shiftActive = false;
            clearInterval(shiftTimer);
            document.getElementById('timer-display').innerText = '00:00:00';
            document.getElementById('shift-start-btn').classList.remove('hidden');
            document.getElementById('shift-end-btn').classList.add('hidden');
            document.getElementById('shift-comment').value = '';
            document.getElementById('geo-status-block').innerHTML = '<span class="geo-inactive"><i class="bi bi-satellite"></i> –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞</span>';
            
            saveToStorage();
            alert(`‚úÖ –°–º–µ–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ: ${earn} ‚ÇΩ`);
            loadDriverData();
        };
        
        // ============ –ú–ï–ñ–ì–û–†–û–î ============
        window.addIntercityTrip = function() {
            if (!currentUser) return;
            
            const direction = document.getElementById('inter-direction').value || '–ú–µ–∂–≥–æ—Ä–æ–¥';
            const sum = parseFloat(document.getElementById('inter-sum').value);
            
            if (!sum || sum <= 0) {
                alert('‚ùå –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É —Å—Ç–∞–≤–∫–∏');
                return;
            }
            
            const comment = document.getElementById('inter-comment').value || '';
            
            const newTrip = {
                id: Date.now().toString(),
                driverId: currentUser.phone,
                driverName: currentUser.short || currentUser.name,
                date: new Date().toISOString().split('T')[0],
                type: '–º–µ–∂–≥–æ—Ä–æ–¥',
                direction: direction,
                earn: sum,
                comment: comment,
                timestamp: new Date().toISOString()
            };
            
            LOCAL_TRIPS.push(newTrip);
            saveToStorage();
            
            document.getElementById('inter-direction').value = '';
            document.getElementById('inter-sum').value = '';
            document.getElementById('inter-comment').value = '';
            
            alert(`üöõ –†–µ–π—Å –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω! ${sum} ‚ÇΩ`);
            loadDriverData();
        };
        
        // ============ –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• –í–û–î–ò–¢–ï–õ–Ø ============
        function loadDriverData() {
            if (!currentUser) return;
            
            const driverTrips = LOCAL_TRIPS.filter(t => t.driverId === currentUser.phone);
            const today = new Date().toISOString().split('T')[0];
            const month = today.slice(0, 7);
            
            const todayTrips = driverTrips.filter(t => t.date === today);
            const todayEarn = todayTrips.reduce((s, t) => s + (t.earn || 0), 0);
            const todayHours = todayTrips.filter(t => t.type === '–≥–æ—Ä–æ–¥').reduce((s, t) => s + (t.hours || 0), 0);
            
            const monthTrips = driverTrips.filter(t => t.date.startsWith(month));
            const monthEarn = monthTrips.reduce((s, t) => s + (t.earn || 0), 0);
            const totalEarn = driverTrips.reduce((s, t) => s + (t.earn || 0), 0);
            
            document.getElementById('driver-today-earn').innerHTML = `${todayEarn} ‚ÇΩ`;
            document.getElementById('driver-today-hours').innerHTML = `${todayHours.toFixed(1)} —á`;
            document.getElementById('driver-month-earn').innerHTML = `${monthEarn} ‚ÇΩ`;
            document.getElementById('driver-total-earn').innerHTML = `–≤—Å–µ–≥–æ: ${totalEarn} ‚ÇΩ`;
            
            let html = '';
            driverTrips.slice().reverse().forEach(trip => {
                html += `<tr>
                    <td>${trip.date}</td>
                    <td><span class="badge ${trip.type === '–≥–æ—Ä–æ–¥' ? 'bg-primary' : 'bg-warning'}">${trip.type}</span></td>
                    <td class="fw-bold">${trip.earn} ‚ÇΩ</td>
                    <td><small class="text-secondary">${trip.comment || ''}</small></td>
                </tr>`;
            });
            document.getElementById('driver-trips-table').innerHTML = html || '<tr><td colspan="4" class="text-center">–ù–µ—Ç –ø–æ–µ–∑–¥–æ–∫</td></tr>';
        }
        
        // ============ –°–û–û–ë–©–ï–ù–ò–Ø ============
        function checkDriverMessages() {
            if (!currentUser) return;
            
            const messages = LOCAL_MESSAGES.filter(m => m.driverPhone === currentUser.phone && !m.read);
            
            if (messages.length > 0) {
                let html = '';
                messages.forEach(msg => {
                    html += `<div class="message-bubble">
                        <div class="d-flex justify-content-between">
                            <strong><i class="bi bi-envelope-fill"></i> –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∞–¥–º–∏–Ω–∞</strong>
                            <small>${msg.time || ''}</small>
                        </div>
                        <p class="mb-2 mt-2">${msg.text}</p>
                        <button class="btn btn-sm btn-outline-primary rounded-pill px-4" onclick="markMessageRead('${msg.id}')">
                            <i class="bi bi-check2-all"></i> –ü—Ä–æ—á–∏—Ç–∞–Ω–æ
                        </button>
                    </div>`;
                });
                document.getElementById('driver-messages-container').innerHTML = html;
            } else {
                document.getElementById('driver-messages-container').innerHTML = '';
            }
        }
        
        window.markMessageRead = function(messageId) {
            const msg = LOCAL_MESSAGES.find(m => m.id === messageId);
            if (msg) {
                msg.read = true;
                msg.readAt = new Date().toISOString();
                saveToStorage();
                checkDriverMessages();
            }
            
            if (currentRole === 'admin') {
                loadMessageStatus();
            }
        };
        
        function loadMessageStatus() {
            let html = '';
            LOCAL_MESSAGES.slice().reverse().forEach(msg => {
                const driver = LOCAL_DRIVERS.find(d => d.phone === msg.driverPhone);
                const status = msg.read ? 
                    `<span class="badge bg-success">‚úÖ –ü—Ä–æ—á–∏—Ç–∞–Ω–æ</span>` : 
                    `<span class="badge bg-warning">‚è≥ –û–∂–∏–¥–∞–µ—Ç</span>`;
                
                html += `<div class="border-bottom pb-2 mb-2">
                    <div><strong>${driver?.short || msg.driverPhone}</strong> ${status}</div>
                    <div class="text-secondary">${msg.text}</div>
                    <small class="text-muted">${msg.time || ''}</small>
                </div>`;
            });
            document.getElementById('message-status-container').innerHTML = html || '<p class="text-center">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</p>';
        }
        
        window.sendMessageToDriver = function() {
            const driverPhone = document.getElementById('message-driver-select').value;
            const text = document.getElementById('message-text').value;
            
            if (!driverPhone || !text) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –≤–æ–¥–∏—Ç–µ–ª—è –∏ –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç');
                return;
            }
            
            const newMsg = {
                id: Date.now().toString(),
                driverPhone: driverPhone,
                text: text,
                time: new Date().toLocaleTimeString().slice(0,5),
                read: false,
                readAt: null,
                timestamp: new Date().toISOString()
            };
            
            LOCAL_MESSAGES.push(newMsg);
            saveToStorage();
            
            document.getElementById('message-text').value = '';
            alert('‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
            loadMessageStatus();
        };
        
        // ============ –ê–î–ú–ò–ù ============
        function loadAdminData() {
            loadAdminDrivers();
            loadAllDrivers();
            loadAdminTrips();
            loadAdminReports();
            loadArchiveList();
            loadMessageDriversList();
            loadMessageStatus();
            document.getElementById('admin-rate-input').value = currentRate;
            updateMonthSelectors();
            updateArchiveSelectors();
        }
        
        // –ê–ö–¢–ò–í–ù–´–ï –í–û–î–ò–¢–ï–õ–ò
        function getActiveDriversThisMonth() {
            const month = new Date().toISOString().slice(0, 7);
            const activeDrivers = new Set();
            
            LOCAL_TRIPS.forEach(trip => {
                if (trip.date && trip.date.startsWith(month)) {
                    activeDrivers.add(trip.driverId);
                }
            });
            
            LOCAL_DRIVERS.forEach(driver => {
                if (driver.status === 'active') {
                    activeDrivers.add(driver.phone);
                }
            });
            
            return Array.from(activeDrivers);
        }
        
        function loadAdminDrivers() {
            const activeDriverPhones = getActiveDriversThisMonth();
            let html = '';
            let active = 0, city = 0, inter = 0;
            
            LOCAL_DRIVERS.forEach(driver => {
                if (!activeDriverPhones.includes(driver.phone)) return;
                
                if (driver.status === 'active') {
                    active++;
                    if (driver.shiftType === 'city') city++;
                    if (driver.shiftType === 'intercity') inter++;
                }
                
                let statusText = '‚ö™ –û—Ñ–ª–∞–π–Ω';
                let statusClass = 'status-offline';
                
                if (driver.status === 'active') {
                    if (driver.shiftType === 'city') {
                        statusText = 'üèôÔ∏è –†–∞–±–æ—Ç–∞–µ—Ç';
                        statusClass = 'status-working';
                    } else if (driver.shiftType === 'intercity') {
                        statusText = 'üõ£Ô∏è –ú–µ–∂–≥–æ—Ä–æ–¥';
                        statusClass = 'status-intercity';
                    }
                }
                
                const hasGeo = driver.lat && driver.lng;
                
                html += `<tr>
                    <td>
                        <div class="fw-bold">${driver.short || driver.name}</div>
                        <small class="text-secondary">${driver.phone}</small>
                    </td>
                    <td>
                        <span class="${statusClass} px-3 py-2">${statusText}</span>
                    </td>
                    <td>
                        ${hasGeo ? `<span class="text-success"><i class="bi bi-geo-alt-fill"></i> –ï—Å—Ç—å</span>` : '‚Äî'}
                    </td>
                    <td>
                        ${hasGeo ? `<button class="btn btn-sm btn-outline-info" onclick="showDriverMap('${driver.phone}', '${driver.short || driver.name}')">
                            <i class="bi bi-map"></i>
                        </button>` : '‚Äî'}
                    </td>
                    <td>
                        <div class="d-flex align-items-center gap-1">
                            <span class="text-monospace" id="pass-${driver.phone}">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
                            <button class="btn btn-sm btn-link" onclick="togglePasswordVisibility('${driver.phone}')">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-primary" onclick="editDriverPassword('${driver.phone}')">
                                <i class="bi bi-pencil"></i>
                            </button>
                        </div>
                    </td>
                </tr>`;
            });
            
            document.getElementById('admin-drivers-table-mobile').innerHTML = html || '<tr><td colspan="5" class="text-center">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤–æ–¥–∏—Ç–µ–ª–µ–π</td></tr>';
            document.getElementById('admin-active-count').innerHTML = active;
            document.getElementById('admin-city-count').innerHTML = city;
            document.getElementById('admin-inter-count').innerHTML = inter;
        }
        
        // –í–°–ï –í–û–î–ò–¢–ï–õ–ò
        function loadAllDrivers() {
            let html = '';
            
            LOCAL_DRIVERS.forEach(driver => {
                let statusText = driver.status === 'active' ? 'üü¢ –ê–∫—Ç–∏–≤–µ–Ω' : '‚ö™ –û—Ñ–ª–∞–π–Ω';
                
                html += `<tr>
                    <td>
                        <div class="fw-bold">${driver.short || driver.name}</div>
                        <small class="text-secondary">${driver.phone}</small>
                    </td>
                    <td>${driver.phone}</td>
                    <td>
                        <div class="d-flex align-items-center gap-1">
                            <span class="text-monospace" id="all-pass-${driver.phone}">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
                            <button class="btn btn-sm btn-link" onclick="toggleAllPasswordVisibility('${driver.phone}')">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                    </td>
                    <td>
                        <span class="${driver.status === 'active' ? 'status-working' : 'status-offline'} px-3 py-2">
                            ${statusText}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editDriverPassword('${driver.phone}')">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteDriver('${driver.phone}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>`;
            });
            
            document.getElementById('admin-all-drivers-table').innerHTML = html || '<tr><td colspan="5" class="text-center">–ù–µ—Ç –≤–æ–¥–∏—Ç–µ–ª–µ–π</td></tr>';
        }
        
        window.deleteDriver = function(phone) {
            if (confirm('‚ö†Ô∏è –¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å –≤–æ–¥–∏—Ç–µ–ª—è?\n–í—Å–µ –µ–≥–æ –ø–æ–µ–∑–¥–∫–∏ –∏ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.')) {
                LOCAL_DRIVERS = LOCAL_DRIVERS.filter(d => d.phone !== phone);
                LOCAL_TRIPS = LOCAL_TRIPS.filter(t => t.driverId !== phone);
                LOCAL_MESSAGES = LOCAL_MESSAGES.filter(m => m.driverPhone !== phone);
                saveToStorage();
                
                alert('‚úÖ –í–æ–¥–∏—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω –∏–∑ —Å–∏—Å—Ç–µ–º—ã');
                loadAdminDrivers();
                loadAllDrivers();
                loadAdminTrips();
                loadMessageDriversList();
            }
        };
        
        window.togglePasswordVisibility = function(phone) {
            const span = document.getElementById(`pass-${phone}`);
            const driver = LOCAL_DRIVERS.find(d => d.phone === phone);
            if (span.innerText.includes('‚Ä¢')) {
                span.innerText = driver.password;
            } else {
                span.innerText = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
            }
        };
        
        window.toggleAllPasswordVisibility = function(phone) {
            const span = document.getElementById(`all-pass-${phone}`);
            const driver = LOCAL_DRIVERS.find(d => d.phone === phone);
            if (span.innerText.includes('‚Ä¢')) {
                span.innerText = driver.password;
            } else {
                span.innerText = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
            }
        };
        
        window.editDriverPassword = function(phone) {
            const newPass = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–ª—è –≤–æ–¥–∏—Ç–µ–ª—è:');
            if (newPass) {
                const driver = LOCAL_DRIVERS.find(d => d.phone === phone);
                if (driver) {
                    driver.password = newPass;
                    saveToStorage();
                    alert('‚úÖ –ü–∞—Ä–æ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω');
                    loadAdminDrivers();
                    loadAllDrivers();
                }
            }
        };
        
        function loadAdminTrips() {
            let html = '';
            
            LOCAL_TRIPS.slice().reverse().forEach(trip => {
                html += `<tr>
                    <td>${trip.driverName}</td>
                    <td>${trip.date}</td>
                    <td><span class="badge ${trip.type === '–≥–æ—Ä–æ–¥' ? 'bg-primary' : 'bg-warning'}">${trip.type}</span></td>
                    <td>
                        <input type="number" class="form-control form-control-sm" style="width: 70px;" 
                            value="${trip.hours || 0}" id="hours-${trip.id}" step="0.5" ${trip.type !== '–≥–æ—Ä–æ–¥' ? 'disabled' : ''}>
                    </td>
                    <td>
                        <input type="number" class="form-control form-control-sm" style="width: 90px;" 
                            value="${trip.earn || 0}" id="earn-${trip.id}">
                    </td>
                    <td>
                        <small class="text-secondary">${trip.comment || ''}</small>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-success" onclick="editTrip('${trip.id}')">
                            <i class="bi bi-check-lg"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteTrip('${trip.id}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>`;
            });
            
            document.getElementById('admin-trips-table-mobile').innerHTML = html || '<tr><td colspan="7" class="text-center">–ù–µ—Ç –ø–æ–µ–∑–¥–æ–∫</td></tr>';
        }
        
        window.editTrip = function(tripId) {
            const trip = LOCAL_TRIPS.find(t => t.id === tripId);
            if (!trip) return;
            
            const newEarn = parseFloat(document.getElementById(`earn-${tripId}`).value);
            if (!isNaN(newEarn) && newEarn > 0) {
                trip.earn = newEarn;
            }
            
            if (trip.type === '–≥–æ—Ä–æ–¥') {
                const newHours = parseFloat(document.getElementById(`hours-${tripId}`).value);
                if (!isNaN(newHours) && newHours > 0) {
                    trip.hours = newHours;
                    trip.earn = Math.round(newHours * currentRate);
                }
            }
            
            saveToStorage();
            alert('‚úÖ –ü–æ–µ–∑–¥–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
            loadAdminTrips();
            loadAdminReports();
        };
        
        window.deleteTrip = function(tripId) {
            if (confirm('‚ö†Ô∏è –£–¥–∞–ª–∏—Ç—å –ø–æ–µ–∑–¥–∫—É?')) {
                LOCAL_TRIPS = LOCAL_TRIPS.filter(t => t.id !== tripId);
                saveToStorage();
                alert('‚úÖ –ü–æ–µ–∑–¥–∫–∞ —É–¥–∞–ª–µ–Ω–∞');
                loadAdminTrips();
                loadAdminReports();
            }
        };
        
        // ============ –û–¢–ß–ï–¢–´ ============
        function updateMonthSelectors() {
            const months = new Set();
            
            LOCAL_TRIPS.forEach(trip => {
                if (trip.date) {
                    months.add(trip.date.slice(0, 7));
                }
            });
            
            LOCAL_ARCHIVE.forEach(arch => {
                months.add(arch.month);
            });
            
            const currentMonth = new Date().toISOString().slice(0, 7);
            months.add(currentMonth);
            
            const sortedMonths = Array.from(months).sort().reverse();
            
            let adminOptions = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü</option>';
            let curatorOptions = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü</option>';
            
            sortedMonths.forEach(month => {
                const displayMonth = month.replace('-', '.');
                adminOptions += `<option value="${month}">${displayMonth}</option>`;
                curatorOptions += `<option value="${month}">${displayMonth}</option>`;
            });
            
            const adminSelect = document.getElementById('report-month-select');
            const curatorSelect = document.getElementById('curator-report-month');
            
            if (adminSelect) adminSelect.innerHTML = adminOptions;
            if (curatorSelect) curatorSelect.innerHTML = curatorOptions;
        }
        
        // –ó–ê–ì–†–£–ó–ö–ê –û–¢–ß–ï–¢–û–í –ê–î–ú–ò–ù–ê
        window.loadAdminMonthReport = function() {
            const month = document.getElementById('report-month-select').value;
            if (!month) {
                // –ï—Å–ª–∏ –º–µ—Å—è—Ü –Ω–µ –≤—ã–±—Ä–∞–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
                document.getElementById('admin-daily-report-content').innerHTML = '<p class="text-center text-secondary py-4">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü</p>';
                document.getElementById('admin-summary-report-content').innerHTML = '<p class="text-center text-secondary py-4">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü</p>';
                document.getElementById('admin-total-hours').innerHTML = '0 —á';
                document.getElementById('admin-total-inter').innerHTML = '0';
                document.getElementById('admin-total-earn').innerHTML = '0 ‚ÇΩ';
                return;
            }
            
            let monthTrips = LOCAL_TRIPS.filter(t => t.date && t.date.startsWith(month));
            
            if (monthTrips.length === 0) {
                // –ï—Å–ª–∏ –Ω–µ—Ç –ø–æ–µ–∑–¥–æ–∫ –∑–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–π –æ—Ç—á–µ—Ç
                document.getElementById('admin-daily-report-content').innerHTML = '<p class="text-center text-secondary py-4">–ù–µ—Ç –ø–æ–µ–∑–¥–æ–∫ –∑–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü</p>';
                document.getElementById('admin-summary-report-content').innerHTML = '<p class="text-center text-secondary py-4">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
                document.getElementById('admin-total-hours').innerHTML = '0 —á';
                document.getElementById('admin-total-inter').innerHTML = '0';
                document.getElementById('admin-total-earn').innerHTML = '0 ‚ÇΩ';
                return;
            }
            
            currentReportMonth = month;
            window.currentMonthTrips = monthTrips;
            
            loadAdminDailyReport(monthTrips);
            loadAdminSummaryReport(monthTrips);
        };
        
        function loadAdminDailyReport(trips) {
            let html = '';
            
            if (trips.length === 0) {
                html = '<p class="text-center text-secondary py-4">–ù–µ—Ç –ø–æ–µ–∑–¥–æ–∫ –∑–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü</p>';
            } else {
                trips.slice().reverse().forEach(trip => {
                    const route = trip.type === '–≥–æ—Ä–æ–¥' ? `${trip.hours} —á` : (trip.direction || '–ú–µ–∂–≥–æ—Ä–æ–¥');
                    html += `<div class="trip-row">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="fw-bold">${trip.driverName}</div>
                                <div class="text-secondary small">${trip.date}</div>
                            </div>
                            <div class="text-end">
                                <span class="badge ${trip.type === '–≥–æ—Ä–æ–¥' ? 'bg-primary' : 'bg-warning'} mb-1">${trip.type}</span>
                                <div class="fw-bold text-success">${trip.earn} ‚ÇΩ</div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                            <div>
                                <small class="text-secondary">–ú–∞—Ä—à—Ä—É—Ç: ${route}</small>
                            </div>
                            ${trip.comment ? `<div><small class="text-secondary">üí¨ ${trip.comment}</small></div>` : ''}
                        </div>
                    </div>`;
                });
            }
            
            document.getElementById('admin-daily-report-content').innerHTML = html;
        }
        
        function loadAdminSummaryReport(trips) {
            const summary = {};
            let totalCityHours = 0;
            let totalInterTrips = 0;
            let totalEarn = 0;
            
            trips.forEach(trip => {
                if (!summary[trip.driverName]) {
                    summary[trip.driverName] = {
                        cityHours: 0,
                        interTrips: 0,
                        earn: 0
                    };
                }
                
                if (trip.type === '–≥–æ—Ä–æ–¥') {
                    summary[trip.driverName].cityHours += trip.hours || 0;
                    totalCityHours += trip.hours || 0;
                } else {
                    summary[trip.driverName].interTrips += 1;
                    totalInterTrips += 1;
                }
                
                summary[trip.driverName].earn += trip.earn || 0;
                totalEarn += trip.earn || 0;
            });
            
            let html = '';
            
            if (Object.keys(summary).length === 0) {
                html = '<p class="text-center text-secondary py-4">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
            } else {
                Object.keys(summary).sort().forEach(name => {
                    const s = summary[name];
                    html += `<div class="driver-stat-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="fw-bold">${name}</div>
                                <div class="d-flex gap-3 mt-1 small">
                                    <span class="text-primary">üöï ${s.cityHours.toFixed(1)} —á</span>
                                    <span class="text-warning">üõ£Ô∏è ${s.interTrips} –ø–æ–µ–∑–¥–æ–∫</span>
                                </div>
                            </div>
                            <div class="text-end">
                                <div class="fw-bold text-success fs-5">${s.earn} ‚ÇΩ</div>
                            </div>
                        </div>
                    </div>`;
                });
            }
            
            document.getElementById('admin-summary-report-content').innerHTML = html;
            document.getElementById('admin-total-hours').innerHTML = `${totalCityHours.toFixed(1)} —á`;
            document.getElementById('admin-total-inter').innerHTML = totalInterTrips;
            document.getElementById('admin-total-earn').innerHTML = `${totalEarn} ‚ÇΩ`;
        }
        
        window.switchAdminReportTab = function(tab) {
            const dailyContainer = document.getElementById('admin-daily-report-container');
            const summaryContainer = document.getElementById('admin-summary-report-container');
            const tabs = document.querySelectorAll('#admin-reports-tab .report-tab');
            
            if (tab === 'daily') {
                dailyContainer.classList.remove('hidden');
                summaryContainer.classList.add('hidden');
                tabs[0].classList.add('active');
                tabs[1].classList.remove('active');
            } else {
                dailyContainer.classList.add('hidden');
                summaryContainer.classList.remove('hidden');
                tabs[0].classList.remove('active');
                tabs[1].classList.add('active');
            }
        };
        
        // ============ –ê–†–•–ò–í ============
        function updateArchiveSelectors() {
            const months = new Set();
            
            LOCAL_ARCHIVE.forEach(arch => {
                months.add(arch.month);
            });
            
            const sortedMonths = Array.from(months).sort().reverse();
            
            let adminOptions = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü</option>';
            let curatorOptions = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü</option>';
            
            sortedMonths.forEach(month => {
                const displayMonth = month.replace('-', '.');
                adminOptions += `<option value="${month}">${displayMonth}</option>`;
                curatorOptions += `<option value="${month}">${displayMonth}</option>`;
            });
            
            const adminSelect = document.getElementById('admin-archive-month-select');
            const curatorSelect = document.getElementById('curator-archive-month-select');
            
            if (adminSelect) adminSelect.innerHTML = adminOptions;
            if (curatorSelect) curatorSelect.innerHTML = curatorOptions;
        }
        
        function loadArchiveList() {
            let adminHtml = '';
            let curatorHtml = '';
            
            LOCAL_ARCHIVE.slice().reverse().forEach((arch, index) => {
                const card = `<div class="archive-card">
                    <div class="archive-header" onclick="toggleArchiveContent(this)">
                        <div class="d-flex justify-content-between w-100">
                            <div>
                                <h5 class="fw-bold mb-1">${arch.month}</h5>
                                <div class="text-secondary small">
                                    <i class="bi bi-truck"></i> ${arch.trips.length} –ø–æ–µ–∑–¥–æ–∫
                                </div>
                            </div>
                            <div class="text-end">
                                <span class="fs-5 fw-bold text-success">${arch.total} ‚ÇΩ</span>
                                <div><i class="bi bi-chevron-down"></i></div>
                            </div>
                        </div>
                    </div>
                    <div class="archive-content hidden">
                        <h6 class="fw-bold mb-3">–ò—Ç–æ–≥–∏ –ø–æ –≤–æ–¥–∏—Ç–µ–ª—è–º:</h6>
                        ${Object.keys(arch.summary || {}).map(name => `
                            <div class="d-flex justify-content-between mb-2">
                                <span>${name}</span>
                                <span class="fw-bold text-success">${arch.summary[name]?.totalEarn || 0} ‚ÇΩ</span>
                            </div>
                            <div class="d-flex gap-3 text-secondary small mb-2">
                                <span>üöï ${arch.summary[name]?.cityHours?.toFixed(1) || 0} —á</span>
                                <span>üõ£Ô∏è ${arch.summary[name]?.interTrips || 0} –ø–æ–µ–∑–¥–æ–∫</span>
                            </div>
                        `).join('')}
                        
                        <hr class="my-3">
                        <h6 class="fw-bold mb-2">–ü–æ–µ–∑–¥–∫–∏:</h6>
                        ${arch.trips.slice().reverse().map(t => `
                            <div class="border-bottom pb-2 mb-2">
                                <div class="d-flex justify-content-between">
                                    <span class="fw-bold">${t.driverName}</span>
                                    <span class="text-success">${t.earn} ‚ÇΩ</span>
                                </div>
                                <div class="d-flex justify-content-between text-secondary small">
                                    <span>${t.date} ‚Ä¢ ${t.type}</span>
                                    <span>${t.type === '–≥–æ—Ä–æ–¥' ? t.hours + ' —á' : (t.direction || '–ú–µ–∂–≥–æ—Ä–æ–¥')}</span>
                                </div>
                                ${t.comment ? `<div class="text-secondary small mt-1">üí¨ ${t.comment}</div>` : ''}
                            </div>
                        `).join('')}
                        
                        <div class="d-flex gap-2 mt-3">
                            <button class="btn btn-sm btn-success flex-fill" onclick="exportArchive(${index})">
                                <i class="bi bi-file-earmark-excel"></i> Excel
                            </button>
                            <button class="btn btn-sm btn-primary flex-fill" onclick="printArchive(${index})">
                                <i class="bi bi-printer"></i> –ü–µ—á–∞—Ç—å
                            </button>
                            <button class="btn btn-sm btn-danger flex-fill" onclick="deleteArchive(${index})">
                                <i class="bi bi-trash"></i> –£–¥–∞–ª–∏—Ç—å
                            </button>
                        </div>
                    </div>
                </div>`;
                adminHtml += card;
                curatorHtml += card;
            });
            
            document.getElementById('admin-archive-content').innerHTML = adminHtml || '<p class="text-center py-5 text-secondary"><i class="bi bi-archive fs-1"></i><br>–ù–µ—Ç –∞—Ä—Ö–∏–≤–æ–≤</p>';
            if (document.getElementById('curator-archive-content')) {
                document.getElementById('curator-archive-content').innerHTML = curatorHtml;
            }
        }
        
        window.loadAdminArchiveMonth = function() {
            const month = document.getElementById('admin-archive-month-select').value;
            if (!month) return;
            
            const archive = LOCAL_ARCHIVE.find(a => a.month === month);
            if (archive) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –º–µ—Å—è—Ü
                let html = '';
                const index = LOCAL_ARCHIVE.findIndex(a => a.month === month);
                if (index !== -1) {
                    const arch = LOCAL_ARCHIVE[index];
                    html = `<div class="archive-card">
                        <div class="archive-header" onclick="toggleArchiveContent(this)">
                            <div class="d-flex justify-content-between w-100">
                                <div>
                                    <h5 class="fw-bold mb-1">${arch.month}</h5>
                                    <div class="text-secondary small">
                                        <i class="bi bi-truck"></i> ${arch.trips.length} –ø–æ–µ–∑–¥–æ–∫
                                    </div>
                                </div>
                                <div class="text-end">
                                    <span class="fs-5 fw-bold text-success">${arch.total} ‚ÇΩ</span>
                                    <div><i class="bi bi-chevron-down"></i></div>
                                </div>
                            </div>
                        </div>
                        <div class="archive-content">
                            <h6 class="fw-bold mb-3">–ò—Ç–æ–≥–∏ –ø–æ –≤–æ–¥–∏—Ç–µ–ª—è–º:</h6>
                            ${Object.keys(arch.summary || {}).map(name => `
                                <div class="d-flex justify-content-between mb-2">
                                    <span>${name}</span>
                                    <span class="fw-bold text-success">${arch.summary[name]?.totalEarn || 0} ‚ÇΩ</span>
                                </div>
                                <div class="d-flex gap-3 text-secondary small mb-2">
                                    <span>üöï ${arch.summary[name]?.cityHours?.toFixed(1) || 0} —á</span>
                                    <span>üõ£Ô∏è ${arch.summary[name]?.interTrips || 0} –ø–æ–µ–∑–¥–æ–∫</span>
                                </div>
                            `).join('')}
                            
                            <hr class="my-3">
                            <h6 class="fw-bold mb-2">–ü–æ–µ–∑–¥–∫–∏:</h6>
                            ${arch.trips.slice().reverse().map(t => `
                                <div class="border-bottom pb-2 mb-2">
                                    <div class="d-flex justify-content-between">
                                        <span class="fw-bold">${t.driverName}</span>
                                        <span class="text-success">${t.earn} ‚ÇΩ</span>
                                    </div>
                                    <div class="d-flex justify-content-between text-secondary small">
                                        <span>${t.date} ‚Ä¢ ${t.type}</span>
                                        <span>${t.type === '–≥–æ—Ä–æ–¥' ? t.hours + ' —á' : (t.direction || '–ú–µ–∂–≥–æ—Ä–æ–¥')}</span>
                                    </div>
                                    ${t.comment ? `<div class="text-secondary small mt-1">üí¨ ${t.comment}</div>` : ''}
                                </div>
                            `).join('')}
                            
                            <div class="d-flex gap-2 mt-3">
                                <button class="btn btn-sm btn-success flex-fill" onclick="exportArchive(${index})">
                                    <i class="bi bi-file-earmark-excel"></i> Excel
                                </button>
                                <button class="btn btn-sm btn-primary flex-fill" onclick="printArchive(${index})">
                                    <i class="bi bi-printer"></i> –ü–µ—á–∞—Ç—å
                                </button>
                                <button class="btn btn-sm btn-danger flex-fill" onclick="deleteArchive(${index})">
                                    <i class="bi bi-trash"></i> –£–¥–∞–ª–∏—Ç—å
                                </button>
                            </div>
                        </div>
                    </div>`;
                }
                document.getElementById('admin-archive-content').innerHTML = html;
            }
        };
        
        window.loadCuratorArchiveMonth = function() {
            const month = document.getElementById('curator-archive-month-select').value;
            if (!month) return;
            
            const archive = LOCAL_ARCHIVE.find(a => a.month === month);
            if (archive) {
                const index = LOCAL_ARCHIVE.findIndex(a => a.month === month);
                let html = '';
                if (index !== -1) {
                    const arch = LOCAL_ARCHIVE[index];
                    html = `<div class="archive-card">
                        <div class="archive-header" onclick="toggleArchiveContent(this)">
                            <div class="d-flex justify-content-between w-100">
                                <div>
                                    <h5 class="fw-bold mb-1">${arch.month}</h5>
                                    <div class="text-secondary small">
                                        <i class="bi bi-truck"></i> ${arch.trips.length} –ø–æ–µ–∑–¥–æ–∫
                                    </div>
                                </div>
                                <div class="text-end">
                                    <span class="fs-5 fw-bold text-success">${arch.total} ‚ÇΩ</span>
                                    <div><i class="bi bi-chevron-down"></i></div>
                                </div>
                            </div>
                        </div>
                        <div class="archive-content">
                            <h6 class="fw-bold mb-3">–ò—Ç–æ–≥–∏ –ø–æ –≤–æ–¥–∏—Ç–µ–ª—è–º:</h6>
                            ${Object.keys(arch.summary || {}).map(name => `
                                <div class="d-flex justify-content-between mb-2">
                                    <span>${name}</span>
                                    <span class="fw-bold text-success">${arch.summary[name]?.totalEarn || 0} ‚ÇΩ</span>
                                </div>
                                <div class="d-flex gap-3 text-secondary small mb-2">
                                    <span>üöï ${arch.summary[name]?.cityHours?.toFixed(1) || 0} —á</span>
                                    <span>üõ£Ô∏è ${arch.summary[name]?.interTrips || 0} –ø–æ–µ–∑–¥–æ–∫</span>
                                </div>
                            `).join('')}
                            
                            <hr class="my-3">
                            <h6 class="fw-bold mb-2">–ü–æ–µ–∑–¥–∫–∏:</h6>
                            ${arch.trips.slice().reverse().map(t => `
                                <div class="border-bottom pb-2 mb-2">
                                    <div class="d-flex justify-content-between">
                                        <span class="fw-bold">${t.driverName}</span>
                                        <span class="text-success">${t.earn} ‚ÇΩ</span>
                                    </div>
                                    <div class="d-flex justify-content-between text-secondary small">
                                        <span>${t.date} ‚Ä¢ ${t.type}</span>
                                        <span>${t.type === '–≥–æ—Ä–æ–¥' ? t.hours + ' —á' : (t.direction || '–ú–µ–∂–≥–æ—Ä–æ–¥')}</span>
                                    </div>
                                    ${t.comment ? `<div class="text-secondary small mt-1">üí¨ ${t.comment}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>`;
                }
                document.getElementById('curator-archive-content').innerHTML = html;
            }
        };
        
        window.toggleArchiveContent = function(header) {
            const content = header.nextElementSibling;
            const icon = header.querySelector('.bi-chevron-down, .bi-chevron-up');
            content.classList.toggle('hidden');
            if (content.classList.contains('hidden')) {
                icon.classList.remove('bi-chevron-up');
                icon.classList.add('bi-chevron-down');
            } else {
                icon.classList.remove('bi-chevron-down');
                icon.classList.add('bi-chevron-up');
            }
        };
        
        window.deleteArchive = function(index) {
            if (confirm('‚ö†Ô∏è –£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∞—Ä—Ö–∏–≤?\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
                LOCAL_ARCHIVE.splice(index, 1);
                saveToStorage();
                alert('‚úÖ –ê—Ä—Ö–∏–≤ —É–¥–∞–ª–µ–Ω');
                loadArchiveList();
                updateArchiveSelectors();
            }
        };
        
        window.clearAllArchives = function() {
            if (confirm('‚ö†Ô∏è –£–¥–∞–ª–∏—Ç—å –í–°–ï –∞—Ä—Ö–∏–≤—ã?\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
                LOCAL_ARCHIVE = [];
                saveToStorage();
                alert('‚úÖ –í—Å–µ –∞—Ä—Ö–∏–≤—ã —É–¥–∞–ª–µ–Ω—ã');
                loadArchiveList();
                updateArchiveSelectors();
            }
        };
        
        window.exportArchive = function(index) {
            const archive = LOCAL_ARCHIVE[index];
            if (!archive) return;
            
            let csv = "–í–æ–¥–∏—Ç–µ–ª—å,–î–∞—Ç–∞,–¢–∏–ø,–ß–∞—Å—ã/–ú–∞—Ä—à—Ä—É—Ç,–°—É–º–º–∞,–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π\n";
            archive.trips.forEach(t => {
                const details = t.type === '–≥–æ—Ä–æ–¥' ? t.hours + ' —á' : (t.direction || '–ú–µ–∂–≥–æ—Ä–æ–¥');
                csv += `${t.driverName},${t.date},${t.type},${details},${t.earn},${t.comment || ''}\n`;
            });
            
            csv += `\n–û–ë–©–ò–ô –ò–¢–û–ì,,,${archive.total} ‚ÇΩ`;
            
            const blob = new Blob(["\uFEFF" + csv], {type: 'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `shintorg_${archive.month}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        };
        
        window.printArchive = function(index) {
            const archive = LOCAL_ARCHIVE[index];
            if (!archive) return;
            
            const w = window.open('', '_blank');
            w.document.write(`
                <html>
                <head>
                    <title>–®–∏–Ω—Ç–æ—Ä–≥ - –ê—Ä—Ö–∏–≤ ${archive.month}</title>
                    <style>
                        body { font-family: Arial; padding: 30px; max-width: 1200px; margin: 0 auto; }
                        h1 { color: #0f5e7e; border-bottom: 2px solid #0f5e7e; padding-bottom: 10px; }
                        h2 { color: #0f5e7e; }
                        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
                        th { background: #0f5e7e; color: white; padding: 12px; }
                        td { padding: 10px; border: 1px solid #ddd; }
                        .total { background: #ffe68f; font-weight: bold; }
                        .summary { margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px; }
                    </style>
                </head>
                <body>
                    <h1>–®–∏–Ω—Ç–æ—Ä–≥ –°—É—Ä–≥—É—Ç</h1>
                    <h2>–ê—Ä—Ö–∏–≤: ${archive.month}</h2>
                    
                    <div class="summary">
                        <h3>–ò—Ç–æ–≥–∏ –ø–æ –≤–æ–¥–∏—Ç–µ–ª—è–º</h3>
                        ${Object.keys(archive.summary || {}).map(name => `
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span><strong>${name}</strong></span>
                                <span style="color: #28a745; font-weight: bold;">${archive.summary[name]?.totalEarn || 0} ‚ÇΩ</span>
                            </div>
                            <div style="display: flex; gap: 20px; color: #666; margin-bottom: 15px;">
                                <span>üöï –ì–æ—Ä–æ–¥: ${archive.summary[name]?.cityHours?.toFixed(1) || 0} —á</span>
                                <span>üõ£Ô∏è –ú–µ–∂–≥–æ—Ä–æ–¥: ${archive.summary[name]?.interTrips || 0} –ø–æ–µ–∑–¥–æ–∫</span>
                            </div>
                        `).join('')}
                    </div>
                    
                    <h3>–î–µ—Ç–∞–ª—å–Ω—ã–µ –ø–æ–µ–∑–¥–∫–∏</h3>
                    <table>
                        <tr>
                            <th>–í–æ–¥–∏—Ç–µ–ª—å</th>
                            <th>–î–∞—Ç–∞</th>
                            <th>–¢–∏–ø</th>
                            <th>–ú–∞—Ä—à—Ä—É—Ç</th>
                            <th>–°—É–º–º–∞</th>
                            <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                        </tr>
                        ${archive.trips.map(t => `
                            <tr>
                                <td>${t.driverName}</td>
                                <td>${t.date}</td>
                                <td>${t.type}</td>
                                <td>${t.type === '–≥–æ—Ä–æ–¥' ? t.hours + ' —á' : (t.direction || '–ú–µ–∂–≥–æ—Ä–æ–¥')}</td>
                                <td>${t.earn} ‚ÇΩ</td>
                                <td>${t.comment || ''}</td>
                            </tr>
                        `).join('')}
                    </table>
                    
                    <h3 style="margin-top: 30px;">–û–±—â–∏–π –∏—Ç–æ–≥: ${archive.total} ‚ÇΩ</h3>
                    <p style="margin-top: 40px; color: #666;">–î–∞—Ç–∞ –∑–∞–∫—Ä—ã—Ç–∏—è: ${new Date(archive.closedAt).toLocaleDateString()}</p>
                </body>
                </html>
            `);
            w.document.close();
            w.print();
        };
        
        // ============ –≠–ö–°–ü–û–†–¢ –û–¢–ß–ï–¢–û–í ============
        window.exportDailyReportToExcel = function() {
            if (!window.currentMonthTrips || window.currentMonthTrips.length === 0) {
                alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
                return;
            }
            
            let csv = "–í–æ–¥–∏—Ç–µ–ª—å,–î–∞—Ç–∞,–¢–∏–ø,–ú–∞—Ä—à—Ä—É—Ç,–°—É–º–º–∞,–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π\n";
            window.currentMonthTrips.forEach(t => {
                const route = t.type === '–≥–æ—Ä–æ–¥' ? t.hours + ' —á' : (t.direction || '–ú–µ–∂–≥–æ—Ä–æ–¥');
                csv += `${t.driverName},${t.date},${t.type},${route},${t.earn},${t.comment || ''}\n`;
            });
            
            const blob = new Blob(["\uFEFF" + csv], {type: 'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `shintorg_${currentReportMonth || 'report'}_daily.csv`;
            a.click();
            URL.revokeObjectURL(url);
        };
        
        window.exportSummaryReportToExcel = function() {
            if (!window.currentMonthTrips || window.currentMonthTrips.length === 0) {
                alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
                return;
            }
            
            const summary = {};
            window.currentMonthTrips.forEach(t => {
                if (!summary[t.driverName]) {
                    summary[t.driverName] = { cityHours: 0, interTrips: 0, earn: 0 };
                }
                if (t.type === '–≥–æ—Ä–æ–¥') summary[t.driverName].cityHours += t.hours || 0;
                else summary[t.driverName].interTrips += 1;
                summary[t.driverName].earn += t.earn || 0;
            });
            
            let csv = "–í–æ–¥–∏—Ç–µ–ª—å,–ß–∞—Å—ã (–≥–æ—Ä–æ–¥),–ü–æ–µ–∑–¥–∫–∏ (–ú–ì),–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ\n";
            Object.keys(summary).sort().forEach(name => {
                const s = summary[name];
                csv += `${name},${s.cityHours.toFixed(1)} —á,${s.interTrips},${s.earn} ‚ÇΩ\n`;
            });
            
            const total = window.currentMonthTrips.reduce((s, t) => s + (t.earn || 0), 0);
            csv += `\n–û–ë–©–ò–ô –ò–¢–û–ì,,,${total} ‚ÇΩ`;
            
            const blob = new Blob(["\uFEFF" + csv], {type: 'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `shintorg_${currentReportMonth || 'report'}_summary.csv`;
            a.click();
            URL.revokeObjectURL(url);
        };
        
        window.printDailyReport = function() {
            if (!window.currentMonthTrips || window.currentMonthTrips.length === 0) {
                alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–µ—á–∞—Ç–∏');
                return;
            }
            
            const month = currentReportMonth || '–æ—Ç—á–µ—Ç';
            const w = window.open('', '_blank');
            
            let tableHtml = '';
            window.currentMonthTrips.slice().reverse().forEach(t => {
                const route = t.type === '–≥–æ—Ä–æ–¥' ? t.hours + ' —á' : (t.direction || '–ú–µ–∂–≥–æ—Ä–æ–¥');
                tableHtml += `<tr>
                    <td>${t.driverName}</td>
                    <td>${t.date}</td>
                    <td>${t.type}</td>
                    <td>${route}</td>
                    <td>${t.earn} ‚ÇΩ</td>
                    <td>${t.comment || ''}</td>
                </tr>`;
            });
            
            w.document.write(`
                <html>
                <head>
                    <title>–®–∏–Ω—Ç–æ—Ä–≥ - –û—Ç—á–µ—Ç ${month}</title>
                    <style>
                        body { font-family: Arial; padding: 30px; max-width: 1200px; margin: 0 auto; }
                        h1 { color: #0f5e7e; border-bottom: 2px solid #0f5e7e; padding-bottom: 10px; }
                        h2 { color: #0f5e7e; }
                        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
                        th { background: #0f5e7e; color: white; padding: 12px; }
                        td { padding: 10px; border: 1px solid #ddd; }
                    </style>
                </head>
                <body>
                    <h1>–®–∏–Ω—Ç–æ—Ä–≥ –°—É—Ä–≥—É—Ç</h1>
                    <h2>–ü–æ—Å–º–µ–Ω–Ω—ã–π –æ—Ç—á–µ—Ç: ${month}</h2>
                    <table>
                        <tr>
                            <th>–í–æ–¥–∏—Ç–µ–ª—å</th>
                            <th>–î–∞—Ç–∞</th>
                            <th>–¢–∏–ø</th>
                            <th>–ú–∞—Ä—à—Ä—É—Ç</th>
                            <th>–°—É–º–º–∞</th>
                            <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                        </tr>
                        ${tableHtml}
                    </table>
                    <p style="margin-top: 40px; color: #666;">–î–∞—Ç–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è: ${new Date().toLocaleDateString()}</p>
                </body>
                </html>
            `);
            w.document.close();
            w.print();
        };
        
        window.printSummaryReport = function() {
            if (!window.currentMonthTrips || window.currentMonthTrips.length === 0) {
                alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–µ—á–∞—Ç–∏');
                return;
            }
            
            const month = currentReportMonth || '–æ—Ç—á–µ—Ç';
            
            const summary = {};
            let totalCityHours = 0;
            let totalInterTrips = 0;
            let totalEarn = 0;
            
            window.currentMonthTrips.forEach(t => {
                if (!summary[t.driverName]) {
                    summary[t.driverName] = { cityHours: 0, interTrips: 0, earn: 0 };
                }
                if (t.type === '–≥–æ—Ä–æ–¥') {
                    summary[t.driverName].cityHours += t.hours || 0;
                    totalCityHours += t.hours || 0;
                } else {
                    summary[t.driverName].interTrips += 1;
                    totalInterTrips += 1;
                }
                summary[t.driverName].earn += t.earn || 0;
                totalEarn += t.earn || 0;
            });
            
            let tableHtml = '';
            Object.keys(summary).sort().forEach(name => {
                const s = summary[name];
                tableHtml += `<tr>
                    <td>${name}</td>
                    <td>${s.cityHours.toFixed(1)} —á</td>
                    <td>${s.interTrips}</td>
                    <td>${s.earn} ‚ÇΩ</td>
                </tr>`;
            });
            
            const w = window.open('', '_blank');
            w.document.write(`
                <html>
                <head>
                    <title>–®–∏–Ω—Ç–æ—Ä–≥ - –°–≤–æ–¥–∫–∞ ${month}</title>
                    <style>
                        body { font-family: Arial; padding: 30px; max-width: 1200px; margin: 0 auto; }
                        h1 { color: #0f5e7e; border-bottom: 2px solid #0f5e7e; padding-bottom: 10px; }
                        h2 { color: #0f5e7e; }
                        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
                        th { background: #0f5e7e; color: white; padding: 12px; }
                        td { padding: 10px; border: 1px solid #ddd; }
                        .total { background: #ffe68f; font-weight: bold; }
                        .summary { margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px; }
                    </style>
                </head>
                <body>
                    <h1>–®–∏–Ω—Ç–æ—Ä–≥ –°—É—Ä–≥—É—Ç</h1>
                    <h2>–°–≤–æ–¥–Ω—ã–π –æ—Ç—á–µ—Ç: ${month}</h2>
                    
                    <table>
                        <tr>
                            <th>–í–æ–¥–∏—Ç–µ–ª—å</th>
                            <th>–ß–∞—Å—ã (–≥–æ—Ä–æ–¥)</th>
                            <th>–ü–æ–µ–∑–¥–∫–∏ (–ú–ì)</th>
                            <th>–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ</th>
                        </tr>
                        ${tableHtml}
                    </table>
                    
                    <div class="summary">
                        <h3>–û–±—â–∏–µ –∏—Ç–æ–≥–∏</h3>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span><strong>–í—Å–µ–≥–æ —á–∞—Å–æ–≤ (–≥–æ—Ä–æ–¥):</strong></span>
                            <span>${totalCityHours.toFixed(1)} —á</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span><strong>–í—Å–µ–≥–æ –ø–æ–µ–∑–¥–æ–∫ (–º–µ–∂–≥–æ—Ä–æ–¥):</strong></span>
                            <span>${totalInterTrips}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–¥–∏—Ç–µ–ª–µ–π:</strong></span>
                            <span>${Object.keys(summary).length}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 20px; font-size: 24px;">
                            <span><strong>–û–ë–©–ò–ô –ó–ê–†–ê–ë–û–¢–û–ö:</strong></span>
                            <span style="color: #0f5e7e;"><strong>${totalEarn} ‚ÇΩ</strong></span>
                        </div>
                    </div>
                    
                    <p style="margin-top: 40px; color: #666;">–î–∞—Ç–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è: ${new Date().toLocaleDateString()}</p>
                </body>
                </html>
            `);
            w.document.close();
            w.print();
        };
        
        // ============ –ö–£–†–ê–¢–û–† ============
        window.exportCuratorDailyReportToExcel = window.exportDailyReportToExcel;
        window.exportCuratorSummaryReportToExcel = window.exportSummaryReportToExcel;
        window.printCuratorDailyReport = window.printDailyReport;
        window.printCuratorSummaryReport = window.printSummaryReport;
        
        // ============ –ó–ê–ö–†–´–¢–ò–ï –ú–ï–°–Ø–¶–ê - –ò–°–ü–†–ê–í–õ–ï–ù–û ============
        window.closeMonth = function() {
            if (!confirm('‚ö†Ô∏è –ó–∞–∫—Ä—ã—Ç—å —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü? –í—Å–µ –ø–æ–µ–∑–¥–∫–∏ –±—É–¥—É—Ç –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω—ã –∏ —É–¥–∞–ª–µ–Ω—ã –∏–∑ –æ—Ç—á–µ—Ç–æ–≤.')) return;
            
            const month = new Date().toISOString().slice(0, 7);
            const monthTrips = LOCAL_TRIPS.filter(t => t.date && t.date.startsWith(month));
            
            if (monthTrips.length === 0) {
                alert('‚ùå –ù–µ—Ç –ø–æ–µ–∑–¥–æ–∫ –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü');
                return;
            }
            
            const total = monthTrips.reduce((s, t) => s + (t.earn || 0), 0);
            
            // –°–æ—Å—Ç–∞–≤–ª—è–µ–º —Å–≤–æ–¥–∫—É –ø–æ –≤–æ–¥–∏—Ç–µ–ª—è–º
            const summary = {};
            monthTrips.forEach(t => {
                if (!summary[t.driverName]) {
                    summary[t.driverName] = { cityHours: 0, interTrips: 0, totalEarn: 0 };
                }
                if (t.type === '–≥–æ—Ä–æ–¥') summary[t.driverName].cityHours += t.hours || 0;
                else summary[t.driverName].interTrips += 1;
                summary[t.driverName].totalEarn += t.earn || 0;
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∞—Ä—Ö–∏–≤
            LOCAL_ARCHIVE.push({
                month: month,
                trips: JSON.parse(JSON.stringify(monthTrips)),
                summary: summary,
                total: total,
                closedAt: new Date().toISOString()
            });
            
            // –í–ê–ñ–ù–û: –£–î–ê–õ–Ø–ï–ú –í–°–ï –ü–û–ï–ó–î–ö–ò –ó–ê –≠–¢–û–¢ –ú–ï–°–Ø–¶
            LOCAL_TRIPS = LOCAL_TRIPS.filter(t => !t.date || !t.date.startsWith(month));
            saveToStorage();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç—á–µ—Ç –æ –∑–∞–∫—Ä—ã—Ç–∏–∏
            let reportText = `‚úÖ –ú–µ—Å—è—Ü ${month} –∑–∞–∫—Ä—ã—Ç!\nüí∞ –ò–¢–û–ì–û: ${total} ‚ÇΩ\n\n`;
            for (let name in summary) {
                reportText += `${name}: üöï ${summary[name].cityHours.toFixed(1)} —á, üõ£Ô∏è ${summary[name].interTrips} –ø–æ–µ–∑–¥–æ–∫ = ${summary[name].totalEarn} ‚ÇΩ\n`;
            }
            
            alert(reportText);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
            if (currentRole === 'admin') {
                loadAdminData(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∞–¥–º–∏–Ω–∞
                // –û—á–∏—â–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –º–µ—Å—è—Ü –≤ –æ—Ç—á–µ—Ç–∞—Ö
                document.getElementById('report-month-select').value = '';
                // –û—á–∏—â–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –æ—Ç—á–µ—Ç–æ–≤
                document.getElementById('admin-daily-report-content').innerHTML = '<p class="text-center text-secondary py-4">–ù–µ—Ç –ø–æ–µ–∑–¥–æ–∫ –∑–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü</p>';
                document.getElementById('admin-summary-report-content').innerHTML = '<p class="text-center text-secondary py-4">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
                document.getElementById('admin-total-hours').innerHTML = '0 —á';
                document.getElementById('admin-total-inter').innerHTML = '0';
                document.getElementById('admin-total-earn').innerHTML = '0 ‚ÇΩ';
            }
            
            if (currentRole === 'curator') {
                loadCuratorData(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∫—É—Ä–∞—Ç–æ—Ä–∞
                // –û—á–∏—â–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –º–µ—Å—è—Ü –≤ –æ—Ç—á–µ—Ç–∞—Ö
                document.getElementById('curator-report-month').value = '';
                // –û—á–∏—â–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –æ—Ç—á–µ—Ç–æ–≤
                document.getElementById('curator-daily-report-content').innerHTML = '<p class="text-center text-secondary py-4">–ù–µ—Ç –ø–æ–µ–∑–¥–æ–∫ –∑–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü</p>';
                document.getElementById('curator-summary-report-content').innerHTML = '<p class="text-center text-secondary py-4">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
                document.getElementById('curator-total-hours').innerHTML = '0 —á';
                document.getElementById('curator-total-inter').innerHTML = '0';
                document.getElementById('curator-total-earn').innerHTML = '0 ‚ÇΩ';
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä—ã –º–µ—Å—è—Ü–µ–≤
            updateMonthSelectors();
            updateArchiveSelectors();
            
            // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞ –≤–∫–ª–∞–¥–∫–∞ –∞—Ä—Ö–∏–≤–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫
            if (currentRole === 'admin' && document.getElementById('admin-archive-tab').classList.contains('hidden') === false) {
                loadArchiveList();
            }
            if (currentRole === 'curator' && document.getElementById('curator-archive-tab').classList.contains('hidden') === false) {
                loadArchiveList();
            }
        };
        
        // ============ –ö–£–†–ê–¢–û–† ============
        function loadCuratorData() {
            loadCuratorDrivers();
            loadArchiveList();
            updateMonthSelectors();
            updateArchiveSelectors();
            
            document.getElementById('curator-active-count').innerHTML = LOCAL_DRIVERS.filter(d => d.status === 'active').length;
            document.getElementById('curator-city-count').innerHTML = LOCAL_DRIVERS.filter(d => d.status === 'active' && d.shiftType === 'city').length;
        }
        
        function loadCuratorDrivers() {
            let html = '';
            LOCAL_DRIVERS.forEach(driver => {
                if (driver.status !== 'active') return;
                
                let statusText = driver.shiftType === 'city' ? 'üèôÔ∏è –ì–æ—Ä–æ–¥' : 'üõ£Ô∏è –ú–µ–∂–≥–æ—Ä–æ–¥';
                let statusClass = driver.shiftType === 'city' ? 'status-working' : 'status-intercity';
                const hasGeo = driver.lat && driver.lng;
                
                html += `<tr>
                    <td>${driver.short || driver.name}</td>
                    <td><span class="${statusClass} px-3 py-2">${statusText}</span></td>
                    <td>${hasGeo ? '<span class="text-success">–î–≤–∏–∂–µ—Ç—Å—è</span>' : '‚Äî'}</td>
                    <td>
                        ${hasGeo ? 
                            `<button class="btn btn-sm btn-outline-info" onclick="showDriverMap('${driver.phone}', '${driver.short || driver.name}')">
                                <i class="bi bi-map"></i>
                            </button>` : '‚Äî'}
                    </td>
                </tr>`;
            });
            document.getElementById('curator-drivers-table').innerHTML = html || '<tr><td colspan="4" class="text-center">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤–æ–¥–∏—Ç–µ–ª–µ–π</td></tr>';
        }
        
        window.loadCuratorMonthReport = function() {
            const month = document.getElementById('curator-report-month').value;
            if (!month) {
                // –ï—Å–ª–∏ –º–µ—Å—è—Ü –Ω–µ –≤—ã–±—Ä–∞–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
                document.getElementById('curator-daily-report-content').innerHTML = '<p class="text-center text-secondary py-4">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü</p>';
                document.getElementById('curator-summary-report-content').innerHTML = '<p class="text-center text-secondary py-4">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü</p>';
                document.getElementById('curator-total-hours').innerHTML = '0 —á';
                document.getElementById('curator-total-inter').innerHTML = '0';
                document.getElementById('curator-total-earn').innerHTML = '0 ‚ÇΩ';
                return;
            }
            
            let monthTrips = LOCAL_TRIPS.filter(t => t.date && t.date.startsWith(month));
            
            if (monthTrips.length === 0) {
                // –ï—Å–ª–∏ –Ω–µ—Ç –ø–æ–µ–∑–¥–æ–∫ –∑–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–π –æ—Ç—á–µ—Ç
                document.getElementById('curator-daily-report-content').innerHTML = '<p class="text-center text-secondary py-4">–ù–µ—Ç –ø–æ–µ–∑–¥–æ–∫ –∑–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü</p>';
                document.getElementById('curator-summary-report-content').innerHTML = '<p class="text-center text-secondary py-4">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
                document.getElementById('curator-total-hours').innerHTML = '0 —á';
                document.getElementById('curator-total-inter').innerHTML = '0';
                document.getElementById('curator-total-earn').innerHTML = '0 ‚ÇΩ';
                return;
            }
            
            currentReportMonth = month;
            window.currentMonthTrips = monthTrips;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç—á–µ—Ç—ã
            loadAdminDailyReport(monthTrips);
            loadAdminSummaryReport(monthTrips);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫—É—Ä–∞—Ç–æ—Ä—Å–∫–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            document.getElementById('curator-daily-report-content').innerHTML = document.getElementById('admin-daily-report-content').innerHTML;
            document.getElementById('curator-summary-report-content').innerHTML = document.getElementById('admin-summary-report-content').innerHTML;
            document.getElementById('curator-total-hours').innerHTML = document.getElementById('admin-total-hours').innerHTML;
            document.getElementById('curator-total-inter').innerHTML = document.getElementById('admin-total-inter').innerHTML;
            document.getElementById('curator-total-earn').innerHTML = document.getElementById('admin-total-earn').innerHTML;
        };
        
        window.switchCuratorReportTab = function(tab) {
            const dailyContainer = document.getElementById('curator-daily-report-container');
            const summaryContainer = document.getElementById('curator-summary-report-container');
            const tabs = document.querySelectorAll('#curator-reports-tab .report-tab');
            
            if (tab === 'daily') {
                dailyContainer.classList.remove('hidden');
                summaryContainer.classList.add('hidden');
                tabs[0].classList.add('active');
                tabs[1].classList.remove('active');
            } else {
                dailyContainer.classList.add('hidden');
                summaryContainer.classList.remove('hidden');
                tabs[0].classList.remove('active');
                tabs[1].classList.add('active');
            }
        };
        
        window.switchCuratorTab = function(tab) {
            document.getElementById('curator-reports-tab').classList.toggle('hidden', tab !== 'reports');
            document.getElementById('curator-archive-tab').classList.toggle('hidden', tab !== 'archive');
            
            document.querySelectorAll('#curator-cabinet .mobile-tabs .mobile-tab').forEach((el, i) => {
                el.classList.toggle('active', (i === 0 && tab === 'reports') || (i === 1 && tab === 'archive'));
            });
        };
        
        // ============ –ù–ê–°–¢–†–û–ô–ö–ò ============
        window.updateRate = function() {
            const rate = parseFloat(document.getElementById('admin-rate-input').value);
            if (rate > 0) {
                currentRate = rate;
                document.getElementById('rate-display').innerHTML = `${rate} ‚ÇΩ/—á`;
                localStorage.setItem('shintorg_rate', rate.toString());
                alert('‚úÖ –¢–∞—Ä–∏—Ñ –æ–±–Ω–æ–≤–ª–µ–Ω');
            }
        };
        
        window.changeAdminPassword = function() {
            const newPass = document.getElementById('admin-new-pass').value;
            if (newPass) {
                ADMIN_CRED.password = newPass;
                saveToStorage();
                alert('‚úÖ –ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏–∑–º–µ–Ω–µ–Ω');
                document.getElementById('admin-new-pass').value = '';
            }
        };
        
        window.changeCuratorPassword = function() {
            const newPass = document.getElementById('curator-new-pass').value;
            if (newPass) {
                CURATOR_CRED.password = newPass;
                saveToStorage();
                alert('‚úÖ –ü–∞—Ä–æ–ª—å –∫—É—Ä–∞—Ç–æ—Ä–∞ –∏–∑–º–µ–Ω–µ–Ω');
                document.getElementById('curator-new-pass').value = '';
            }
        };
        
        function loadMessageDriversList() {
            let html = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤–æ–¥–∏—Ç–µ–ª—è</option>';
            LOCAL_DRIVERS.forEach(driver => {
                html += `<option value="${driver.phone}">${driver.short || driver.name}</option>`;
            });
            document.getElementById('message-driver-select').innerHTML = html;
        }
        
        // ============ –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï ============
        window.switchDriverMode = function(mode) {
            document.getElementById('driver-city-panel').classList.toggle('hidden', mode !== 'city');
            document.getElementById('driver-inter-panel').classList.toggle('hidden', mode !== 'inter');
        };
        
        window.switchAdminTab = function(tab) {
            const tabs = ['drivers', 'all-drivers', 'trips', 'reports', 'archive', 'settings'];
            tabs.forEach(t => {
                document.getElementById(`admin-${t}-tab`).classList.add('hidden');
            });
            document.getElementById(`admin-${tab}-tab`).classList.remove('hidden');
            
            document.querySelectorAll('#admin-cabinet .mobile-tabs .mobile-tab').forEach((el, i) => {
                el.classList.toggle('active', i === tabs.indexOf(tab));
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞—Ä—Ö–∏–≤—ã –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É
            if (tab === 'archive') {
                loadArchiveList();
                updateArchiveSelectors();
            }
        };
        
        window.showRegister = function() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('register-screen').classList.remove('hidden');
        };
        
        window.backToLogin = function() {
            document.getElementById('register-screen').classList.add('hidden');
            document.getElementById('admin-secret-screen').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
        };
        
        window.logout = function() {
            if (geoWatchId) navigator.geolocation.clearWatch(geoWatchId);
            if (shiftTimer) clearInterval(shiftTimer);
            
            currentUser = null;
            currentRole = null;
            shiftActive = false;
            
            document.getElementById('driver-cabinet').classList.add('hidden');
            document.getElementById('admin-cabinet').classList.add('hidden');
            document.getElementById('curator-cabinet').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
            closeMap();
            
            document.getElementById('timer-display').innerText = '00:00:00';
            document.getElementById('shift-start-btn').classList.remove('hidden');
            document.getElementById('shift-end-btn').classList.add('hidden');
        };
        
        // ============ –ó–ê–ì–†–£–ó–ö–ê –û–¢–ß–ï–¢–û–í ============
        function loadAdminReports() {
            const month = new Date().toISOString().slice(0, 7);
            document.getElementById('report-month-select').value = month;
            loadAdminMonthReport();
        }
    </script>
</body>
</html>