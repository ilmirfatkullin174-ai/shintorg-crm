<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–®–∏–Ω—Ç–æ—Ä–≥ ‚Ä¢ –û—Ñ–ª–∞–π–Ω CRM</title>
    
    <!-- Bootstrap 5 + Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    
    <!-- Leaflet –¥–ª—è –∫–∞—Ä—Ç -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #0a3a4a; font-family: 'Segoe UI', Roboto, sans-serif; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; padding: 0; }
        
        .mobile-container { max-width: 450px; width: 100%; background: #f8fcff; min-height: 100vh; box-shadow: 0 25px 50px -10px rgba(0,0,0,0.4); margin: 0 auto; overflow-x: hidden; }
        .app-header { background: linear-gradient(135deg, #0f5e7e, #0a405a); color: white; padding: 20px 18px; border-bottom-left-radius: 30px; border-bottom-right-radius: 30px; position: sticky; top: 0; z-index: 100; }
        .mobile-card { background: white; border-radius: 24px; padding: 18px; margin: 12px 16px; box-shadow: 0 6px 16px rgba(0,0,0,0.03); border: 1px solid rgba(255,255,255,0.8); }
        .mobile-btn { border-radius: 60px !important; padding: 14px 20px !important; font-weight: 700 !important; border: none !important; box-shadow: 0 6px 0 rgba(0,0,0,0.08) !important; transition: 0.08s !important; width: 100%; }
        .mobile-btn:active { transform: translateY(6px) !important; box-shadow: 0 2px 0 rgba(0,0,0,0.08) !important; }
        .timer-big { font-size: 52px; font-weight: 900; font-family: 'Courier New', monospace; text-align: center; color: #0f5e7e; background: #e8f4fa; padding: 16px; border-radius: 30px; letter-spacing: 6px; }
        .geo-active { background: #d4f0d4; color: #1e6b3b; padding: 10px 16px; border-radius: 50px; font-weight: 600; }
        .geo-inactive { background: #ffe6e6; color: #b34141; padding: 10px 16px; border-radius: 50px; }
        .mobile-tabs { display: flex; background: white; border-radius: 50px; margin: 12px 16px; padding: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        .mobile-tab { flex: 1; text-align: center; padding: 12px 6px; border-radius: 50px; font-weight: 700; color: #5f7e8c; cursor: pointer; }
        .mobile-tab.active { background: #0f5e7e; color: white; }
        .hidden { display: none !important; }
        .sync-badge { background: #4caf50; color: white; padding: 4px 12px; border-radius: 50px; font-size: 11px; }
        .offline-badge { background: #ff9800; color: white; padding: 4px 12px; border-radius: 50px; }
    </style>
</head>
<body>
    <div class="mobile-container" id="app">
        
        <!-- –ò–ù–î–ò–ö–ê–¢–û–†–´ -->
        <div id="sync-indicator" style="position: fixed; top: 10px; right: 10px; z-index: 1000; display: none;">
            <span class="sync-badge"><i class="bi bi-cloud-check"></i> –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...</span>
        </div>
        <div id="offline-indicator" style="position: fixed; top: 10px; right: 10px; z-index: 1000; display: none;">
            <span class="offline-badge"><i class="bi bi-wifi-off"></i> –û—Ñ–ª–∞–π–Ω</span>
        </div>
        
        <!-- –≠–ö–†–ê–ù –ó–ê–ì–†–£–ó–ö–ò -->
        <div id="loading-screen" class="vh-100 d-flex flex-column justify-content-center align-items-center" style="background: linear-gradient(145deg, #0f5e7e, #0a405a);">
            <div class="spinner-border text-white mb-3" style="width: 4rem; height: 4rem;"></div>
            <h4 class="text-white">–®–∏–Ω—Ç–æ—Ä–≥ –°—É—Ä–≥—É—Ç</h4>
            <p class="text-white-50">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        </div>
        
        <!-- –≠–ö–†–ê–ù –í–•–û–î–ê -->
        <div id="login-screen" class="hidden">
            <div class="app-header text-center">
                <h2><i class="bi bi-truck"></i> –®–ò–ù–¢–û–†–ì</h2>
                <p class="mb-0 opacity-75">–£—á–µ—Ç —Å–º–µ–Ω –∏ –∑–∞—Ä–∞–±–æ—Ç–∫–∞</p>
            </div>
            
            <div class="mobile-card mt-4">
                <div class="mobile-tabs mb-4" id="login-tabs">
                    <div class="mobile-tab active" onclick="switchLoginTab('driver')"><i class="bi bi-person"></i> –í–æ–¥–∏—Ç–µ–ª—å</div>
                    <div class="mobile-tab" onclick="switchLoginTab('admin')"><i class="bi bi-shield-lock"></i> –ê–¥–º–∏–Ω</div>
                    <div class="mobile-tab" onclick="switchLoginTab('curator')"><i class="bi bi-eye"></i> –ö—É—Ä–∞—Ç–æ—Ä</div>
                </div>
                
                <!-- –í–û–î–ò–¢–ï–õ–¨ -->
                <div id="driver-login-panel">
                    <div class="mb-3"><input type="text" class="form-control form-control-lg rounded-pill" id="driver-login" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω / –õ–æ–≥–∏–Ω"></div>
                    <div class="mb-4"><input type="password" class="form-control form-control-lg rounded-pill" id="driver-password" placeholder="–ü–∞—Ä–æ–ª—å"></div>
                    <button class="btn btn-primary mobile-btn" onclick="loginDriver()"><i class="bi bi-box-arrow-in-right"></i> –í–æ–π—Ç–∏</button>
                    <div class="text-center mt-4"><a href="#" onclick="showRegister()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a></div>
                </div>
                
                <!-- –ê–î–ú–ò–ù -->
                <div id="admin-login-panel" class="hidden">
                    <div class="mb-3"><input type="text" class="form-control form-control-lg rounded-pill" id="admin-login" placeholder="–õ–æ–≥–∏–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"></div>
                    <div class="mb-4"><input type="password" class="form-control form-control-lg rounded-pill" id="admin-password" placeholder="–ü–∞—Ä–æ–ª—å"></div>
                    <button class="btn btn-primary mobile-btn" style="background: #8e44ad;" onclick="loginAdmin()"><i class="bi bi-shield-lock"></i> –í–æ–π—Ç–∏</button>
                    <div class="text-center mt-3"><a href="#" onclick="showAdminSecret()">–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</a></div>
                </div>
                
                <!-- –ö–£–†–ê–¢–û–† -->
                <div id="curator-login-panel" class="hidden">
                    <div class="mb-3"><input type="text" class="form-control form-control-lg rounded-pill" id="curator-login" placeholder="–õ–æ–≥–∏–Ω –∫—É—Ä–∞—Ç–æ—Ä–∞"></div>
                    <div class="mb-4"><input type="password" class="form-control form-control-lg rounded-pill" id="curator-password" placeholder="–ü–∞—Ä–æ–ª—å"></div>
                    <button class="btn btn-primary mobile-btn" style="background: #2980b9;" onclick="loginCurator()"><i class="bi bi-eye"></i> –í–æ–π—Ç–∏</button>
                </div>
            </div>
            
            <div class="mobile-card bg-light">
                <div class="row text-center">
                    <div class="col-6">
                        <i class="bi bi-building fs-2" style="color: #0f5e7e;"></i>
                        <h6>–ì–æ—Ä–æ–¥</h6>
                        <span class="badge bg-white text-dark p-2" id="rate-display">1400 ‚ÇΩ/—á</span>
                    </div>
                    <div class="col-6">
                        <i class="bi bi-tree fs-2" style="color: #b86d0e;"></i>
                        <h6>–ú–µ–∂–≥–æ—Ä–æ–¥</h6>
                        <span class="badge bg-white text-dark p-2">–°—Ç–∞–≤–∫–∞ –≤–æ–¥–∏—Ç–µ–ª—è</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –°–ï–ö–†–ï–¢–ù–´–ô –í–•–û–î -->
        <div id="admin-secret-screen" class="hidden">
            <div class="app-header">
                <button class="btn btn-sm btn-light position-absolute" style="left: 15px; top: 15px; border-radius: 50px;" onclick="backToLogin()"><i class="bi bi-arrow-left"></i></button>
                <h4 class="text-center">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ</h4>
            </div>
            <div class="mobile-card mt-4">
                <div class="text-center mb-4"><i class="bi bi-shield-shaded" style="font-size: 64px; color: #8e44ad;"></i><h5 class="mt-3">–°–µ–∫—Ä–µ—Ç–Ω—ã–π –≤—Ö–æ–¥</h5></div>
                <div class="mb-3"><input type="password" class="form-control form-control-lg rounded-pill" id="admin-secret-key" placeholder="–°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á"></div>
                <div class="mb-3"><input type="password" class="form-control form-control-lg rounded-pill" id="admin-new-password-secret" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å"></div>
                <button class="btn btn-warning mobile-btn" onclick="resetAdminWithSecret()"><i class="bi bi-check-circle"></i> –í–æ–π—Ç–∏ –∏ —Å–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
            </div>
        </div>
        
        <!-- –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø -->
        <div id="register-screen" class="hidden">
            <div class="app-header">
                <button class="btn btn-sm btn-light position-absolute" style="left: 15px; top: 15px; border-radius: 50px;" onclick="backToLogin()"><i class="bi bi-arrow-left"></i></button>
                <h4 class="text-center">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h4>
            </div>
            <div class="mobile-card mt-4">
                <div class="mb-3"><input type="text" class="form-control form-control-lg rounded-pill" id="reg-name" placeholder="–§–ò–û –ø–æ–ª–Ω–æ—Å—Ç—å—é"></div>
                <div class="mb-3"><input type="text" class="form-control form-control-lg rounded-pill" id="reg-phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω (–ª–æ–≥–∏–Ω)"></div>
                <div class="mb-4"><input type="password" class="form-control form-control-lg rounded-pill" id="reg-pass" placeholder="–ü–∞—Ä–æ–ª—å"></div>
                <button class="btn btn-success mobile-btn" onclick="registerDriver()"><i class="bi bi-check-circle"></i> –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            </div>
        </div>
        
        <!-- –ö–ê–ë–ò–ù–ï–¢ –í–û–î–ò–¢–ï–õ–Ø -->
        <div id="driver-cabinet" class="hidden">
            <div class="app-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0"><i class="bi bi-truck"></i> –®–ò–ù–¢–û–†–ì</h4>
                <span class="badge bg-white text-dark p-3 rounded-pill" id="driver-name-badge"></span>
            </div>
            
            <div class="mobile-card bg-white">
                <div class="row">
                    <div class="col-6"><small class="text-secondary">–°–µ–≥–æ–¥–Ω—è</small><h3 class="text-success fw-bold" id="driver-today-earn">0 ‚ÇΩ</h3><small id="driver-today-hours">0 —á</small></div>
                    <div class="col-6"><small class="text-secondary">–ó–∞ –º–µ—Å—è—Ü</small><h3 class="text-primary fw-bold" id="driver-month-earn">0 ‚ÇΩ</h3><small id="driver-total-earn">–≤—Å–µ–≥–æ: 0 ‚ÇΩ</small></div>
                </div>
            </div>
            
            <div id="driver-messages-container"></div>
            
            <div class="d-flex gap-2 mx-3 my-3">
                <button class="btn btn-primary flex-fill rounded-pill" onclick="switchDriverMode('city')"><i class="bi bi-building"></i> –ì–æ—Ä–æ–¥</button>
                <button class="btn btn-outline-primary flex-fill rounded-pill" onclick="switchDriverMode('inter')"><i class="bi bi-route"></i> –ú–µ–∂–≥–æ—Ä–æ–¥</button>
            </div>
            
            <!-- –ì–û–†–û–î -->
            <div id="driver-city-panel">
                <div class="mobile-card">
                    <div class="timer-big mb-3" id="timer-display">00:00:00</div>
                    <button class="btn btn-success mobile-btn mb-2" id="shift-start-btn" onclick="startShift()"><i class="bi bi-play-fill"></i> –ù–∞—á–∞—Ç—å —Å–º–µ–Ω—É</button>
                    <button class="btn btn-warning mobile-btn mb-2 hidden" id="shift-end-btn" onclick="endShift()"><i class="bi bi-stop-fill"></i> –ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–º–µ–Ω—É</button>
                    <div class="mt-3"><textarea class="form-control rounded-4" id="shift-comment" rows="2" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."></textarea></div>
                    <div class="mt-3 p-3 rounded-4 text-center" id="geo-status-block"><span class="geo-inactive"><i class="bi bi-satellite"></i> –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞</span></div>
                </div>
            </div>
            
            <!-- –ú–ï–ñ–ì–û–†–û–î -->
            <div id="driver-inter-panel" class="hidden">
                <div class="mobile-card">
                    <div class="mb-3"><input type="text" class="form-control form-control-lg rounded-pill" id="inter-direction" placeholder="–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ"></div>
                    <div class="mb-3"><input type="number" class="form-control form-control-lg rounded-pill" id="inter-sum" placeholder="–°—É–º–º–∞ —Å—Ç–∞–≤–∫–∏"></div>
                    <div class="mb-3"><textarea class="form-control rounded-4" id="inter-comment" rows="2" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."></textarea></div>
                    <button class="btn btn-warning mobile-btn" onclick="addIntercityTrip()"><i class="bi bi-truck"></i> –ü–æ–µ—Ö–∞–ª!</button>
                </div>
            </div>
            
            <!-- –ò–°–¢–û–†–ò–Ø -->
            <div class="mobile-card">
                <h5 class="mb-3">–ú–æ–∏ –ø–æ–µ–∑–¥–∫–∏</h5>
                <div style="max-height: 350px; overflow-y: auto;">
                    <table class="table table-sm">
                        <thead><tr><th>–î–∞—Ç–∞</th><th>–¢–∏–ø</th><th>–°—É–º–º–∞</th><th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th></tr></thead>
                        <tbody id="driver-trips-table"></tbody>
                    </table>
                </div>
            </div>
            
            <div class="text-center mb-4">
                <button class="btn btn-outline-secondary rounded-pill px-5" onclick="logout()"><i class="bi bi-box-arrow-right"></i> –í—ã–π—Ç–∏</button>
            </div>
        </div>
        
        <!-- –ö–ê–†–¢–ê -->
        <div id="map-modal" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); z-index: 2000;">
            <div style="padding: 16px; background: #0f5e7e; color: white; display: flex; justify-content: space-between;">
                <h5 class="mb-0" id="map-driver-name"></h5>
                <button class="btn btn-sm btn-light rounded-pill px-4" onclick="closeMap()"><i class="bi bi-x-lg"></i> –ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
            <div id="driver-map" style="height: 90vh; width: 100%;"></div>
        </div>
    </div>

    <script>
        // üî• FIREBASE –ö–õ–Æ–ß–ò
        const firebaseConfig = {
            apiKey: "AIzaSyASdFFIJbPOvGCs0IP66pojpFfCO1FU81A",
            authDomain: "shintorg86-crm.firebaseapp.com",
            projectId: "shintorg86-crm",
            storageBucket: "shintorg86-crm.firebasestorage.app",
            messagingSenderId: "501323511960",
            appId: "1:501323511960:web:0cb6d55502d82aaf58f8ed"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // ============ –ì–õ–û–ë–ê–õ–¨–ù–´–ï –î–ê–ù–ù–´–ï ============
        let drivers = [];
        let trips = [];
        let messages = [];
        let archives = [];
        
        // –£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        let ADMIN_CRED = { login: 'admin', password: 'adminshintorg86' };
        let CURATOR_CRED = { login: 'curator', password: 'curator123' };
        const SECRET_ADMIN_KEY = 'shintorg2024super';
        
        // –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        let currentUser = null;
        let currentRole = null;
        let currentRate = 1400;
        
        // –°–º–µ–Ω–∞
        let shiftActive = false;
        let shiftStartTime = null;
        let shiftTimer = null;
        let geoWatchId = null;
        let currentMap = null;
        let mapMarker = null;
        
        // –ü–æ–¥–ø–∏—Å–∫–∏ Firebase
        let unsubscribeDrivers = null;
        let unsubscribeTrips = null;
        let unsubscribeMessages = null;
        let unsubscribeArchive = null;
        
        // ============ –ó–ê–ì–†–£–ó–ö–ê ============
        window.onload = async function() {
            await loadFromFirebase();
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('rate-display').innerHTML = `${currentRate} ‚ÇΩ/—á`;
        };
        
        async function loadFromFirebase() {
            try {
                const d = await db.collection('drivers').get();
                drivers = d.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                const t = await db.collection('trips').orderBy('date', 'desc').get();
                trips = t.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                const m = await db.collection('messages').get();
                messages = m.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                const a = await db.collection('archive').get();
                archives = a.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (e) { console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', e); }
        }
        
        // ============ –§–£–ù–ö–¶–ò–ò –î–ê–¢–´ ============
        function formatDate(dateString) {
            if (!dateString) return '';
            const parts = dateString.split('-');
            if (parts.length === 3) return `${parts[2]}.${parts[1]}.${parts[0].slice(2)}`;
            return dateString;
        }
        
        // ============ –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –í–ö–õ–ê–î–û–ö –í–•–û–î–ê ============
        window.switchLoginTab = function(tab) {
            document.querySelectorAll('#login-tabs .mobile-tab').forEach(el => el.classList.remove('active'));
            if (tab === 'driver') {
                document.querySelector('#login-tabs .mobile-tab:nth-child(1)').classList.add('active');
                document.getElementById('driver-login-panel').classList.remove('hidden');
                document.getElementById('admin-login-panel').classList.add('hidden');
                document.getElementById('curator-login-panel').classList.add('hidden');
            } else if (tab === 'admin') {
                document.querySelector('#login-tabs .mobile-tab:nth-child(2)').classList.add('active');
                document.getElementById('driver-login-panel').classList.add('hidden');
                document.getElementById('admin-login-panel').classList.remove('hidden');
                document.getElementById('curator-login-panel').classList.add('hidden');
            } else if (tab === 'curator') {
                document.querySelector('#login-tabs .mobile-tab:nth-child(3)').classList.add('active');
                document.getElementById('driver-login-panel').classList.add('hidden');
                document.getElementById('admin-login-panel').classList.add('hidden');
                document.getElementById('curator-login-panel').classList.remove('hidden');
            }
        };
        
        // ============ –í–•–û–î ============
        window.loginDriver = async function() {
            const phone = document.getElementById('driver-login').value;
            const pass = document.getElementById('driver-password').value;
            
            const driver = drivers.find(d => d.phone === phone && d.password === pass);
            if (!driver) { alert('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å'); return; }
            
            currentUser = driver;
            currentRole = 'driver';
            
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('driver-cabinet').classList.remove('hidden');
            document.getElementById('driver-name-badge').innerHTML = `<i class="bi bi-person-circle"></i> ${driver.short || driver.name}`;
            
            if (driver.status === 'active' && driver.shiftType === 'city') {
                shiftActive = true;
                shiftStartTime = driver.shiftStartTime ? new Date(driver.shiftStartTime) : new Date();
                document.getElementById('shift-start-btn').classList.add('hidden');
                document.getElementById('shift-end-btn').classList.remove('hidden');
                startShiftTimer();
                startGeolocation();
            }
            
            loadDriverData();
            checkDriverMessages();
        };
        
        window.loginAdmin = function() {
            const login = document.getElementById('admin-login').value;
            const pass = document.getElementById('admin-password').value;
            if (login === ADMIN_CRED.login && pass === ADMIN_CRED.password) {
                currentRole = 'admin';
                alert('‚úÖ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä');
                // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –∫–æ–¥ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
            } else { alert('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å'); }
        };
        
        window.loginCurator = function() {
            const login = document.getElementById('curator-login').value;
            const pass = document.getElementById('curator-password').value;
            if (login === CURATOR_CRED.login && pass === CURATOR_CRED.password) {
                currentRole = 'curator';
                alert('‚úÖ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –ö—É—Ä–∞—Ç–æ—Ä');
                // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –∫–æ–¥ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø–∞–Ω–µ–ª–∏ –∫—É—Ä–∞—Ç–æ—Ä–∞
            } else { alert('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å'); }
        };
        
        window.showRegister = function() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('register-screen').classList.remove('hidden');
        };
        
        window.backToLogin = function() {
            document.getElementById('register-screen').classList.add('hidden');
            document.getElementById('admin-secret-screen').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
        };
        
        window.showAdminSecret = function() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('admin-secret-screen').classList.remove('hidden');
        };
        
        window.resetAdminWithSecret = function() {
            const key = document.getElementById('admin-secret-key').value;
            const newPass = document.getElementById('admin-new-password-secret').value;
            if (key !== SECRET_ADMIN_KEY) { alert('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∫–ª—é—á'); return; }
            if (newPass) { ADMIN_CRED.password = newPass; alert('‚úÖ –ü–∞—Ä–æ–ª—å –∏–∑–º–µ–Ω–µ–Ω'); }
            backToLogin();
        };
        
        window.registerDriver = async function() {
            const name = document.getElementById('reg-name').value;
            const phone = document.getElementById('reg-phone').value;
            const pass = document.getElementById('reg-pass').value;
            
            if (!name || !phone || !pass) { alert('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è'); return; }
            if (drivers.find(d => d.phone === phone)) { alert('‚ùå –¢–µ–ª–µ—Ñ–æ–Ω —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω'); return; }
            
            const nameParts = name.split(' ');
            let short = nameParts[0];
            if (nameParts.length > 1) short += ' ' + nameParts[1][0] + '.';
            if (nameParts.length > 2) short += nameParts[2][0] + '.';
            
            const newDriver = {
                name, short, phone, password: pass,
                status: 'offline', shiftType: null, shiftStartTime: null,
                location: '', lat: null, lng: null, lastSeen: null,
                registeredAt: new Date().toISOString().split('T')[0]
            };
            
            await db.collection('drivers').add(newDriver);
            drivers.push(newDriver);
            alert('‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!');
            backToLogin();
        };
        
        // ============ –ì–ï–û–õ–û–ö–ê–¶–ò–Ø ============
        function startGeolocation() {
            if (!currentUser || !currentUser.id || !navigator.geolocation) return;
            if (geoWatchId) navigator.geolocation.clearWatch(geoWatchId);
            
            geoWatchId = navigator.geolocation.watchPosition(
                async (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    await db.collection('drivers').doc(currentUser.id).update({ 
                        lat, lng, 
                        location: `${lat.toFixed(6)}, ${lng.toFixed(6)}`, 
                        lastSeen: new Date().toISOString() 
                    });
                    
                    document.getElementById('geo-status-block').innerHTML = `<span class="geo-active"><i class="bi bi-satellite"></i> üü¢ ${lat.toFixed(4)}, ${lng.toFixed(4)}</span>`;
                },
                (error) => {
                    document.getElementById('geo-status-block').innerHTML = `<span class="geo-inactive"><i class="bi bi-satellite"></i> üî¥ –û—à–∏–±–∫–∞</span>`;
                },
                { enableHighAccuracy: true, maximumAge: 5000, timeout: 10000 }
            );
        }
        
        // ============ –ö–ê–†–¢–ê ============
        window.showDriverMap = async function(driverId, driverName) {
            try {
                const doc = await db.collection('drivers').doc(driverId).get();
                const driver = doc.data();
                if (!driver || !driver.lat || !driver.lng) { alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏'); return; }
                
                document.getElementById('map-modal').classList.remove('hidden');
                document.getElementById('map-driver-name').innerHTML = `<i class="bi bi-geo-alt-fill"></i> ${driverName}`;
                
                setTimeout(() => {
                    if (currentMap) currentMap.remove();
                    currentMap = L.map('driver-map').setView([driver.lat, driver.lng], 15);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(currentMap);
                    if (mapMarker) mapMarker.remove();
                    mapMarker = L.marker([driver.lat, driver.lng]).addTo(currentMap).bindPopup(`<b>${driver.short || driver.name}</b>`).openPopup();
                }, 100);
            } catch (error) { alert('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã'); }
        };
        
        window.closeMap = function() { 
            document.getElementById('map-modal').classList.add('hidden'); 
            if (currentMap) { currentMap.remove(); currentMap = null; } 
        };
        
        // ============ –°–ú–ï–ù–ê ============
        window.startShift = async function() {
            if (!currentUser || !currentUser.id) { alert('–û—à–∏–±–∫–∞'); return; }
            
            shiftActive = true;
            shiftStartTime = new Date();
            
            await db.collection('drivers').doc(currentUser.id).update({ 
                status: 'active', 
                shiftType: 'city', 
                shiftStartTime: shiftStartTime.toISOString() 
            });
            
            currentUser.status = 'active';
            currentUser.shiftType = 'city';
            currentUser.shiftStartTime = shiftStartTime.toISOString();
            
            document.getElementById('shift-start-btn').classList.add('hidden');
            document.getElementById('shift-end-btn').classList.remove('hidden');
            
            startShiftTimer();
            startGeolocation();
            alert('üöï –°–º–µ–Ω–∞ –Ω–∞—á–∞—Ç–∞!');
        };
        
        window.endShift = async function() {
            if (!shiftActive || !currentUser || !currentUser.id) { alert('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π —Å–º–µ–Ω—ã'); return; }
            
            const seconds = Math.floor((new Date() - shiftStartTime) / 1000);
            let hours = seconds / 3600;
            let whole = Math.floor(hours);
            let mins = (hours - whole) * 60;
            
            if (mins < 15) hours = whole;
            else if (mins < 45) hours = whole + 0.5;
            else hours = whole + 1;
            if (hours < 1) hours = 1;
            
            const earn = Math.round(hours * currentRate);
            const comment = document.getElementById('shift-comment').value || '';
            
            const newTrip = {
                driverId: currentUser.phone,
                driverName: currentUser.short || currentUser.name,
                date: new Date().toISOString().split('T')[0],
                type: '–≥–æ—Ä–æ–¥',
                hours: hours,
                earn: earn,
                comment: comment,
                startTime: shiftStartTime.toISOString(),
                endTime: new Date().toISOString(),
                timestamp: new Date().toISOString()
            };
            
            await db.collection('trips').add(newTrip);
            trips.push(newTrip);
            
            await db.collection('drivers').doc(currentUser.id).update({ 
                status: 'offline', 
                shiftType: null, 
                shiftStartTime: null 
            });
            
            currentUser.status = 'offline';
            currentUser.shiftType = null;
            
            if (geoWatchId) { navigator.geolocation.clearWatch(geoWatchId); geoWatchId = null; }
            shiftActive = false;
            clearInterval(shiftTimer);
            
            document.getElementById('timer-display').innerText = '00:00:00';
            document.getElementById('shift-start-btn').classList.remove('hidden');
            document.getElementById('shift-end-btn').classList.add('hidden');
            document.getElementById('shift-comment').value = '';
            document.getElementById('geo-status-block').innerHTML = '<span class="geo-inactive"><i class="bi bi-satellite"></i> –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞</span>';
            
            loadDriverData();
            alert(`‚úÖ –°–º–µ–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ: ${earn} ‚ÇΩ`);
        };
        
        window.addIntercityTrip = async function() {
            if (!currentUser || !currentUser.id) { alert('–û—à–∏–±–∫–∞'); return; }
            
            const direction = document.getElementById('inter-direction').value || '–ú–µ–∂–≥–æ—Ä–æ–¥';
            const sum = parseFloat(document.getElementById('inter-sum').value);
            if (!sum || sum <= 0) { alert('‚ùå –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É'); return; }
            const comment = document.getElementById('inter-comment').value || '';
            
            const newTrip = {
                driverId: currentUser.phone,
                driverName: currentUser.short || currentUser.name,
                date: new Date().toISOString().split('T')[0],
                type: '–º–µ–∂–≥–æ—Ä–æ–¥',
                direction: direction,
                earn: sum,
                comment: comment,
                timestamp: new Date().toISOString()
            };
            
            await db.collection('trips').add(newTrip);
            trips.push(newTrip);
            
            document.getElementById('inter-direction').value = '';
            document.getElementById('inter-sum').value = '';
            document.getElementById('inter-comment').value = '';
            
            loadDriverData();
            alert(`üöõ –†–µ–π—Å –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω! ${sum} ‚ÇΩ`);
        };
        
        function startShiftTimer() {
            if (shiftTimer) clearInterval(shiftTimer);
            shiftTimer = setInterval(() => {
                if (!shiftActive) return;
                const diff = Math.floor((new Date() - shiftStartTime) / 1000);
                const h = Math.floor(diff / 3600).toString().padStart(2, '0');
                const m = Math.floor((diff % 3600) / 60).toString().padStart(2, '0');
                const s = (diff % 60).toString().padStart(2, '0');
                document.getElementById('timer-display').innerText = `${h}:${m}:${s}`;
            }, 1000);
        }
        
        function loadDriverData() {
            if (!currentUser) return;
            
            const driverTrips = trips.filter(t => t.driverId === currentUser.phone);
            const today = new Date().toISOString().split('T')[0];
            const month = today.slice(0, 7);
            
            const todayEarn = driverTrips.filter(t => t.date === today).reduce((s, t) => s + (t.earn || 0), 0);
            const monthEarn = driverTrips.filter(t => t.date.startsWith(month)).reduce((s, t) => s + (t.earn || 0), 0);
            const totalEarn = driverTrips.reduce((s, t) => s + (t.earn || 0), 0);
            
            document.getElementById('driver-today-earn').innerHTML = `${todayEarn} ‚ÇΩ`;
            document.getElementById('driver-month-earn').innerHTML = `${monthEarn} ‚ÇΩ`;
            document.getElementById('driver-total-earn').innerHTML = `–≤—Å–µ–≥–æ: ${totalEarn} ‚ÇΩ`;
            
            let html = '';
            driverTrips.slice().reverse().forEach(trip => {
                const dateStr = formatDate(trip.date);
                html += `<tr><td>${dateStr}</td><td><span class="badge ${trip.type === '–≥–æ—Ä–æ–¥' ? 'bg-primary' : 'bg-warning'}">${trip.type}</span></td><td>${trip.earn} ‚ÇΩ</td><td><small>${trip.comment || ''}</small></td></tr>`;
            });
            document.getElementById('driver-trips-table').innerHTML = html || '<tr><td colspan="4" class="text-center">–ù–µ—Ç –ø–æ–µ–∑–¥–æ–∫</td></tr>';
        }
        
        // ============ –°–û–û–ë–©–ï–ù–ò–Ø ============
        function checkDriverMessages() {
            const msgs = messages.filter(m => m.driverPhone === currentUser?.phone && !m.read);
            if (msgs.length) {
                let html = '';
                msgs.forEach(msg => {
                    html += `<div class="message-bubble">üì® –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∞–¥–º–∏–Ω–∞: ${msg.text}</div>`;
                });
                document.getElementById('driver-messages-container').innerHTML = html;
            }
        }
        
        window.switchDriverMode = function(mode) {
            document.getElementById('driver-city-panel').classList.toggle('hidden', mode !== 'city');
            document.getElementById('driver-inter-panel').classList.toggle('hidden', mode !== 'inter');
        };
        
        window.logout = function() {
            if (geoWatchId) navigator.geolocation.clearWatch(geoWatchId);
            if (shiftTimer) clearInterval(shiftTimer);
            
            currentUser = null;
            currentRole = null;
            shiftActive = false;
            
            document.getElementById('driver-cabinet').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('timer-display').innerText = '00:00:00';
        };
    </script>
</body>
</html>
